<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0">
    <channel>
        <title>Manuel on Software - Reloaded</title>
        <link>http://mvaled.github.io/blog/html/</link>
        <description></description>
        <language>en-us</language>
        <pubDate>Fri, 22 Jun 2018 00:00:00 -0400</pubDate>
        
        <item>
            <link>http://mvaled.github.io/blog/html/2018/06/22/a-failing-fail-in-the-monad-list.html</link>
            <guid>http://mvaled.github.io/blog/html/2018/06/22/a-failing-fail-in-the-monad-list.html</guid>
            <title><![CDATA[A failing fail in the monad list]]></title>
            <description><![CDATA[<h1>A failing fail in the monad list</h1>
<p>I’m following the Real World Haskell book.  In the chapter about Monads, they
create simple example using the list monad compute all pairs of numbers <span class="docutils literal"><span class="pre">(x,</span>
<span class="pre">y)</span></span> that such that <span class="docutils literal"><span class="pre">x</span> <span class="pre">*</span> <span class="pre">y</span> <span class="pre">==</span> <span class="pre">n</span></span> for a given <span class="docutils literal"><span class="pre">n</span></span>.</p>
<p>Their solution is:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span/><span class="nf">multiplyTo</span> <span class="ow">::</span> <span class="kt">Int</span> <span class="ow">-&gt;</span> <span class="p">[(</span><span class="kt">Int</span><span class="p">,</span> <span class="kt">Int</span><span class="p">)]</span>
<span class="nf">multiplyTo</span> <span class="n">n</span> <span class="ow">=</span> <span class="kr">do</span>
      <span class="n">x</span> <span class="ow">&lt;-</span> <span class="p">[</span><span class="mi">1</span><span class="o">..</span><span class="n">n</span><span class="p">]</span>
      <span class="n">y</span> <span class="ow">&lt;-</span> <span class="p">[</span><span class="n">x</span><span class="o">..</span><span class="n">n</span><span class="p">]</span>
      <span class="n">guarded</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">y</span> <span class="o">==</span> <span class="n">n</span><span class="p">)</span> <span class="o">$</span>
        <span class="n">return</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="nf">guarded</span> <span class="ow">::</span> <span class="kt">Bool</span> <span class="ow">-&gt;</span> <span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="ow">-&gt;</span> <span class="p">[</span><span class="n">a</span><span class="p">]</span>
<span class="nf">guarded</span> <span class="kt">True</span> <span class="n">xs</span> <span class="ow">=</span> <span class="n">xs</span>
<span class="nf">guarded</span> <span class="kt">False</span> <span class="kr">_</span> <span class="ow">=</span> <span class="kt">[]</span>
</pre></div>
</div>
<p>But I was wondering if I could restate <span class="docutils literal"><span class="pre">guarded</span></span> for any monad.  Since
<span class="docutils literal"><span class="pre">fail</span></span> in the list monad is <span class="docutils literal"><span class="pre">fail</span> <span class="pre">_</span> <span class="pre">=</span> <span class="pre">[]</span></span>, I though I could do:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span/><span class="nf">guarded</span> <span class="ow">::</span> <span class="kt">Monad</span> <span class="n">m</span> <span class="ow">=&gt;</span> <span class="kt">Bool</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="n">a</span>
<span class="nf">guarded</span> <span class="kt">True</span> <span class="ow">=</span> <span class="n">id</span>
<span class="nf">guarded</span> <span class="kt">False</span> <span class="ow">=</span> <span class="n">fail</span> <span class="s">"skipped"</span>
</pre></div>
</div>
<p>However this actually fails in ghci:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/><span class="o">*</span><span class="n">Main</span><span class="o">&gt;</span> <span class="n">multiplyTo</span> <span class="mi">24</span>
<span class="o">***</span> <span class="ne">Exception</span><span class="p">:</span> <span class="n">skipped</span>
</pre></div>
</div>
<p>I let myself sleep, and this morning I figured there’s actually a
small/important difference between <span class="docutils literal"><span class="pre">guarded</span> <span class="pre">False</span> <span class="pre">_</span> <span class="pre">=</span> <span class="pre">[]</span></span> and <span class="docutils literal"><span class="pre">guarded</span>
<span class="pre">False</span> <span class="pre">=</span> <span class="pre">fail</span> <span class="pre">"..."</span></span></p>
<p>The type of <span class="docutils literal"><span class="pre">guarded</span> <span class="pre">False</span></span> is <span class="docutils literal"><span class="pre">Monad</span> <span class="pre">m</span> <span class="pre">=&gt;</span> <span class="pre">m</span> <span class="pre">a</span> <span class="pre">-&gt;</span> <span class="pre">m</span> <span class="pre">a</span></span>.  However the type
of <span class="docutils literal"><span class="pre">fail</span> <span class="pre">'skipped'</span></span> is just <span class="docutils literal"><span class="pre">Monad</span> <span class="pre">m</span> <span class="pre">=&gt;</span> <span class="pre">m</span> <span class="pre">a</span></span>.</p>
<p>Why does <span class="docutils literal"><span class="pre">guarded</span> <span class="pre">False</span> <span class="pre">=</span> <span class="pre">fail</span> <span class="pre">"skipped"</span></span> type-checks?  That’s an <a class="reference external" href="stackoverflow-50989541">open
question</a> (as of the time of writing).</p>
<p>If I define <span class="docutils literal"><span class="pre">guarded</span></span> as:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span/><span class="nf">guarded</span> <span class="ow">::</span> <span class="kt">Monad</span> <span class="n">m</span> <span class="ow">=&gt;</span> <span class="kt">Bool</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="n">a</span>
<span class="nf">guarded</span> <span class="kt">True</span> <span class="n">xs</span> <span class="ow">=</span> <span class="n">xs</span>
<span class="nf">guarded</span> <span class="kt">False</span> <span class="kr">_</span> <span class="ow">=</span> <span class="n">fail</span> <span class="s">"skipped"</span>
</pre></div>
</div>
<p>Or:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span/><span class="nf">guarded</span> <span class="ow">::</span> <span class="kt">Monad</span> <span class="n">m</span> <span class="ow">=&gt;</span> <span class="kt">Bool</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="n">a</span>
<span class="nf">guarded</span> <span class="kt">True</span> <span class="ow">=</span> <span class="n">id</span>
<span class="nf">guarded</span> <span class="kt">False</span> <span class="ow">=</span> <span class="nf">\</span><span class="n">s</span> <span class="ow">-&gt;</span> <span class="n">fail</span> <span class="s">"skipped"</span>
</pre></div>
</div>
<p>Both work correctly.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last"><cite>fail</cite> is strongly discouraged to use in real world haskell code.</p>
</div>
]]></description>
            <category><![CDATA[ Programming ]]></category>
             <pubDate>Fri, 22 Jun 2018 00:00:00 -0400</pubDate>
        </item>
    
        <item>
            <link>http://mvaled.github.io/blog/html/2018/01/22/foldl-in-terms-of-foldr.html</link>
            <guid>http://mvaled.github.io/blog/html/2018/01/22/foldl-in-terms-of-foldr.html</guid>
            <title><![CDATA[Dissecting foldl in terms of foldr]]></title>
            <description><![CDATA[<h1>Dissecting <cite>foldl</cite> in terms of <cite>foldr</cite></h1>
<p>The book ‘Real World Haskell’ provides an implementation of <span class="docutils literal"><span class="pre">foldl</span></span> in terms
of <span class="docutils literal"><span class="pre">foldr</span></span>:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span/><span class="nf">myFoldl</span><span class="ow">::</span> <span class="p">(</span><span class="n">b</span> <span class="ow">-&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">b</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">b</span> <span class="ow">-&gt;</span> <span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="ow">-&gt;</span> <span class="n">b</span>
<span class="nf">myFoldl</span> <span class="n">f</span> <span class="n">z</span> <span class="n">xs</span> <span class="ow">=</span> <span class="n">foldr</span> <span class="n">step</span> <span class="n">id</span> <span class="n">xs</span> <span class="n">z</span>
   <span class="kr">where</span> <span class="n">step</span> <span class="n">x</span> <span class="n">g</span> <span class="n">a</span> <span class="ow">=</span> <span class="n">g</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p>They ask the reader (me) to try to understand the implementation.  They warn
it’s not trivial, but I found it interesting.  So, I just want to share my
line of thought.</p>
<p>The first thing I noticed is that <span class="docutils literal"><span class="pre">z</span></span> is not an argument to <span class="docutils literal"><span class="pre">foldr</span></span>; you
can rewrite the first line as:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span/><span class="p">(</span><span class="n">foldr</span> <span class="n">step</span> <span class="n">id</span> <span class="n">xs</span><span class="p">)</span> <span class="n">z</span>
</pre></div>
</div>
<p>This makes visible that the result of the <span class="docutils literal"><span class="pre">foldr</span></span> is a function that takes
<cite>z</cite> as an argument.  By looking a the case <span class="docutils literal"><span class="pre">foldr</span> <span class="pre">step</span> <span class="pre">id</span> <span class="pre">[]</span></span>, which equates
to <span class="docutils literal"><span class="pre">id</span></span>, we can see that the type of the <span class="docutils literal"><span class="pre">foldr</span></span>’s result is <span class="docutils literal"><span class="pre">b</span> <span class="pre">-&gt;</span> <span class="pre">b</span></span>.</p>
<p>This also implies that the type of <span class="docutils literal"><span class="pre">step</span></span> must be <span class="docutils literal"><span class="pre">a</span> <span class="pre">-&gt;</span> <span class="pre">(b</span> <span class="pre">-&gt;</span> <span class="pre">b)</span> <span class="pre">-&gt;</span> <span class="pre">(b</span> <span class="pre">-&gt;</span>
<span class="pre">b)</span></span>.  You can prove that by extracting <span class="docutils literal"><span class="pre">step</span></span>:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span/><span class="nf">step1</span> <span class="ow">::</span> <span class="p">(</span><span class="n">b</span> <span class="ow">-&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">b</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="n">b</span> <span class="ow">-&gt;</span> <span class="n">b</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="n">b</span> <span class="ow">-&gt;</span> <span class="n">b</span><span class="p">)</span>
<span class="nf">step1</span> <span class="n">f</span> <span class="n">x</span> <span class="n">g</span> <span class="n">a</span> <span class="ow">=</span> <span class="n">g</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span> <span class="n">x</span><span class="p">)</span>

<span class="nf">myFoldl1</span> <span class="ow">::</span> <span class="p">(</span><span class="n">b</span> <span class="ow">-&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">b</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">b</span> <span class="ow">-&gt;</span> <span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="ow">-&gt;</span> <span class="n">b</span>
<span class="nf">myFoldl1</span> <span class="n">f</span> <span class="n">z</span> <span class="n">xs</span> <span class="ow">=</span> <span class="n">foldr</span> <span class="p">(</span><span class="n">step1</span> <span class="n">f</span><span class="p">)</span> <span class="n">id</span> <span class="n">xs</span> <span class="n">z</span>
</pre></div>
</div>
<p>Use <cite>ghci</cite> to verify that.</p>
<p>Now comes the <em>funny</em> part of the implementation: <span class="docutils literal"><span class="pre">step</span></span> is defined with
three arguments</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/><span class="n">where</span> <span class="n">step</span> <span class="n">x</span> <span class="n">g</span> <span class="n">a</span> <span class="o">=</span> <span class="n">g</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p>but <span class="docutils literal"><span class="pre">foldr</span></span> only passes the first two, and that’s totally fine; the result
will be another function.</p>
<p>You can make this explicit:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span/><span class="nf">myFoldl2</span> <span class="ow">::</span> <span class="p">(</span><span class="n">b</span> <span class="ow">-&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">b</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">b</span> <span class="ow">-&gt;</span> <span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="ow">-&gt;</span> <span class="n">b</span>
<span class="nf">myFoldl2</span> <span class="n">f</span> <span class="n">z</span> <span class="n">xs</span> <span class="ow">=</span> <span class="n">foldr</span> <span class="n">step</span> <span class="n">id</span> <span class="n">xs</span> <span class="n">z</span>
   <span class="kr">where</span> <span class="n">step</span> <span class="n">x</span> <span class="n">g</span> <span class="ow">=</span> <span class="nf">\</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">g</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p>That’s a beautiful thing about Haskell both definitions of <span class="docutils literal"><span class="pre">step</span></span> are
actually indistinguishable:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/><span class="n">step</span> <span class="n">x</span> <span class="n">g</span> <span class="n">a</span> <span class="o">=</span> <span class="n">g</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span> <span class="n">x</span><span class="p">)</span>

<span class="n">step</span> <span class="n">x</span> <span class="n">g</span> <span class="o">=</span> \<span class="n">a</span> <span class="o">-&gt;</span> <span class="n">g</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p>The first one takes an <em>equation-like</em> outlook that I find very elegant in a
programming language.</p>
<p>Having all that we can easily follow how the expression <span class="docutils literal"><span class="pre">myFoldl</span> <span class="pre">(+)</span> <span class="pre">0</span> <span class="pre">[1,</span>
<span class="pre">2]</span></span> would proceed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/>myFoldl (+) 0 [1, 2]
(foldr step id [1, 2]) 0                  -- by def. of myFoldl
(step 1 (foldr step id [2])) 0            -- by def. of foldr
(step 1 (step 2 (foldr step id []))) 0    -- by def. of foldr
(step 1 (step 2 id)) 0                    -- by def. of foldr for []
(step 1 (\a -&gt; id(a + 2))) 0              -- applying `step 2 id`

(step 1 (\a -&gt; a + 2)) 0                  -- applying id, Haskell might not
                                             do this right now

(\x -&gt; (\a -&gt; a + 2)(x + 1)) 0            -- applying step
(\x -&gt; (x + 1) + 2) 0                     -- applying the inner lambda
(0 + 1) + 2                               -- applying the outer lambda
</pre></div>
</div>
<p>And that’s (more or less) how <span class="docutils literal"><span class="pre">myFoldl</span></span> works.</p>
]]></description>
            <category><![CDATA[ Programming ]]></category>
             <pubDate>Mon, 22 Jan 2018 00:00:00 -0500</pubDate>
        </item>
    
        <item>
            <link>http://mvaled.github.io/blog/html/2015/09/12/odoo-bus-implementation.html</link>
            <guid>http://mvaled.github.io/blog/html/2015/09/12/odoo-bus-implementation.html</guid>
            <title><![CDATA[The bus implementation in Odoo and notification systems in the Web]]></title>
            <description><![CDATA[<h1>The bus <em>implementation</em> in Odoo and notification systems in the Web</h1>
<div class="sidebar">
<p class="first sidebar-title">Delayed post.</p>
<p>This post has been delayed for a very, very long time.  If I trust the logs
in my blog’s git repository the post is “finished” since Sat Sep 12, 2015.
Well, that’s not true, and I must really finish it now.</p>
<p>As it happens, in the meantime, I was not twiddling my fingers and I made
two “advances” about the bus implementation:</p>
<ul class="last simple">
<li>I made a successful implementation of a cross-tab bus implementation:
<a class="reference external" href="https://github.com/merchise-autrement/odoo/tree/merchise-8.0-bus-service-worker">https://github.com/merchise-autrement/odoo/tree/merchise-8.0-bus-service-worker</a></li>
<li>I discovered that Odoo 9’s code base already has the cross-tab feature
integrated.</li>
</ul>
</div>
<p>I commented on my <a class="reference internal" href="http://mvaled.github.io/blog/html/2015/05/26/odoo-at-last.html#odoo-at-last"><span class="std std-ref">post about our migration to Odoo</span></a> that
our users open many tabs to the same Odoo instance.  When the chat is active
this means an open connection for each tab and, since a chat is interactive in
nature, all but one of these connections are not actually required <a class="footnote-reference" href="#notify" id="id1">[1]</a>.</p>
<p>A while ago <a class="reference external" href="https://twitter.com/mvaled/status/615973409697050624">I reported</a> that switching from a
threaded based deployment to a pre-forked processes one with a <a class="reference external" href="https://pypi.python.org/pypi/gevent">gevent</a> based
process for long polling connections, actually spiked the concurrency issues
we were witnessing in our DB.  Our DB complained about being unable to
<em>serialize</em> concurrent transactions.  By inspecting the logs we noticed that
almost always this had to do with an update to the table <span class="docutils literal"><span class="pre">im_chat_presence</span></span>,
that holds the status of users in the chat.</p>
<p>I thought the forked model would diminish the chance of collisions because (I
thought) Odoo would use a single DB connection per worker process and another
one for the gevent worker that would simply serialize <em>all</em> the chat related
queries.</p>
<p>This spike was against all rationale I could think of, but honestly I didn’t
check my assumptions by reading the code.  They might just be the wrong
assumptions in the first place, and I needed to really read the code to see
what was really happening.</p>
<p>After restoring the threaded deployment the concurrency issues dropped again.
They didn’t get to the same levels they were before, but, at the same time, we
were introducing other modules (and the related staff), so there are more open
tabs…  Afterwards we went back to the process model, and the issues spiked
again, however in a smaller amount.</p>
<p>Several weeks later I deployed a <a class="reference external" href="https://github.com/merchise-autrement/odoo/commit/2abfd5ba28e959dda4d6a127a19b3d939008bc1d">patch</a> to the Odoo bus
implementation that simply reduced the frequency of polling when the <a class="reference external" href="http://www.w3.org/TR/page-visibility/">page is
hidden</a>.  The concurrency issues were now mostly gone:
from about 3k a day to no more than 50.</p>
<p>We still had unanswered questions regarding the DB connection management in
Odoo.  There were suspicious signs.  For instance reducing the <span class="docutils literal"><span class="pre">db_maxconn</span></span>
option to 8 or less made Odoo start complaining about the Connection Pool
being full very often.  We already knew that:</p>
<ul class="simple">
<li>For each cron worker at least 2 connections are used: one holds the cron job
locked while the other is used by the job itself.</li>
<li>The bus (used for the chat) also uses another connection to the DB
“postgres”: Notifications and wake-ups of bus-related events use this
connection.</li>
</ul>
<p>The most suspicious sign, however, was that with a pool size of 32, this issue
came from time to time.</p>
<p>Time went by and the issue remained at an acceptable (for us) level of few
dozens per day.  You may say it’s too much, but, bear with me, it’s reasonable
for our hardware and user base.</p>
<p>Just a few days ago, we realized that issues coming from our gevent-based
process were not being properly reported to our <a class="reference external" href="http://getsentry.com/">Sentry</a>.  We <a class="reference external" href="https://github.com/merchise-autrement/xoeuf/commit/d4b3bb7f0d972f31382aad8e6d1bf37c5a74ce99">fixed the issue</a> and observed that we’re getting about 2.5k DB collisions
per day reports again.  And once more the query the table where most of
collisions happen is ‘im_chat_presence’.</p>
<p>As a workaround we simply <a class="reference external" href="https://github.com/merchise-autrement/odoo/commit/555b5699b96178d5c87f36c0f692dbe8dcf0facb">reduced</a> the update rate for that table.  But a
better solutions needed to be found.</p>
<div class="section" id="cross-tab-polling">
<h2>Cross-tab polling</h2>
<p>By looking better our users’ usage pattern, we discovered that users switch
from tab to tab regularly and thus the polling is still high.  So we went down
the path of figuring out a way to have a single polling connection even when
many were opened.</p>
<p>I remembered the Local Storage API and went down to write a simple proof of
concept of listening events of the <span class="docutils literal"><span class="pre">localStorage</span></span> from different tabs.  The
proof of concept yielded good results, and so I turned to Google and search
for “cross-tab communication” and found the <a class="reference external" href="https://github.com/nodeca/tabex">tabex</a> library.</p>
<p>After that, replacing the implementation of the bus for a new one that was
based on a exchanged between tabs was not very hard.  These are the commits
done in our branch (in reverse topological order as in <span class="docutils literal"><span class="pre">git</span> <span class="pre">log</span></span>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/><span class="mi">0555434</span> <span class="o">*</span> <span class="n">bus</span><span class="p">:</span> <span class="n">Clarify</span> <span class="n">the</span> <span class="n">channel</span> <span class="n">delay</span> <span class="ow">in</span> <span class="n">polls</span><span class="o">.</span>
<span class="n">d10a1b5</span> <span class="o">*</span> <span class="n">bus</span><span class="p">:</span> <span class="n">Checks</span> <span class="k">for</span> <span class="n">the</span> <span class="n">right</span> <span class="n">state</span><span class="o">.</span>
<span class="n">af4a6dc</span> <span class="o">*</span> <span class="n">bus</span><span class="p">:</span> <span class="n">Add</span> <span class="n">language</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">documentation</span><span class="o">.</span>
<span class="mi">636490</span><span class="n">b</span> <span class="o">*</span> <span class="n">im_chat</span><span class="p">:</span> <span class="n">Revert</span> <span class="s2">"Reduce the presure on im_chat_presence table."</span>
<span class="n">eda7638</span> <span class="o">*</span> <span class="n">bus</span><span class="p">:</span> <span class="n">Don</span><span class="s1">'t notify if not in polling state.</span>
<span class="mi">4</span><span class="n">d09ac6</span> <span class="o">*</span> <span class="n">web_celery</span><span class="p">:</span> <span class="n">Use</span> <span class="n">a</span> <span class="n">dedicated</span> <span class="n">bus</span> <span class="n">exchange</span> <span class="k">for</span> <span class="n">jobs</span><span class="o">.</span>
<span class="mf">84239e3</span> <span class="o">*</span> <span class="n">im_chat</span><span class="p">:</span> <span class="n">Beep</span> <span class="n">only</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">master</span> <span class="n">tab</span><span class="o">.</span>
<span class="mi">2</span><span class="n">cb27da</span> <span class="o">*</span> <span class="n">Improve</span> <span class="n">the</span> <span class="n">bus</span> <span class="n">to</span> <span class="n">allow</span> <span class="n">tab</span> <span class="n">synchronization</span><span class="o">.</span>
</pre></div>
</div>
<p>The file <a class="reference external" href="https://github.com/merchise-autrement/odoo/blob/merchise-8.0-bus-service-worker/addons/bus/static/src/js/bus.rst"><span class="docutils literal"><span class="pre">addons/bus/static/src/js/bus.rst</span></span></a> contains the new design explained.</p>
<p>A few weeks ago I did the <a class="reference external" href="https://github.com/merchise-autrement/odoo/commit/4690d8d466fe622a1a2449403cc41ae78d4caafe">first merge</a> our 8.0 changes into the 9.0 branch.
On the process I realized that Odoo 9.0’s bus was improved and now contains
the a cross-tab communication feature.</p>
<p>So probably I end up backporting their implementation into 8.0.</p>
</div>
<div class="section" id="notes">
<h2>Notes</h2>
<table class="docutils footnote" frame="void" id="notify" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>Of course it allows the web app to change the window’s title when
then user has an unread message, but in our case this notification is also
unneeded, because the message is actually being read in another tab.</td></tr>
</tbody>
</table>
</div>
]]></description>
            <category><![CDATA[ Web Development ]]></category>
            <category><![CDATA[ Programming ]]></category>
             <pubDate>Sat, 12 Sep 2015 00:00:00 -0400</pubDate>
        </item>
    
        <item>
            <link>http://mvaled.github.io/blog/html/2015/08/04/repost-the-productivity-of-tomorrow-trumps-that-of-today.html</link>
            <guid>http://mvaled.github.io/blog/html/2015/08/04/repost-the-productivity-of-tomorrow-trumps-that-of-today.html</guid>
            <title><![CDATA[The productivity of tomorrow trumps that of today]]></title>
            <description><![CDATA[<h1>The productivity of tomorrow trumps that of today</h1>
<div class="sidebar">
<p class="first sidebar-title">Editorial note</p>
<p>I’m republishing this post from my old blog (which is no longer online).
It’s published as it were when I first made it online with only minor
changes.  But I think I stand by this still.</p>
<p class="last">Hope you’ll enjoy the reading.</p>
</div>
<p>That’s probably harsh, but I think it is absolutely right.  Doing crappy
software today to be more productive today will make you less productive
tomorrow.  It’s this simple.  And that’s cumulative too; meaning that if you
neglect your future productivity, it will be slowly diminishing until a point
of negative competitive disadvantage where you’ll find yourself struggling to
keep up instead of innovating.</p>
<p>And it’s so damn exhausting to explain why…</p>
<p>Software complexity does not come from the tools, but from the mental
framework required (and imposed at times) to understand it.  So don’t ever
think measuring Cyclomatic Complexity (CC) and other similar metrics will
yield something close to the <a class="reference external" href="http://www.osnews.com/story/19266/WTFs_m">true measure</a> of the
<a class="reference external" href="http://blog.codinghorror.com/whos-your-coding-buddy/">quality of your code</a>.</p>
<blockquote>
<div><p>There are only <a class="reference external" href="http://martinfowler.com/bliki/TwoHardThings.html">two hard things</a> in Computer Science: cache invalidation
and naming things.</p>
<p class="attribution">—Phil Karlton</p>
</div></blockquote>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/><span class="k">def</span> <span class="nf">_check</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
       <span class="k">return</span> <span class="n">l</span>
    <span class="n">l1</span><span class="p">,</span> <span class="n">l2</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
       <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;=</span><span class="n">m</span> <span class="p">:</span>
          <span class="n">l1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
       <span class="k">else</span><span class="p">:</span>
          <span class="n">l2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_check</span><span class="p">(</span><span class="n">l1</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">+</span><span class="n">_check</span><span class="p">(</span><span class="n">l2</span><span class="p">)</span>
</pre></div>
</div>
<p>This code has a nice CC of 4 which is very nice; yet it will take you at least
a minute to figure out what it does.  If only I had chosen to name the
function <cite>quicksort</cite>…</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/><span class="gp">&gt;&gt;&gt; </span><span class="n">_check</span><span class="p">([</span><span class="mi">84</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">89</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">77</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">16</span><span class="p">])</span>
<span class="go">[4, 16, 24, 70, 77, 84, 86, 89, 95, 95]</span>
</pre></div>
</div>
<p>A quiz in less than 5 seconds: What does it mean in OpenERP’s ORM the
following lines of code?</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/><span class="n">group</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">'implied_ids'</span><span class="p">:</span> <span class="p">[(</span><span class="mi">3</span><span class="p">,</span> <span class="n">implied_group</span><span class="o">.</span><span class="n">id</span><span class="p">)]})</span>
</pre></div>
</div>
<p>This line of code has a CC of 1: as good as it gets, isn’t it?  But it’s so
darn difficult to read that unless you have your brain wired up to see “forget
the link between this group and the implied_group”…  To be fair there is
someone out there in the OpenERP universe that cared a bit about this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/><span class="c1"># file addons/base/ir/ir_fields.py</span>

<span class="n">CREATE</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">values</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
<span class="n">UPDATE</span> <span class="o">=</span> <span class="k">lambda</span> <span class="nb">id</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
<span class="n">DELETE</span> <span class="o">=</span> <span class="k">lambda</span> <span class="nb">id</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">FORGET</span> <span class="o">=</span> <span class="k">lambda</span> <span class="nb">id</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">LINK_TO</span> <span class="o">=</span> <span class="k">lambda</span> <span class="nb">id</span><span class="p">:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">DELETE_ALL</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">REPLACE_WITH</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">ids</span><span class="p">:</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">ids</span><span class="p">)</span>
</pre></div>
</div>
<p>But no one else is using it!</p>
<p>And, yes, it’s exhausting going over this.</p>
]]></description>
            <category><![CDATA[ Programming ]]></category>
             <pubDate>Tue, 04 Aug 2015 00:00:00 -0400</pubDate>
        </item>
    
        <item>
            <link>http://mvaled.github.io/blog/html/2015/05/26/odoo-at-last.html</link>
            <guid>http://mvaled.github.io/blog/html/2015/05/26/odoo-at-last.html</guid>
            <title><![CDATA[Odoo at last!]]></title>
            <description><![CDATA[<span id="id1"/><h1>Odoo at last!</h1>
<div class="sidebar">
<p class="first sidebar-title">Updated 2015-06-03</p>
<p><a class="reference internal" href="http://mvaled.github.io/blog/html/2015/05/26/odoo-at-last.html#the-menu-decomposition">The menu decomposition</a> described below was actually an error in a custom
addon and not related with migration process.</p>
<p class="last">While still using OpenERP, we backported the partner merge feature from
Odoo and made it work in OpenERP.  We even added a fuzzy match feature so
that minor typos were not missed.  Now in Odoo it seems our modifications
messed things up.</p>
</div>
<p>After several months, we have finally moved from OpenERP to Odoo.  It took
several rounds of testing, finding bugs and incompatibilities in our own
modules and fixing them.</p>
<div class="section" id="a-summary-of-the-process">
<h2>A summary of the process</h2>
<p>The <a class="reference external" href="https://github.com/OpenUpgrade/OpenUpgrade">OpenUpgrade</a> project proved to be very complete for us –it had almost
everything we needed:</p>
<ul class="simple">
<li>The Accounting and Project modules were done.</li>
<li>The CRM module was not yet integrated into the mainstream repository but a
<a class="reference external" href="https://github.com/StefanRijnhart/OpenUpgrade">fork by Stefan Rijnhart</a> had a branch that proved very
complete for our needs.</li>
</ul>
<p>We began by merging Stefan’s branch into our own clone of the repository.  We
came into a small issue and <a class="reference external" href="https://github.com/mvaled/OpenUpgrade/commit/57cd439">fixed it</a>.  Afterwards, some of our
recurrent events were missing the timezone and the migration failed.  For that
we created the branch <a class="reference external" href="https://github.com/mvaled/OpenUpgrade/tree/8.0-valid-rrules">8.0-valid-rrules</a> and it did the job after a couple of
tweeks.</p>
<p>The branch we actually used for the migration is <a class="reference external" href="https://github.com/mvaled/OpenUpgrade/tree/merchise-8.0">merchise-8.0</a>.  It includes
several commits we had to make for our customs addons to work.  Those commits
are probably too local to be merged back into the upstream.  However, we have
published them should anyone finds them useful.</p>
</div>
<div class="section" id="the-menu-decomposition">
<h2>The menu decomposition</h2>
<p>The biggest issue we’ve encountered so far is that after several hours of
operation all the menus stopped working: You clicked the “Leads” menu item and
you got, say, the list of Many2Many fields. (???!!!)</p>
<p>A first inspection showed that all menu items in the HTML were <em>somehow</em>
related to the same action id.  Quickly, we truncated the <span class="docutils literal"><span class="pre">ir_ui_menu</span></span> table
and its associated <span class="docutils literal"><span class="pre">ir_model_data</span></span> rows, upgraded the DB and all menus came
to life once more.</p>
<p>The day after, the same problem happened.  Deeper inspection of both the code
and the DB showed the problem lied in the <span class="docutils literal"><span class="pre">ir_values</span></span> table.  That table
relates menu items with actions.  The rows containing this relation showed
nonsense: almost all the menu items were related to “<span class="docutils literal"><span class="pre">res_partner,20</span></span>”.  And
in the UI this was interpreted to be pointing to the action with id 20.</p>
<p>Comparing the table before and after the upgrade showed no problem there.  So
this issue had appeared after the migration itself.</p>
<p>Our previous method of truncating <span class="docutils literal"><span class="pre">ir_ui_menu</span></span> didn’t fix this issue cause
the <span class="docutils literal"><span class="pre">ir_values</span></span> rows remained there crippling over and over again.  Besides,
truncating <span class="docutils literal"><span class="pre">ir_ui_menu</span></span> had the unintentional, bad side-effect of removing
every Mail list in our DB.</p>
<p>We’re still on the track about how the <span class="docutils literal"><span class="pre">ir.values</span></span> were messed up in the
first place.</p>
</div>
<div class="section" id="the-magical-6-tabs">
<h2>The magical 6 tabs</h2>
<p>Our users started to report slowness after a couple of hours of working.
First, we noticed that the call to <span class="docutils literal"><span class="pre">load_needaction</span></span> was taking too long and
find out this call asked for too much it did not need, we <a class="reference external" href="https://github.com/odoo/odoo/pull/6772">provided a fix</a> and some loose benchmarks.  Though this patch needs
to be completed, the slowness was solved… for a moment.</p>
<p>Some users kept reporting the Odoo interface was freezing all the time, even
inviting them to go out and drink a cup of coffee…  But other users were
happy about it after the patch.  Closer inspection showed many of the AJAX
calls were blocking waiting for a socket to be available.</p>
<p>It turned out these users had created a habit of opening several tabs when
they worked with OpenERP.  They kept this kind of behavior, but a couple of
facts worked against them:</p>
<ul>
<li><p class="first">We have installed the Odoo chat.  Many of our users are geographically
spread, the chat provided an instant and cheaper communication path.</p>
<p>This feature was, by far, one the reason we moved to Odoo in the first
place.</p>
<p>On technical side, the chat works by long polling the server.  In our server
this connection stays open for about 50s before being dropped (only to be
reestablished a moment later).</p>
<p>This means: a tab has always at least a connection open to the server.</p>
</li>
<li><p class="first">As explained by Ilya Grigorik in <a class="reference external" href="http://www.aosabook.org/en/posa/high-performance-networking-in-chrome.html">High Performance Networking in Chrome</a>,
browsers make only so many connections to the same combination of scheme,
host and port.</p>
<p>In Chrome this number is 6.  In Firefox this can be tuned up or down by
tweaking the <span class="docutils literal"><span class="pre">network.http.max-persistent-connections-per-server</span></span>
parameter, but the default is 6.</p>
</li>
</ul>
<p>Combining these, it means that after opening about 6 tabs every AJAX call has
to wait up to 50s to be able to even reach the server.</p>
<p>We opted for raising this number in Firefox and to warn users about this.  Our
user base is small enough and the server has yet to achieve any noticeable
load.</p>
</div>
<div class="section" id="epilogue">
<h2>Epilogue</h2>
<p>That’s what our migration to Odoo story has gone so far.  A little bit
stressful at times, specially when the menus went south for the second time,
but I think we have crossed the yellow line now.  Should anything comes I’ll
report it.</p>
<p>I’d love to hear (or read) about others, so I can learn from their experience.</p>
</div>
]]></description>
            <category><![CDATA[ Management ]]></category>
            <category><![CDATA[ Programming ]]></category>
             <pubDate>Tue, 26 May 2015 00:00:00 -0400</pubDate>
        </item>
    
        <item>
            <link>http://mvaled.github.io/blog/html/2015/04/08/rememoring-microservices.html</link>
            <guid>http://mvaled.github.io/blog/html/2015/04/08/rememoring-microservices.html</guid>
            <title><![CDATA[Memento: microservices]]></title>
            <description><![CDATA[<div class="section" id="memento-microservices">
<h1>Memento: microservices</h1>
<p>Lately there’s been a raise of the debate about Microservices architectures.
Reading about the stuff I realized I did once architect an application called
Pyxel based on the same principles, though different.</p>
<p>Pyxel reached only its first prototype and was never actually deployed.  I’d
say it wasn’t given the chance to prove itself.  So I argue it was technically
sound and, although only a prototype and thus needing improvements, it would
have meet its stated requirements <a class="footnote-reference" href="#disagreement" id="id1">[1]</a>.</p>
<p>I haven’t been given permission to freely distribute the source code.  But the
architecture was published in several public events, so I can freely describe
it here.</p>
<div class="section" id="pyxel">
<h2>Pyxel</h2>
<p>Pyxel’s goal was simple:</p>
<blockquote>
<div>Be a shared repository of photographs for the news media that wish to
collaborate.</div></blockquote>
<p>Pyxel required that images were tagged with IPTC metadata before uploading.
Upon upload, the image went through several processes for extracting the
metadata, and for producing web-friendly versions <a class="footnote-reference" href="#retina" id="id2">[2]</a> for several
standard dimensions before being published.</p>
<p>On the technical side we have also very hard constraints:</p>
<ul class="simple">
<li>the system would have to be highly accessible.</li>
<li>it should run on spare machines; introducing a new machine to replace an old
one should be possible with minimal interruption.</li>
</ul>
<p>This constraints were the main driver that lead us to design what we called a
distributed system.  Each major component was designed to run in isolation of
the rest.</p>
<p>Pyxel was split in several processes:</p>
<ul class="simple">
<li>An image queue holding new images.  This was kind of a FIFO queue over the
network.</li>
<li>A catalog holding indexes for retrieving images based of queries.  Queries
were defined a syntax allowing from very simple queries aided with pattern
recognition (PR) of names and dates, to very specific queries that make the
PR mostly unused.</li>
<li>A “feature” index.  This basically allowed to find similar images.  There
were two indexes, one based on Hu moments and the other based on wavelets.</li>
<li>Several image processing nodes, that take images from the queue and:<ul>
<li>Extract IPTC metadata and put it the catalog</li>
<li>Extract image features to allow detection of similar images.</li>
<li>Produce “web versions” for the image.  We always kept the original file,
but to keep the design of the prototype simple there was an “as-is web
version” that simply returned the same file as the input.</li>
</ul>
</li>
<li>A web application that communicates with the index and the catalogs.</li>
<li>An FTP server that injects images to the queue using a FUSE mount point
(drag-and-drop to the browser wasn’t common yet).</li>
</ul>
<p>That were the main components and all of them ran independently.  Of course
for some services to perform at 100%, they required others to be working.  The
web application would not be able to perform a search if the catalog was down,
or to upload new images if the queue was out of reach.</p>
</div>
<div class="section" id="the-principles-stand">
<h2>The principles stand</h2>
<p>Microservices are “a take” on the same old issue about software composition.
Conceptually <a class="reference external" href="https://www.cs.umd.edu/class/spring2003/cmsc838p/Design/criteria.pdf">Parnas</a> still rules: must do modules.  Names have changed and
several rules to build better modules (components, services, etc) have been
provided.</p>
<p>Exposition of the modules as services have also been promoted.</p>
<p>In the web, the modules have drifted away from the server into the client.</p>
</div>
<div class="section" id="microservices-and-pyxel">
<h2>Microservices and Pyxel</h2>
<p>Pyxel was not actually a microservice architecture as it is understood now.
Deep down it used a central name-server that matched services names to network
endpoints.  We used <a class="reference external" href="https://pypi.python.org/Pyro">Pyro</a> for this prototype.</p>
<p>We did recognize that this was an <em>accidental</em> choice, a matter of convenience
to have the prototype working as soon as possible.</p>
<p>We chose Pyro to test our prototype not to keep it forever if it performed
poorly.  And though our first tests were positive there was some slowness.</p>
<p>To accommodate for a possible replacement of Pyro we chose to provide our own
“idiom” (in Python) to connect and communicate with services:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/><span class="k">with</span> <span class="n">service</span><span class="p">(</span><span class="s1">'pyxel.queue'</span><span class="p">)</span> <span class="k">as</span> <span class="n">queue</span>
    <span class="n">queue</span><span class="o">.</span><span class="n">method</span><span class="p">(</span><span class="o">*</span><span class="n">arguments</span><span class="p">)</span>
</pre></div>
</div>
<p>That pattern was designed to have an appearance as simple as RPC.  Later we
found that <a class="reference external" href="http://steve.vinoski.net/pdf/IEEE-RPC_Under_Fire.pdf">RPC was under fire</a>, but the project was being shut down, so we
didn’t fix that.</p>
<p>Under current views Pyxel needs several changes.  I can think of a couple:</p>
<ul class="simple">
<li>Probably exposing the queue to the client-side of the web application
instead sending the images first to the server-side of the web application.</li>
<li>Extract the user registration, authentication and authorization into a
service.</li>
</ul>
</div>
</div>
<div class="section" id="notes">
<h1>Notes</h1>
<table class="docutils footnote" frame="void" id="disagreement" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>Actually one of the main causes of Pyxel being a failure
was I could not make all participants agreed on the requirements.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="retina" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td>Current retina displays would make that thumbnails look like
icons and bandwidth is also more likely to allow very big pictures to be
friendly.</td></tr>
</tbody>
</table>
</div>
]]></description>
            <category><![CDATA[ architecture ]]></category>
             <pubDate>Wed, 08 Apr 2015 00:00:00 -0400</pubDate>
        </item>
    
        <item>
            <link>http://mvaled.github.io/blog/html/2015/02/18/greenlet-local-python-modules-an-experiment.html</link>
            <guid>http://mvaled.github.io/blog/html/2015/02/18/greenlet-local-python-modules-an-experiment.html</guid>
            <title><![CDATA[Hot-swapping Python modules. An experiment.]]></title>
            <description><![CDATA[<h1>Hot-swapping Python modules. An experiment.</h1>
<p>A new project I’m involved with will <em>probably</em> require dozens of servers
running several thousands <a class="reference external" href="https://greenlet.readthedocs.org/en/latest/">greenlets</a> each.  Top-level greenlets represent jobs
and their children will be individual tasks those greenlets are
coordinating/supervising.</p>
<p>This model, however prototypical, resembles that of the <a class="reference external" href="http://www.erlang.org/">OTP</a> in Erlang.  A
greenlet may be either a supervisor or a worker.</p>
<p>But there’s something missing in our platform that Erlang do have and that
might yield huge benefits.  You can change your Erlang code while the program
is running.</p>
<div class="section" id="modulets-the-idea">
<h2>Modulets.  The idea</h2>
<p>I asked myself if I could devise an <em>import mechanism</em> that would allow to
update a Python module in a way that already-running greenlets stay unaffected
but newly created ones use the new code.</p>
<p>To exemplify, let’s say a typical tasks is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/><span class="k">def</span> <span class="nf">receive_confirmation</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">who</span><span class="p">):</span>
   <span class="kn">from</span> <span class="nn">jobs.util.email</span> <span class="k">import</span> <span class="n">send_email</span>
   <span class="kn">from</span> <span class="nn">jobs.util.email</span> <span class="k">import</span> <span class="n">wait_reply</span>
   <span class="c1"># Assume both send_email and wait_reply switch away from the current</span>
   <span class="c1"># greenlet and only switch back after they are done.</span>
   <span class="n">message</span> <span class="o">=</span> <span class="n">send_email</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">who</span><span class="p">)</span>
   <span class="n">res</span> <span class="o">=</span> <span class="n">wait_reply</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
   <span class="k">return</span> <span class="n">res</span>  <span class="c1"># this will be sent to the parent greenlet</span>
</pre></div>
</div>
<p>The servers start and hundreds of this task are launched in different jobs.
Many of them are idle waiting for their replies.  Users are happily getting
their confirmation emails and replying to them (or ignoring them).</p>
<p>However, we start receiving lot of bounces in the postmaster inbox.  Some
users have entered a wrong email address.  A change is in order.</p>
<p>In response, we change our implementation of <span class="docutils literal"><span class="pre">send_email</span></span> so that it does
<a class="reference external" href="http://en.wikipedia.org/wiki/Variable_envelope_return_path">VERP</a> to know which recipients’ address are bouncing, and also create a new
<cite>job</cite> that involves receiving confirmation email when a new user registers.</p>
<p>We’d love to simply update our <span class="docutils literal"><span class="pre">jobs.util</span></span> package and be done with it like
this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/>$ source server-virtual-env/bin/activate
$ pip install -U jobs.util -i https://my.private.server/
</pre></div>
</div>
<p>New jobs will pick up the new version and the older jobs will keep working as
if nothing would have changed.</p>
<p>That would be really nice.  Such a hot-swap of Python modules per job is what
I’m calling a “modulet”.</p>
<p>Currently I have a “working” <strong>yet very experimental and undertested</strong>
implementation of such a mechanism in our <a class="reference external" href="https://github.com/merchise-autrement/xoutil/tree/experimental-modulets/xoutil/modules">experimental modulets branch</a> in
xoutil.</p>
</div>
<div class="section" id="modulets-in-xoutil">
<h2>Modulets in xoutil</h2>
<p>The current implementation is a very early proof of concept and not something
you’d like to put outside your playground.</p>
<p>The file <a class="reference external" href="https://github.com/merchise-autrement/xoutil/blob/experimental-modulets/xoutil/modules/test_modulet.py"><span class="docutils literal"><span class="pre">test_modulet.py</span></span></a> is a simple script you may run to see it working.
It simply creates a temporary module <span class="docutils literal"><span class="pre">magic_module</span></span> that has the
<span class="docutils literal"><span class="pre">get_magic</span></span> function.  This function returns a single value.</p>
<p>The test launches three greenlets that simply call the <span class="docutils literal"><span class="pre">get_magic</span></span> function
and asserts it returns the “right” magic value.  Between launches the module
gets updated to return a different magic value, which is passed as an argument
to the newly created greenlet.</p>
<p>A single run will print something like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/>$ python test_modulet.py
Beginning with 3 in /tmp/tmp1d4rK5
Isolating 'magic_module' as '&lt;greenlet.greenlet object at 0x7f21f4e8daf0&gt;.magic_module'
Isolating 'magic_module' as '&lt;greenlet.greenlet object at 0x7f21f4e8da50&gt;.magic_module'
Isolating 'magic_module' as '&lt;greenlet.greenlet object at 0x7f21f4daa7d0&gt;.magic_module'
Passed. I have the right magic number 1002
Passed. I have the right magic number 1001
Passed. I have the right magic number 1000
</pre></div>
</div>
<p>If you comment the bootstrapping of modulets, then you’ll get something like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/>$ python test_modulet.py
Beginning with 3 in /tmp/tmpeI1oYA
Wrong magic number
Traceback (most recent call last):
  File "test_modulet.py", line 49, in rootprog
    g.switch()
  File "test_modulet.py", line 31, in prog
    assert res == magic, "Expected %d but got %d." % (magic, res)
AssertionError: Expected 1002 but got 1000.
Wrong magic number
Traceback (most recent call last):
  File "test_modulet.py", line 49, in rootprog
    g.switch()
  File "test_modulet.py", line 31, in prog
    assert res == magic, "Expected %d but got %d." % (magic, res)
AssertionError: Expected 1001 but got 1000.
Passed. I have the right magic number 1000
</pre></div>
</div>
</div>
<div class="section" id="future-work">
<h2>Future work</h2>
<p>Since we are at the very early stages of this project is not easy to predict
if we’ll keep modulets in our platform.  Probably a <a class="reference external" href="http://docs.celeryproject.org/en/latest/">celery</a> based solution be
enough.</p>
<p>If we were to keep it, there are several things to improve:</p>
<ul>
<li><p class="first">The current mechanism pollutes the <span class="docutils literal"><span class="pre">sys.modules</span></span> with a copy of a module
per top-level greenlet.</p>
<p>In the current state, this is an ever-growing pile of modules that never
erases those that are no longer used.</p>
<p>This needs to be changed in several ways:</p>
<p>The namespace we use to masquerade the modules need not be (and should not
be) the repr of the greenlet object.</p>
<p>For the purposes of isolating different versions of the same code we can
either use the timestamp of the files, the version of the distribution,
etc…</p>
<p>Running a <a class="reference external" href="http://diesel.io/">diesel</a> server will quickly eat all your RAM unless this is
changed.</p>
<p>When a <a class="reference external" href="https://greenlet.readthedocs.org/en/latest/">greenlet</a> dies the only one informed is its parent.  But we certainly
don’t want jobs to mess with <span class="docutils literal"><span class="pre">sys.modules</span></span> to clean our own mess.</p>
<p>This poses a challenge of its own and may be delegated outside <cite>xoutil</cite>
itself.</p>
<p>That being said, it’s likely that the calculation of the current namespace
and how to dispose of unused modules will be extensions points of
<cite>modulets</cite>.</p>
</li>
<li><p class="first">Currently we have a black-list of modules that will never be isolated.</p>
<p>Changes in those modules will required a restart to be noticed.  Those
modules are platform-level.  They include <cite>xoutil</cite> itself, <cite>greenlet</cite> and
the entire standard library (which is not expected to change unless you
change Python).</p>
<p>We can also allow white-listing.  Both ways are on the table.</p>
<p>The white-list imposes more explicit architecture of your platform since it
requires throughout revision of which modules you’re willing to update on
the run.</p>
<p>Access to both lists will be a public API of the Modulet Manager.  I can
envision a remote-control console you’ll use to include a new module in the
white-list.  But that will be an application of the modulet API and included
in the box.</p>
</li>
</ul>
</div>
]]></description>
            <category><![CDATA[ Python ]]></category>
            <category><![CDATA[ Programming ]]></category>
             <pubDate>Wed, 18 Feb 2015 00:00:00 -0500</pubDate>
        </item>
    
        <item>
            <link>http://mvaled.github.io/blog/html/2014/12/27/lately.html</link>
            <guid>http://mvaled.github.io/blog/html/2014/12/27/lately.html</guid>
            <title><![CDATA[What I’ve been doing lately]]></title>
            <description><![CDATA[<h1>What I’ve been doing lately</h1>
<p>Lately my work has been mainly driven by the need to efficiently and smoothly
deploy the Accounting module of <a class="reference external" href="http://www.odoo.com/">OpenERP</a> in my employer enterprise.  But at
the same time I’m responsible of several development and deployments in the
enterprise.</p>
<p>The accounting-related tasks have made me to study the accounting module, but
also accounting in general from fundamental principles to advanced topics.  I
currently own a collection of 9 books about accounting.  I still have more
studying to do, but now I’m versed enough to the point of being a (very
junior) accounting consultant to the CEO.  This, of course, should yield
future benefits since I’m planning to start a business.</p>
<p>On the technical side, the last week I was doing a final verification of the
module so that the (true) accountant of the enterprise finally migrates to
OpenERP: Taking our QuickBooks files and, with Pentaho <a class="reference external" href="http://community.pentaho.com/projects/data-integration/">Kettle</a>, migrating the
accounting information to OpenERP, and comparing the legal reports.  This has
finally yielded good results and we’re doing an opening entry to continue
accounting in OpenERP (the enterprise has an accounting period the starts on
Oct, 1st each year).</p>
<p>At the same time a new server for OpenERP and a deployment based on <a class="reference external" href="https://pypi.python.org/pypi/zc.buildout/">Buildout</a>
was another one of my tasks.  There’s still much to be done and I’m wondering
if <a class="reference external" href="https://github.com/ansible/ansible">Ansible</a> would be a good choice to actually manage the deployment since it
involve setting up <a class="reference external" href="http://www.postfix.org/">Postfix</a> as the Mail Transfer Agent interfacing OpenERP for
emails.  This means that besides the accounting books I have reviewed several
email related RFCs (<a class="reference external" href="http://tools.ietf.org/html/rfc2822">2822</a>, <a class="reference external" href="http://tools.ietf.org/html/rfc2821">2821</a> and <a class="reference external" href="http://tools.ietf.org/html/rfc2476">2476</a> being those I’ve read the most) and
the Postfix documentation.</p>
<p>To fill the gaps, or more precisely: to take breaks from these topics I’m
reading a couple of books and articles:</p>
<ul class="simple">
<li>High Performance Browser Networking by Ilya Grigorik.</li>
<li><a class="reference external" href="http://book.mixu.net/distsys/ebook.html">Distributed Systems</a></li>
<li>The <a class="reference external" href="https://hal.inria.fr/inria-00555588">report about Convergent and Commutative Replicated Data Types</a> of
Marc Shapiro and others.  RR-7506, pp. 50 &lt;inria-00555588&gt;.</li>
<li>And for fun, the last book of the Rama saga of Arthur Clark and Gentry Lee.
Which BTW I’ve only truly enjoyed the first book.</li>
</ul>
<div class="section" id="things-left-in-the-attic">
<h2>Things left in the attic</h2>
<p>At the beginning of 2014 I expected I could dedicate myself to finish
<a class="reference external" href="https://github.com/merchise-autrement/xotl.ql">xotl.ql</a> by August.  This was, however, not possible.  I still keep my eye
on the topic from time to time, but this needs a lot of time to actually make
a breakthrough.</p>
</div>
]]></description>
             <pubDate>Sat, 27 Dec 2014 00:00:00 -0500</pubDate>
        </item>
    
        <item>
            <link>http://mvaled.github.io/blog/html/2014/12/09/apples-and-oranges.html</link>
            <guid>http://mvaled.github.io/blog/html/2014/12/09/apples-and-oranges.html</guid>
            <title><![CDATA[Apples and Oranges.  How books can mislead our thinking process.]]></title>
            <description><![CDATA[<h1>Apples and Oranges.  How books can mislead our thinking process.</h1>
<p>I’ve just began to read the book “Twisted Network Programming”… <a class="reference external" href="http://www.twistedmatrix.com/">Twisted</a> is
a popular framework for networking programming.  However, I’d probably skim
most of the Book.  I’m sorry… But as it happens, in the second page of the
second chapter (the one that I began with) they show an illustration on
“Comparing single-threaded, multithreaded, and event-driven program flow”.</p>
<p>Hum… <a class="reference external" href="http://en.wikipedia.org/wiki/Apples_and_oranges">apples and oranges</a>.  I mean the thread model of a program will have
some impact on how events are dealt with, but are they truly comparable or the
sole responsibles for the program flow?</p>
<p><a class="reference external" href="http://diesel.io/">Diesel</a> is usually ran in a single thread and so is <a class="reference external" href="http://www.tornadoweb.org/">Tornado</a>.  You may, of
course, run programs written with them in multiple processes (or threads) to
avoid contention when the volume of clients (events) is too high.</p>
<p>Even with a single thread most of the time the system is waiting for the IO
buffers to have data, so they can be classified as event-driven: They actually
response to events.</p>
<p>But what really bothers about this illustration is not that it compare two
thing that could be (and should be made) complementary.  What bothers me is
that the picture tries to fool me by showing that event-driven programs don’t
have any “gaps” of idle time between tasks, while the threaded models do.  And
that’s simply dishonest.</p>
<p>Probably this is not what the authors meant, and I’m probably going prejudiced
just because of this wrong picture. However, I go to a book like this not for
pleasure but for information.  Finding a piece of data that is not trustworthy
raises a flag and I start to read with a magnifying glass… And that’s not
fun either.</p>
<p>Don’t expect me to finish this book.</p>
<p class="rubric">Update of a couple of hours later…</p>
<p>A few lines below the illustration of matters, they actually say:</p>
<blockquote>
<div>“The event-driven version of the program interleaves the execution of the
three tasks, but in a single thread of control.”</div></blockquote>
<p>So, let’s give it another try.</p>
]]></description>
            <category><![CDATA[ Book Reviews ]]></category>
             <pubDate>Tue, 09 Dec 2014 00:00:00 -0500</pubDate>
        </item>
    
        <item>
            <link>http://mvaled.github.io/blog/html/2014/08/28/reviewing-openerp-8-0.html</link>
            <guid>http://mvaled.github.io/blog/html/2014/08/28/reviewing-openerp-8-0.html</guid>
            <title><![CDATA[Reviewing Odoo 8.0]]></title>
            <description><![CDATA[<h1>Reviewing Odoo 8.0</h1>
<p>This is the first of a series of blog posts related to the next OpenERP 8.0
(or should I say Odoo 8.0).  This first post will be very “seeking for
orientation” on major new features and changes.  Don’t expect anything to be
deeply commented or analyzed.</p>
<p>I will probably devote several posts for changes in some modules, but in this
one I’ll just write about things that can be immediately seen when you first
install it.</p>
<div class="section" id="installing-odoo-8-0">
<h2>Installing Odoo 8.0</h2>
<p>I’m working with a clone from the now official <a class="reference external" href="https://github.com/odoo/odoo">github.com odoo repository</a>.
Of course I’m using the branch “8.0” for this review.</p>
<p>I prepared a <a class="reference external" href="https://pypi.python.org/pypi/virtualenv">virtual environment</a> and installed odoo there like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/>$ python setup.py develop
</pre></div>
</div>
<p>The first I noticed is that several new requirements are in place, and the
<cite>pyPdf</cite> requirement had been forgotten.</p>
<p>Second thing noticed is that unlike the “7.0” you don’t need to run the
<span class="docutils literal"><span class="pre">openerp-server</span></span> script passing the <span class="docutils literal"><span class="pre">--addons-path=./addons</span></span>.  In 8.0 they
include this path automatically.  So running <span class="docutils literal"><span class="pre">./openerp-server</span></span> is enough.</p>
<p>Also the <span class="docutils literal"><span class="pre">python</span> <span class="pre">setup.py</span> <span class="pre">sdist</span></span> command includes this path as well, so a
properly built distribution from source seems more doable.  I haven’t tried
this yet, but I will, cause that was for sure something missing in 7.0.  It’s
quite suspicious that the tarball is too small (around 13MB) though.</p>
</div>
<div class="section" id="new-addons">
<h2>New addons</h2>
<div class="section" id="instant-messaging">
<h3>Instant Messaging</h3>
<p>Once I ran the server I installed a demo DB to see what’s new.  The first
thing that captured my attention was an “Instant Messaging” module.  I gave it
a try and it seemed to work out-of-box.</p>
<p>It uses the quite old <a class="reference external" href="http://stackoverflow.com/questions/11077857/what-are-long-polling-websockets-server-sent-events-sse-and-comet">long polling</a> technique instead of the brand new
<a class="reference external" href="http://en.wikipedia.org/wiki/HTML5">HTML5</a>  <a class="reference external" href="http://en.wikipedia.org/wiki/Server-sent_events">Server-Sent Events</a> (SSE) stuff.  Why?</p>
<p>My first guess was that multi-process deployments would need to pass messages
around between the HTTP processes.  That requires a kind of Inter-Processes
Communication (IPC).  Popular choices for achieving this in web applications
are <a class="reference external" href="http://redis.io/">Redis</a> and <a class="reference external" href="http://www.rabbitmq.com/">RabbitMQ</a>, but then you’d need to setup either for this to
work.</p>
<p>After thinking in this a bit more (actually the thinking about this occurred
at the same time I was writing this post) I realized that the <em>current</em>
multi-process deployments would still need this IPC to properly work.  So I
ran <span class="docutils literal"><span class="pre">./openerp-server</span> <span class="pre">--workers=2</span></span> and tested it again.  The chat stopped to
work and the following error was logged from time to time:</p>
<div class="highlight-traceback notranslate"><div class="highlight"><pre><span/>2014-08-27 22:53:48,972 17858 ERROR o8 openerp.http: Exception during JSON request handling.
Traceback (most recent call last):
  File "/&lt;..&gt;/odoo/openerp/http.py", line 476, in _handle_exception
    return super(JsonRequest, self)._handle_exception(exception)
  File "/&lt;..&gt;/odoo/openerp/http.py", line 495, in dispatch
    result = self._call_function(**self.params)
  File "/&lt;..&gt;/odoo/openerp/http.py", line 311, in _call_function
    return checked_call(self.db, *args, **kwargs)
  File "/&lt;..&gt;/odoo/openerp/service/model.py", line 113, in wrapper
    return f(dbname, *args, **kwargs)
  File "/&lt;..&gt;/odoo/openerp/http.py", line 308, in checked_call
    return self.endpoint(*a, **kw)
  File "/&lt;..&gt;/odoo/openerp/http.py", line 685, in __call__
    return self.method(*args, **kw)
  File "/&lt;..&gt;/odoo/openerp/http.py", line 360, in response_wrap
    response = f(*args, **kw)
  File "/&lt;..&gt;/odoo/addons/bus/bus.py", line 188, in poll
    raise Exception("bus.Bus unavailable")
Exception: bus.Bus unavailable
</pre></div>
</div>
<p>The code explains it all.  This is the method <span class="docutils literal"><span class="pre">ImDispatch.start()</span></span> in file
<span class="docutils literal"><span class="pre">addons/bus/bus.py</span></span>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span/><span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">openerp</span><span class="o">.</span><span class="n">evented</span><span class="p">:</span>
        <span class="c1"># gevent mode</span>
        <span class="kn">import</span> <span class="nn">gevent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Event</span> <span class="o">=</span> <span class="n">gevent</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">Event</span>
        <span class="n">gevent</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">openerp</span><span class="o">.</span><span class="n">multi_process</span><span class="p">:</span>
<span class="hll">        <span class="c1"># disabled in prefork mode</span>
</span>        <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># threaded mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Event</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"</span><span class="si">%s</span><span class="s2">.Bus"</span> <span class="o">%</span> <span class="vm">__name__</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span>
</pre></div>
</div>
<p>The highlighted line says this won’t work in a multi-process deployment.  How
do you get to use the <cite>evented</cite> mode, I don’t know.  Probably that’s the
default now.</p>
<p>So I need to review this feature more closely before going to production.
It’s a nice addition though.</p>
<p>I found they have now a <a class="reference external" href="https://github.com/odoo/odoo/blob/master/openerp/service/server.py#L321"><span class="docutils literal"><span class="pre">GeventServer</span></span></a> for long polling connections.  And the
implementation of the Instant Messaging Bus (<a class="reference external" href="https://github.com/odoo/odoo/blob/master/openerp/addons/bus/bus.py">bus.py</a>) can be easily adapted
for desktop-like notifications, updating your message inbox, and many other
features that would benefit from this.</p>
</div>
<div class="section" id="messaging-has-gone-a-bit-different">
<h3>Messaging has gone a bit different</h3>
<p>At this point I tried to send a message from a user to another (to test if the
inbox was updated real-time) and realized that the Messaging addons has lost
the “compose a new message” that was previously accessible from the inbox, let
me show you a picture (7.0 on the right, 8.0 on the left):</p>
<div class="figure" id="id2">
<img alt="../../../_images/odoo-vs-openerp.png" src="http://mvaled.github.io/blog/html/_images/odoo-vs-openerp.png"/>
<p class="caption"><span class="caption-text">Odoo is missing the “Compose new message” button.</span></p>
</div>
<p>This commit has some explanation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/><span class="n">commit</span> <span class="mi">0714</span><span class="n">b231646bb439b121a6aaa43df32fedcb5e6e</span>
<span class="n">Author</span><span class="p">:</span> <span class="n">Thibault</span> <span class="n">Delavallée</span> <span class="o">&lt;</span><span class="n">tde</span><span class="nd">@openerp</span><span class="o">.</span><span class="n">com</span><span class="o">&gt;</span>
<span class="n">Date</span><span class="p">:</span>   <span class="n">Wed</span> <span class="n">Aug</span> <span class="mi">13</span> <span class="mi">14</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">25</span> <span class="mi">2014</span> <span class="o">+</span><span class="mi">0200</span>

<span class="p">[</span><span class="n">FIX</span><span class="p">]</span> <span class="n">mail</span><span class="p">:</span> <span class="n">when</span> <span class="n">having</span> <span class="n">only</span> <span class="n">mail</span> <span class="n">installed</span><span class="p">,</span> <span class="n">do</span> <span class="ow">not</span> <span class="n">show</span> <span class="nb">any</span> <span class="s1">'share with my</span>
<span class="n">followers</span><span class="s1">' compose box. This comes only with hr, for the inbox. This was</span>
<span class="n">probably</span> <span class="n">forgotten</span> <span class="n">when</span> <span class="n">updating</span> <span class="n">the</span> <span class="n">mailboxes</span> <span class="n">hr</span><span class="o">-</span><span class="n">goal</span> <span class="ow">and</span> <span class="n">hr</span><span class="o">-</span><span class="n">related</span>
<span class="n">gamification</span> <span class="o">/</span> <span class="n">chatter</span> <span class="n">stuff</span><span class="o">.</span>
</pre></div>
</div>
<p>I then installed the “Employee directory” addon and the “Share with my
followers” box appeared.</p>
<p>More digging in the logs reveals the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/><span class="n">commit</span> <span class="n">e6f8666b521fe8c2522d6e94c0c3def54a5f73ed</span>
<span class="n">Merge</span><span class="p">:</span> <span class="n">d57a97d</span> <span class="n">bf3d4a7</span>
<span class="n">Author</span><span class="p">:</span> <span class="n">Amit</span> <span class="n">Vora</span> <span class="o">&lt;</span><span class="n">avo</span><span class="nd">@tinyerp</span><span class="o">.</span><span class="n">com</span><span class="o">&gt;</span>
<span class="n">Date</span><span class="p">:</span>   <span class="n">Thu</span> <span class="n">Apr</span> <span class="mi">17</span> <span class="mi">11</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">33</span> <span class="mi">2014</span> <span class="o">+</span><span class="mi">0200</span>

<span class="p">[</span><span class="n">MERGE</span><span class="p">]</span> <span class="p">[</span><span class="n">IMP</span><span class="p">]</span> <span class="n">mail</span><span class="p">:</span> <span class="n">Inbox</span> <span class="n">usability</span> <span class="n">improvements</span> <span class="p">:</span>
<span class="o">-</span> <span class="n">notficiation_email_send</span> <span class="n">field</span><span class="p">,</span> <span class="n">renamed</span> <span class="n">into</span> <span class="n">notify_email</span><span class="p">,</span> <span class="n">has</span> <span class="n">now</span> <span class="mi">2</span> <span class="n">values</span><span class="p">:</span> <span class="n">always</span> <span class="ow">or</span> <span class="n">never</span><span class="p">,</span> <span class="ow">in</span>
<span class="n">order</span> <span class="n">to</span> <span class="n">ease</span> <span class="n">the</span> <span class="n">choice</span> <span class="ow">and</span> <span class="n">simplify</span> <span class="n">options</span><span class="o">.</span>
<span class="o">-</span> <span class="n">inbox</span><span class="p">:</span> <span class="n">removed</span> <span class="s1">'compose a new messages or write to my followers'</span><span class="p">,</span> <span class="n">because</span> <span class="n">those</span> <span class="mi">2</span> <span class="n">options</span> <span class="n">are</span>
<span class="n">already</span> <span class="n">available</span><span class="o">.</span> <span class="n">The</span> <span class="n">first</span> <span class="n">one</span> <span class="ow">is</span> <span class="n">accessible</span> <span class="n">using</span> <span class="n">the</span> <span class="n">top</span><span class="o">-</span><span class="n">right</span> <span class="n">email</span> <span class="n">icon</span><span class="p">,</span> <span class="n">the</span> <span class="n">second</span> <span class="n">one</span>
<span class="ow">is</span> <span class="n">accessible</span> <span class="k">with</span> <span class="n">the</span> <span class="s1">'write to my followers'</span> <span class="n">text</span> <span class="n">box</span> <span class="n">alread</span> <span class="n">present</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">inbox</span><span class="o">.</span>
</pre></div>
</div>
<p>However I don’t see the mentioned “top-right email icon”.  In fact, that icon
is present in 7.0, but not in 8.0.  More digging:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/><span class="n">commit</span> <span class="mi">5209</span><span class="n">fbc7ed9fcad966ab064654a8a8697142be42</span>
<span class="n">Author</span><span class="p">:</span> <span class="n">Antony</span> <span class="n">Lesuisse</span> <span class="o">&lt;</span><span class="n">al</span><span class="nd">@openerp</span><span class="o">.</span><span class="n">com</span><span class="o">&gt;</span>
<span class="n">Date</span><span class="p">:</span>   <span class="n">Mon</span> <span class="n">Jun</span> <span class="mi">30</span> <span class="mi">01</span><span class="p">:</span><span class="mi">51</span><span class="p">:</span><span class="mi">40</span> <span class="mi">2014</span> <span class="o">+</span><span class="mi">0200</span>

<span class="p">[</span><span class="n">REM</span><span class="p">]</span> <span class="n">useless</span> <span class="n">icon</span> <span class="n">send</span> <span class="n">a</span> <span class="n">message</span>

<span class="n">The</span> <span class="n">action</span> <span class="ow">is</span> <span class="n">available</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">wall</span><span class="o">.</span>
</pre></div>
</div>
<p>Got you!  So, Antony removed the icon cause he thought it was the wall, but
Amit had removed it from the wall cause because of the icon.  These things
happen…</p>
<p>After reverting this commit, the icon is reestablished.  But, then I realized
that the feature, however hidden, is actually there: If you click on the
“Share with …” and instead of writing your message there, click on the
“expand” icon, then you get the same as pressing the (now missing) email icon.
I think that the icon is required, though, since now the “Share…” box is not
shown until HR is installed, and the email icon allows to send email to
outsiders.  My current employer is willing to remove email in favor of this
messaging module.  This may hold him back.</p>
<p>I’m <a class="reference external" href="https://github.com/odoo/odoo/issues/2042">raising my hand to vote</a> for the rescue of (at least) the icon.
Redundancy is not always bad when it comes to user interface.</p>
<p>This enough for this post.  I’ll keep looking at Odoo and I’ll write about it.</p>
</div>
</div>
]]></description>
            <category><![CDATA[ OpenERP ]]></category>
            <category><![CDATA[ Odoo ]]></category>
             <pubDate>Thu, 28 Aug 2014 00:00:00 -0400</pubDate>
        </item>
    
        <item>
            <link>http://mvaled.github.io/blog/html/2014/07/02/integration-v-automation.html</link>
            <guid>http://mvaled.github.io/blog/html/2014/07/02/integration-v-automation.html</guid>
            <title><![CDATA[Integration v. Automation]]></title>
            <description><![CDATA[<h1>Integration v. Automation</h1>
<div class="sidebar">
<p class="first sidebar-title">Editorial note</p>
<p>I’m republishing this post from my <a class="reference external" href="http://manuelonsoftware.wordpress.com/2014/05/12/integration-v-automation/">old blog</a>.  It’s published as it were
when I first made it online with only minor changes.  I’m planning a follow
up on the subject and more post about my experiences with <a class="reference external" href="http://www.odoo.com/">Odoo</a> (OpenERP).
That’s I deem this repost needed.</p>
<p class="last">Hope you’ll enjoy the reading.</p>
</div>
<p>Being an OpenERP bee these days has lead me to think a bit about integration,
how does it happens inside OpenERP, its architecture, assumptions and other
stuff.  In a first iteration I used to think about integration in terms of
integrating two (or more) OpenERP addons, for instance, integrating Sales with
Accounting.  At a very programming-oriented level this reduces, in the current
state of OpenERP, to integrate their modules.  But later, I found out that
this approach is fundamentally flawed and causes many quirks.</p>
<p>This post starts with a tale about one of the many issues we have encounter
when deploying OpenERP in an small enterprise.  Then I will argue about what
integration means.  Lastly, I will turn to automation as a mean for
integration and not the only way to do it.</p>
<div class="section" id="the-integration-tale">
<h2>The Integration tale</h2>
<p>I want to start with a simple and very real <a class="footnote-reference" href="#accounting-last" id="id2">[1]</a> use case: Bob
is a salesperson processing a <a class="reference external" href="http://en.wikipedia.org/wiki/Customer_relationship_management">CRM</a> lead.</p>
<p>The story beings when Bob opens the lead and clicks on the Edit button and the
first thing he tries to do is to fill the client’s contact info because it’s a
new client.  He clicks on the edit button besides the “Client” field which
opens a window.  He fills the data and clicks “save”, but suddenly it fails
saying that Bob (a salesperson) should have filled the “Account payable” and
“Account receivable” fields.  So Bob says:</p>
<blockquote>
<div><p>Oh, boy!  What did I do wrong?.  Let’s try again…  Nope…  Uh.  What
should I do?</p>
<p>Hey!  Peter.  Do you know what’s happening here?  This won’t let me enter
this client’s contact data, it keeps telling me that these accounts are
wrong?  What the heck are these accounts anyway?</p>
</div></blockquote>
<p>And Peter has no idea, so he calls Sally who’s a very pretty girl that
probably does not have a clue either about what’s happening but it’s so nice
to have a reason to approach her…  Surprisingly Sally seems to be only one
who actually paid attention to the information meeting that morning and she
says:</p>
<blockquote>
<div>Ah!  This probably has to do with the Accounting module being installed.
They say they will do that today…  Let’s ask Stephanie.</div></blockquote>
<p>And Stephanie realizes what’s happening and fix it somehow.  An hour later Bob
can resume his work and finish processing his CRM lead.</p>
<p>The end.</p>
<p>So, what is wrong with this story?</p>
<div class="figure" id="id11">
<img alt="Computer problems." src="http://mvaled.github.io/blog/html/_images/computer_problems.png"/>
<p class="caption"><span class="caption-text">Computer Problems.  Taken from <a class="reference external" href="http://xkcd.com/">xkcb</a>.</span></p>
</div>
<div class="section" id="depiction-of-wrongness">
<h3>Depiction of wrongness</h3>
<p>In my opinion there are two things that are clearly wrong with this:</p>
<ol class="loweralpha">
<li><p class="first">Requiring data <em>when</em> it’s not required.  When you’re in a CRM use case
requiring accounting-related seems really overstepping.</p>
</li>
<li><p class="first">Not being able to issue a request for completion.  Bob should have been
able to keep working and after the new client was saved a completion
request should have been sent to those being able to complete the data.</p>
<p>That completion request might just get ignored, but other use cases (like
submit an invoice to that client) would actually require the data and thus
the cycle would be closed after all.</p>
</li>
</ol>
<p>Some would think that this is just a “configuration problem” as we will
<a class="reference internal" href="http://mvaled.github.io/blog/html/2014/07/02/integration-v-automation.html#on-using-properties">discuss below</a>.  But finding that solution took me several dives into the
code and re-parsing of the documentation, so I’ll try to walk you through the
process.</p>
</div>
<div class="section" id="the-issue-the-making-off">
<h3>The issue.  The making off</h3>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Technical stuff ahead.  Wearing hardhats is mandatory.</p>
</div>
<p>By installing the “Accounting &amp; Finance” addon <a class="footnote-reference" href="#v-accountant" id="id4">[2]</a> you touch many
parts of your system besides installing new stuff.  In fact, the module forces
the installation of many other modules, including <span class="docutils literal"><span class="pre">product</span></span> <a class="footnote-reference" href="#no-gnucash" id="id5">[3]</a>.</p>
<p>It also modifies the <span class="docutils literal"><span class="pre">"res.partner"</span></span> model from the <span class="docutils literal"><span class="pre">base</span></span> addon.  You may
think about the <span class="docutils literal"><span class="pre">"res.partner"</span></span> model as an attempt to merge the contact
information for both clients, suppliers and employees into a single
entity <a class="footnote-reference" href="#v-contact-info" id="id6">[4]</a>.  It has many fields that comprise name, job
position, contact information, etc…</p>
<p>When you install the <span class="docutils literal"><span class="pre">account</span></span> addon, the <span class="docutils literal"><span class="pre">"res.partner"</span></span> gets appended a
whole bunch of other fields, including the said “account payable” and “account
receivable” fields, which are also marked as mandatory:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span/><span class="s1">'property_account_payable'</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">property</span><span class="p">(</span>
    <span class="s1">'account.account'</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="s1">'many2one'</span><span class="p">,</span>
    <span class="n">relation</span><span class="o">=</span><span class="s1">'account.account'</span><span class="p">,</span>
    <span class="n">string</span><span class="o">=</span><span class="s2">"Account Payable"</span><span class="p">,</span>
    <span class="n">view_load</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">domain</span><span class="o">=</span><span class="s2">"[('type', '=', 'payable')]"</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s2">"This account will be used instead of the default one as the payable account for the current partner"</span><span class="p">,</span>
    <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
<span class="s1">'property_account_receivable'</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">property</span><span class="p">(</span>
    <span class="s1">'account.account'</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="s1">'many2one'</span><span class="p">,</span>
    <span class="n">relation</span><span class="o">=</span><span class="s1">'account.account'</span><span class="p">,</span>
    <span class="n">string</span><span class="o">=</span><span class="s2">"Account Receivable"</span><span class="p">,</span>
    <span class="n">view_load</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">domain</span><span class="o">=</span><span class="s2">"[('type', '=', 'receivable')]"</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s2">"This account will be used instead of the default one as the receivable account for the current partner"</span><span class="p">,</span>
    <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
</pre></div>
</div>
<p>This are not actual fields of the model <span class="docutils literal"><span class="pre">"res.partner"</span></span>, but properties, which
are “special”.</p>
<div class="section" id="on-using-properties">
<h4>On using properties</h4>
<p>Properties are of course related to the “solution” for the problem described
above.  But the solution is well hidden under the title of <a class="reference external" href="https://doc.openerp.com/book/1/1_3_Real_Case/1_3_Real_Case_db_setup/">Database setup</a>
in the OpenERP Book.  That’s the reason I’m using this case to open the
<cite>OpenERP corner</cite>.  If you deploy CRM before accounting <a class="footnote-reference" href="#accounting-last" id="id7">[1]</a>
you’d probably find no interest in reading a topic called “Database setup”…
you have set your database up already, haven’t you?</p>
<p>You should notice that both <cite>Account receivable</cite> and <cite>Account payable</cite> are, in
fact, properties (i.e defined via <span class="docutils literal"><span class="pre">fields.property</span></span>).  This actually means
that those fields take their default values from a global configuration.</p>
<p>Those values were not properly set in our case cause there were no localized
account chart that applied to our enterprise.  We have to create all the
accounts by hand, and yes, we missed (didn’t know) that we have to create
those properties.</p>
<p>Our problem is solved by defining those properties in the configuration menu.</p>
<p>However this workaround is very unsatisfying:</p>
<ul class="simple">
<li>It involves the administrator of the system because he’s the one that has
access to the “Configuration Parameters”.  AFAIK, the accountant
himself/herself cannot change the defaults, unless you bestow all the powers
on him/her.</li>
<li>It does not resolve the integration problem others might present in the
future.  Integration is harder that having some default values.  For
instance, Cuban accounting norms establish more than 10 accounts for
receivables with empty slots for more if needed.  They require to have
different accounts (receivable and/or payable) for bills to/from people
(B2C) separated from those bills to/from other enterprises (B2B), and also
different accounts for long-term and short-terms bills.  The last case
cannot be decided by just looking at the client or supplier, more
information about the <cite>economic fact</cite> is needed.</li>
<li>It does not actually resolve the current integration problem since the
accountant needs to make sure the “Account Receivable” is the correct one
for the client and he’s not notified when salesman Bob creates a new
partner.  So, what really happens is that the accountant needs to review
journal entries and before posting them, and change the account if needed.</li>
</ul>
</div>
</div>
</div>
<div class="section" id="id8">
<h2>Integration v. Automation</h2>
<p>An ERP should simplify things by <em>integrating business areas</em>, shouldn’t it?
That’s the main driver behind the feature of automatically generating journal
entries.  Under this principle when an invoice is sent to a client a journal
entry should be made recording we should get paid for that, ie.  the client’s
account receivable gets increased <a class="footnote-reference" href="#account-normal-balance" id="id9">[5]</a>.  Likewise when
we get a supplier invoice, an entry should record that we must pay that bill,
ie.  the supplier’s account payable gets increased.</p>
<p>You see now how the “Account Receivable” and “Account Payable” fields for the
partner play their part in the <em>automation</em> of the accounting processes.  This
is deeply weaved into the <span class="docutils literal"><span class="pre">account</span></span> module’s source code.  Meaning that
there’s the assumption that partners have those properties we’re talking
about.  And that’s true because you have injected them and, if you configured
everything as expected, they have their default values.</p>
<p>Notice the difference between the expectation of <em>integration</em> of business
areas and how the integration happens in this case via a very specific kind of
<em>automation</em>.</p>
<p>I’ll argue that the current state of this design is flawed.  When standards
change and/or are not applicable this kind of automation does more harm that
it helps.</p>
<p>This is the reason the module that controls the “Anglo-Saxon
accounting” <a class="footnote-reference" href="#basis" id="id10">[6]</a> is very difficult to understand and the result
artificial: they need an “interim” account to keep track the different stages.
In the standard (for OpenERP) accounting the event to produce journal items in
the debtor/creditor account is the creation of the invoice.  In the
anglo-saxon scheme the journal should be created at shipping time.</p>
<p>I argue that given another framework that clearly separates every actor and
function will improve how this pattern could be implemented.  I think that
this framework must have:</p>
<ol class="loweralpha simple">
<li>Signals and events.</li>
<li>Actors like the accountant, and probably an automated agent for the
accountant that could do the same the models do right now.  But being
responsive (ie. they respond to signals) they could be easily bypassed.</li>
</ol>
<p>Of course there are more things needed. I’m thinking about those two plus the
ones OpenERP already has.</p>
<p>I think that recognizing actors is the major improvement.  Actors are
abstractions about intelligence. If a person should be doing some kind of
intelligent decision (like accountants), then you should encode (in your
design) that decision as being taken by an actor.</p>
<p>Having artificial agents that could take over when the task is standard or
programmable is also an option in this case.  Anywhere in you design an actor
does something, and agent could be replacing the human.  The agents could be
as dumb as the couple of rules we have now: create a journal entry each time
an invoice goes to the valid state, and do it this way.  But agents could be
also provided of machine learning techniques and they could observe the how
the human accountant proceeds when something happened.  Of course this would
require the human to proceed in case-by-case fashion and that’s not always
true.</p>
<p>No matter if the machine learning is never done, I argue that designing with
actors and agents will lead to better a implementation, easier to understand,
maintain and evolve.</p>
</div>
<div class="section" id="notes">
<h2>Notes</h2>
<table class="docutils footnote" frame="void" id="accounting-last" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label">[1]</td><td><em>(<a class="fn-backref" href="#id2">1</a>, <a class="fn-backref" href="#id7">2</a>)</em> <p>This is no hypothetical at all.  We’re actually
deploying Accounting after having deployed Project Management and <a class="reference external" href="http://en.wikipedia.org/wiki/Customer_relationship_management">CRM</a>.</p>
<p class="last">This has come with many surprises but that’s what this post is about.</p>
</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="v-accountant" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[2]</a></td><td>The word addon in here is important.  There are actually
two OpenERP addons named “Accounting &amp; Finance”: the <span class="docutils literal"><span class="pre">account</span></span> addon and
the <span class="docutils literal"><span class="pre">account_accountant</span></span>.  The second one is flagged as an <cite>application</cite>
and, thus, it takes a more prominent place in the listing of available
applications.  Installing the application forces the installation of the
<span class="docutils literal"><span class="pre">account</span></span> module anyway.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="no-gnucash" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[3]</a></td><td>That is why I still do my personal (home) accounting with
<a class="reference external" href="http://www.gnucash.org/">GNU Cash</a>.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="v-contact-info" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id6">[4]</a></td><td>This merge has problems of its own, but that’s a matter
for another post.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="account-normal-balance" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id9">[5]</a></td><td>Though an account either gets credited or
debited, I will avoid that accounting-related terms cause it’s not needed
for the argument in this post.  If you need to know, start by knowing that
receivables have a debit <a class="reference external" href="http://en.wikipedia.org/wiki/Normal_balance">normal balance</a> and go from there.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="basis" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id10">[6]</a></td><td>I’m not quite sure if this “anglo-saxon accounting” refers to
different <a class="reference external" href="http://en.wikipedia.org/wiki/Basis_of_accounting">basis of accounting</a>.</td></tr>
</tbody>
</table>
</div>
]]></description>
            <category><![CDATA[ OpenERP ]]></category>
            <category><![CDATA[ Odoo ]]></category>
             <pubDate>Wed, 02 Jul 2014 00:00:00 -0400</pubDate>
        </item>
    
        <item>
            <link>http://mvaled.github.io/blog/html/2014/06/05/odoo.html</link>
            <guid>http://mvaled.github.io/blog/html/2014/06/05/odoo.html</guid>
            <title><![CDATA[Odoo… I mean OpenERP]]></title>
            <description><![CDATA[<h1>Odoo… I mean OpenERP</h1>
<p>This is old news: OpenERP has changed its name and now becomes Odoo.  I don’t
care much about the change in the name.  It’s the processes I’m interested in.</p>
<p>The rename was synchronized with a move from <a class="reference external" href="https://launchpad.net/">Launchpad</a> to <a class="reference external" href="https://github.com/">Github</a>.  This, I
much appreciate it.  I’m one of those that once the Git virus got me, I’m
almost unable to work comfortably with any other Version Control tool.</p>
<p>I this regard I have a couple of questions:</p>
<ul>
<li><p class="first">Will they use the “standard” Github’s pull-requests model for contributions?
Probably they are longing for this kind of long-tail of contributors model
to kick off now at Github.  I haven’t found any “Why the move to Github” in
the FAQ of the move and other sources (but again my connection is slow and I
didn’t waste much time).</p>
</li>
<li><p class="first">Will they require some kind of a “waive” of copyrights to accept
contributions?</p>
<p>The model of the Plone Foundation requires this.  But this foundation is
non-profit unlike Odoo.</p>
<p>Does this align with the company’s view of the Open Source model?  I don’t
know.</p>
</li>
</ul>
<p>So, my only strategy is:</p>
<ul class="simple">
<li>Fork the <a class="reference external" href="https://github.com/odoo/odoo">Github repository</a></li>
<li>Send as many PRs as I’m able to fix/improve something and hope for the best.</li>
</ul>
<div class="section" id="postdata">
<h2>Postdata</h2>
<p>My long-planned “<a class="reference external" href="http://manuelonsoftware.wordpress.com/2014/03/25/announcing-the-openerp-corner/">OpenERP corner</a>” will simply be renamed accordingly.</p>
<p>This reminds me I have broken my promise to keep my old blog in-sync with this
new one.  Apologies.  But it’s sooo comfortable to work with this blog-model
that I barely looked back once.  So I’ll announce it: I will not keep my old
blog anymore.  I will commit myself to improve the look of this one and that’s
it.</p>
</div>
]]></description>
            <category><![CDATA[ OpenERP ]]></category>
            <category><![CDATA[ Blogroll ]]></category>
             <pubDate>Thu, 05 Jun 2014 00:00:00 -0400</pubDate>
        </item>
    
        <item>
            <link>http://mvaled.github.io/blog/html/2014/05/27/tdd-is-dead-rally.html</link>
            <guid>http://mvaled.github.io/blog/html/2014/05/27/tdd-is-dead-rally.html</guid>
            <title><![CDATA[TDD is dead rally]]></title>
            <description><![CDATA[<h1>TDD is dead rally</h1>
<p>These days there’s a kind of a rally about “TDD being dead”.</p>
<p>Most TDD fan supporters are true that you must have a way to proof your code
works.  Many computer <a class="reference external" href="http://en.wikipedia.org/wiki/Tony_Hoare">scientists</a> have done several attempts into
the “proofs of correctness” for a program.  But tests are not always proofs,
some are <a class="footnote-reference" href="#some-are" id="id1">[1]</a>.</p>
<p>I think the main argument is about when TDD is too much.  Several <a class="reference external" href="https://www.destroyallsoftware.com">Destroy all
software</a> screencasts show a TDD flow that I simply find it’s too
much.  But they are, indeed, screencasts; and they are probably intended to
illustrate a point and not to be followed without deviations.</p>
<p>Nevertheless, I don’t like the “TDD is dead” mantra either.  It gives space to
a flame war I’m not willing to get into.  I use tests and that’s it.  Tests,
at different, levels may express several concerns I need to keep stable:</p>
<ol class="loweralpha">
<li><p class="first">A public API, for instance, should not change just like that.  At least not
after you have made the commitment to keep it stable.</p>
<p>You may even need to test for deprecation warnings being issued when you
need to change an API.</p>
</li>
<li><p class="first">Collaborative in-progress debugging.  This tests allow to express standing
issues.  Some regression tests fall into this category.</p>
</li>
</ol>
<p>How do you do tests?</p>
<div class="section" id="update-amplification-and-support-to-david-s-arguments">
<h2>Update: Amplification and support to <a class="reference external" href="http://david.heinemeierhansson.com/2014/tdd-is-dead-long-live-testing.html">David’s arguments</a></h2>
<p>The previous words were written just after skimming over several tweets.  I
had read <a class="reference external" href="http://david.heinemeierhansson.com/2014/test-induced-design-damage.html">David’s test-induced design damage</a> but I had missed the previous
post <a class="reference external" href="http://david.heinemeierhansson.com/2014/tdd-is-dead-long-live-testing.html">TDD is dead.  Long live testing</a>.  So this update is my one cent to
the issue, but I will not discuss about “slow collaborators” but about my
design experience with our <a class="reference external" href="https://github.com/merchise-autrement/xotl.ql">Python Query Language</a>.</p>
<p>The test-first mantra assumes too much about how you are going to decompose
your problem.  Let’s start with a retrospective account of how this happened
in <a class="reference external" href="https://github.com/merchise-autrement/xotl.ql">xotl.ql</a>.</p>
<p>I can detect four distinct stages:</p>
<ol class="loweralpha">
<li><p class="first">The beginnings.  Slightly TDD, but the tests were not always written before
code.  Since <cite>xotl.ql</cite> is just a language we were not sure about what to
test.</p>
<p>The idea of having a <a class="reference external" href="http://xotl-ql.readthedocs.io/en/latest/terms.html#term-query-object" title="(in xotl.ql v0.3.1)"><span class="xref std std-term">query object</span></a> that stands for the expression
was not totally consolidated.  The components of the query were not
defined.  This stage was heavily driven by our own writings, like <a class="reference external" href="http://xotl-ql.readthedocs.org/en/latest/thoughts.html">this one</a>.</p>
<p>In this case the “literate” spirit dominated the design process, not the
testing.  Simply we didn’t have a full-stack: ie. the language and the
<a class="reference external" href="http://xotl-ql.readthedocs.io/en/latest/terms.html#term-query-translator" title="(in xotl.ql v0.3.1)"><span class="xref std std-term">translators</span></a> so that a query could actually be
executed.</p>
</li>
<li><p class="first">Consolidation of the design.  In this stage several devices were invented
to cope with implementation difficulties, i.e. the <a class="reference external" href="http://xotl-ql.readthedocs.io/en/latest/_revenge/index.html#inner-workings" title="(in xotl.ql v0.3.1)"><span class="xref std std-ref">lack of clear
boundaries</span></a> between several sub-expressions in a
single <a class="reference external" href="http://xotl-ql.readthedocs.io/en/latest/terms.html#term-query" title="(in xotl.ql v0.3.1)"><span class="xref std std-term">query</span></a>.</p>
<p>This was the hardest stage.  Testing was employed to keep track of several
design decisions.  In this stage made appearance our “Particle Bubble” and
this was complex enough to deserve a handful of tests.  Although several
tests did influence the design, they hardly drove it.</p>
</li>
<li><p class="first">Then the core was done and we turned to <a class="reference external" href="http://xotl-ql.readthedocs.io/en/latest/api/translation/py.html#module-xotl.ql.translation.py" title="(in xotl.ql v0.3.1)"><span class="xref py py-mod docutils literal"><span class="pre">translation</span></span></a>.  This stage was mainly TDD cause we
actually were testing a very TDD friendly layer:  Given this state of the
world, the following query should return these objects.</p>
</li>
<li><p class="first">Our current stage. Although in a long pause, we have decided to wipe out
our entire design and do reverse engineering of python byte-code to extract
build the <a class="reference external" href="http://xotl-ql.readthedocs.io/en/latest/terms.html#term-query-object" title="(in xotl.ql v0.3.1)"><span class="xref std std-term">query object</span></a>.</p>
<p>What is foreseeable is that again a kind of literate driven design is going
to be king: The core structure of the language (the query AST) is what’s
being designed so, what’s the point of asking if the result of calling a
function with a given query expression is a particular AST if the AST is
what’s needs to be validated not the function itself?  At this point this
is non-sense.  At a later stage where the AST is stable enough those kind
of tests would actually make sense: they will protect the query language
against unintentional API-breaking changes.</p>
</li>
</ol>
</div>
<div class="section" id="footnotes">
<h2>Footnotes</h2>
<table class="docutils footnote" frame="void" id="some-are" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>If I recall correctly, the book by <cite>R.L Graham</cite>, <cite>D.E. Knuth</cite>
and <cite>O. Patashnik</cite> called “Concrete Mathematics” shows some proofs that
allow “proof-by-instances”.</td></tr>
</tbody>
</table>
</div>
]]></description>
            <category><![CDATA[ Programming ]]></category>
             <pubDate>Tue, 27 May 2014 00:00:00 -0400</pubDate>
        </item>
    
        <item>
            <link>http://mvaled.github.io/blog/html/2014/05/26/progress-in-the-move.html</link>
            <guid>http://mvaled.github.io/blog/html/2014/05/26/progress-in-the-move.html</guid>
            <title><![CDATA[Progress moving to github.io]]></title>
            <description><![CDATA[<h1>Progress moving to github.io</h1>
<p>As you may see, I have made some progress.  Basically, I have partially ported
my past look and feel, so that if looks like the old blog.  I still a work in
progress and the “responsive” stuff is not entirely done.</p>
<p>Nevertheless, I think this is good to go and will start blogging here from now
on.</p>
<p>Enjoy!</p>
]]></description>
            <category><![CDATA[ Blogroll ]]></category>
             <pubDate>Mon, 26 May 2014 00:00:00 -0400</pubDate>
        </item>
    
        <item>
            <link>http://mvaled.github.io/blog/html/2014/05/13/welcome.html</link>
            <guid>http://mvaled.github.io/blog/html/2014/05/13/welcome.html</guid>
            <title><![CDATA[Welcome]]></title>
            <description><![CDATA[<h1>Welcome</h1>
<p>This post intends to be one to welcome my previous readers from <a class="reference external" href="http://manuelonsoftware.wordpress.com/">Wordpress</a>.  I
still have much to do to make this blog actually <strong>my</strong> blog:</p>
<ol class="loweralpha simple">
<li>Polish a theme that resembles my current Wordpress look and feel.  I like
that central column, big fonts in big screens, unobtrusive reading and so
on.</li>
<li>Port my last posts to this new blog.</li>
</ol>
<p>For the moment, though, this post is enough to avoid the default “Not found”
message.  For the moment, also, I’m using <a class="reference external" href="http://tinkerer.me/">Tinkerer</a> to create this blog.</p>
]]></description>
            <category><![CDATA[ Blogroll ]]></category>
             <pubDate>Tue, 13 May 2014 00:00:00 -0400</pubDate>
        </item>
    
    </channel>
</rss>