<!DOCTYPE html><!--[if lt IE 7]>      <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="description" content="Blog mostly about software.">
        <meta name="viewport" content="width=device-width">
        <title>Home &mdash; Manuel on Software - Reloaded</title>
            <link rel="stylesheet" href="_static/normalize.css" type="text/css">
            <link rel="stylesheet" href="_static/sphinx.css" type="text/css">
            <link rel="stylesheet" href="_static/main.css" type="text/css">
            <link rel="stylesheet" href="_static/mva.css" type="text/css">
            <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
            <link rel="stylesheet" href="_static/font-awesome.min.css" type="text/css">
        <!-- Load modernizr and JQuery -->
<script src="_static/vendor/modernizr-2.6.2.min.js"></script>
<script src="_static/vendor/jquery-1.8.2.min.js"></script>
<script src="_static/plugins.js"></script>
<script src="_static/main.js"></script>
<link rel="next" title="Older" href="page2.html" /><link rel="alternate" type="application/rss+xml" title="RSS" href="rss.html" /><script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.5',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script><script type="text/javascript" src="_static/underscore.js"></script><script type="text/javascript" src="_static/doctools.js"></script>

    <script type="text/javascript">
        $(document).ready(function () {
            // Scroll to content if on small screen
            if (screen.width < 480)
            {
                $(document).scrollTop(document.getElementsByTagName("article")[0].offsetTop - 44);
            }
        });
    </script>
    <!-- link rel='stylesheet' id='open-sans-css'  href='//fonts.googleapis.com/css?family=Open+Sans%3A300italic%2C400italic%2C600italic%2C300%2C400%2C600&#038;subset=latin%2Clatin-ext&#038;ver=4.0-alpha' type='text/css' media='all' / -->
    <!-- link rel='stylesheet' id='syntax-merriweather-css'  href='http://fonts.googleapis.com/css?family=Merriweather%3A400%2C300%2C300italic%2C400italic%2C700%2C700italic&#038;ver=4.0-alpha' type='text/css' media='all' / --></head>
    <body role="document">
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

      <div id="container"><header role="banner">
            <hgroup>
              <h1><a href="#">Manuel on Software - Reloaded</a></h1></hgroup>
          </header>
      <!--    <h1 id="toggle-nav" class="menu-toggle">
      <span class="screen-reader-text">Menu</span></h1>
    <nav role="navigation">
      <ul>
        <li class="main-nav">
          <a href="#">Home</a>
        </li>
        <li class="main-nav">
          <a href="pages/about-this.html">About this</a>
        </li>
        </ul>
    </nav> --><div class="main-container" role="main"><div class="main wrapper body clearfix"><article><h1><a href="2016/09/19/uncurated-notes-about-cycle-js.html">Non-curated notes about Cycle.js</a></h1>
<p>In the past few days I have been reading about Reactive Programming.  Mostly
about how it’s done with <a class="reference external" href="http://cycle.js.org/">cycle.js</a>.  As the title attempts to suggest, this
post is by no means an account of well thought ideas, but my first ideas and
notes while reading about it.</p>
<p><a class="reference external" href="http://cycle.js.org/">Cycle.js</a> is attractive, and its appeal spans from two key properties in my
opinion:</p>
<ul>
<li><p class="first">There’s a single type of connector between the components: the streams.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Both <span class="docutils literal"><span class="pre">sources</span></span> and <span class="docutils literal"><span class="pre">sinks</span></span> return streams.</p>
</div>
</li>
<li><p class="first">There are two distinct type of computational components: the drivers and the
the <span class="docutils literal"><span class="pre">main(sources)</span></span> function.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Intent, view and model functions may be regarded as internal
structure of <span class="docutils literal"><span class="pre">main()</span></span>.</p>
</div>
</li>
</ul>
<p>This is appealing because the architecture is simple.  You may understand the
main points of this architecture in about an hour.  You may recall this is
actually an evolution (or instance) of the producer-consumer pattern.</p>
<p>There’s a third element in <a class="reference external" href="http://cycle.js.org/">cycle.js</a>: the cycle itself.  Which is based on
the ‘dialog abstraction’.  Actually, this is what caught my attention in the
first place.  It goes like: your program outputs are the input to an external
(possibly human) entity which, in turn, may react and produce more events in
your program’s source streams.</p>
<p>Architecturally this is simple and good.</p>
<div class="section" id="components">
<h2>Components</h2>
<blockquote>
<div><p>Any Cycle.js app can be reused as a component in a larger Cycle.js app.</p>
<p class="attribution">—From the Cycle.js documentation</p>
</div></blockquote>
<p>When it comes to designing an application or component you have to decide
about the type of events your application may receive and the expected output
events it may produce in response.</p>
<p>The previous statement is only true in two cases:</p>
<ul class="simple">
<li>Your ‘smaller’ Cycle.js application does not need to interact with other
parts of your ‘larger’ application.</li>
<li>Your ‘smaller’ Cycle.js exposes its model; or you have “model drivers”.</li>
</ul>
<p>I think this becomes rather obvious in the 16th part of the Egghead’s video
series on Cycle.js.  The one when they make the slider component and they need
to expose the stream of ‘values’ from the slider.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Actually the documentation states that components expose, somehow,
its state.</p>
</div>
<div class="section" id="streams-to-the-extreme-and-localization">
<h3>Streams to the extreme (and localization)</h3>
<p>The Egghead’s series exposes how Cycle.js became to be and you can, therefore,
see the evolution it is.  Is a short video series worth watching: right to the
point without many detours.</p>
<p>There’s a video when they needed to make a component out of the Height and
Weight sliders, and they needed to pass parameters like the label, min value
and max value. I thought they were going to use old plain closures:</p>
<div class="highlight-default"><div class="highlight"><pre><span/><span class="n">function</span> <span class="n">Slider</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">props</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">const</span> <span class="n">label</span> <span class="o">=</span> <span class="n">props</span><span class="o">.</span><span class="n">label</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">etc</span><span class="o">...</span>
    <span class="k">return</span> <span class="n">main</span><span class="p">(</span><span class="n">sources</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>It came as a surprise that they put those parameters into a <span class="docutils literal"><span class="pre">props</span></span>
<strong>source</strong> to the <span class="docutils literal"><span class="pre">main()</span></span> function of the component.</p>
<p>At first I thought that was really far fetched, but after thinking about it a
bit more I think is can be really useful.</p>
<p>I started to think about an application with just a slider and a language
selector:</p>
<div class="highlight-default"><div class="highlight"><pre><span/><span class="n">Height</span><span class="p">:</span> <span class="mi">6</span> <span class="n">feet</span>   <span class="o">&lt;-----</span><span class="n">o</span><span class="o">--&gt;</span>

<span class="n">Choose</span> <span class="n">language</span><span class="p">:</span> <span class="p">[</span><span class="n">ENG</span><span class="p">]</span>
</pre></div>
</div>
<p>The slider component is the one we see in the video series.  The language
selector is a selection component and the expected behavior is that when I
change the language the <em>entire application</em> changes to the new language.</p>
<p>My first thought is that the language selector gets is value from a driver
(which I don’t know if it already exists) that deals with localization.  Let’s
say you can obtain such a driver like this:</p>
<div class="highlight-default"><div class="highlight"><pre><span/><span class="n">cycle</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="p">{</span>
   <span class="o">//</span> <span class="n">etc</span><span class="o">...</span>
   <span class="n">locale</span><span class="p">:</span> <span class="n">makeLocaleDriver</span><span class="p">({</span><span class="n">languages</span><span class="p">:</span> <span class="p">[</span><span class="s1">'en_US'</span><span class="p">,</span> <span class="s1">'es_ES'</span><span class="p">],</span> <span class="o">...</span><span class="p">})</span>
<span class="p">})</span>
</pre></div>
</div>
<p>The driver would let you respond to changes in translations:</p>
<div class="highlight-default"><div class="highlight"><pre><span/>const label$ = sources.locale.select('Height');
</pre></div>
</div>
<p>Or combining with another mapping from another stream so that the <span class="docutils literal"><span class="pre">props</span></span>
stream remains almost unchanged:</p>
<div class="highlight-default"><div class="highlight"><pre><span/>const label$ = props$.map(p =&gt; sources.locale.select(p.label));
</pre></div>
</div>
<p>However, after revisiting that last idea, I noticed that it doesn’t work.  A
change in in the locale does not trigger any event in the <span class="docutils literal"><span class="pre">props$</span></span> stream.
Assuming that <span class="docutils literal"><span class="pre">locale.current$</span></span> is a stream of localization object, this may
work:</p>
<div class="highlight-default"><div class="highlight"><pre><span/>const label$ = props$.combine(sources.locale.current$)
                     .map((label, locale) =&gt; locale.gettext(label));
</pre></div>
</div>
<p>The thing gets a little bit more tricky when it comes to changing the units:
feet vs meter, etc...  I’ve been thinking about it for a bit.  The most
problematic issue is that state is not clearly owned unless we introduce a
kind of <em>quantity</em> for which the unit of measure is explicit:</p>
<div class="highlight-default"><div class="highlight"><pre><span/><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="p">{</span>
    <span class="n">props</span><span class="p">:</span> <span class="n">xs</span><span class="o">.</span><span class="n">of</span><span class="p">({</span>
       <span class="n">value</span><span class="p">:</span> <span class="n">new</span> <span class="n">Quantity</span><span class="p">(</span><span class="mi">175</span><span class="p">,</span> <span class="n">Unit</span><span class="o">.</span><span class="n">Length</span><span class="o">.</span><span class="n">cm</span><span class="p">),</span>
    <span class="p">})</span>
<span class="p">})</span>
</pre></div>
</div>
<p>However this may seem a bit overreaching for a single <em>value</em> that only needs
to be in between two boundaries (slider).</p>
<p>This is, IMO the breaking point: If I really need to manage units on my
application and those need to be fully localized, my components might be
regarded as over-engineered for other apps.  My only hope is that a simple
slider, without any knowledge of units, might be wrapped inside a
<cite>FullyLocalizedSlider</cite> for that purpose.</p>
</div>
</div>
<div class="section" id="open-questions">
<h2>Open questions</h2>
<p>Most of the ideas exposed above are not battle tested.  I happen to be
evaluating whether I could use <a class="reference external" href="http://cycle.js.org/">Cycle.js</a> inside Odoo to develop some widgets
that require almost real-times updates, and the stream interface is thus quite
natural.</p>
<p>There are challenges about integrating my components with the rest of the
application, and being an application that must display at least three
languages I need to think on advance about the problems I would face.</p>
</div>

        <div class="postmeta">
        
        <div class="categories">
            <span>
                Filed under:
                <a href="categories/programming.html">Programming</a></span>
        </div>
        <div class="tags">
            <span>
                Tags:
                <a href="tags/ui.html">UI</a>, <a href="tags/thought.html">Thought</a></span>
        </div>
        </div>
        <div class="timestamp postmeta">
            <span>September 19, 2016</span>
        </div><div class="separator post_separator"></div><h1><a href="2016/09/02/generating-unique-static-urls-in-odoo.html">Generating unique static URLs in Odoo</a></h1>
<p>By default Odoo bundles static assets (JS and CSS) within a couple of
files: All CSS files are bundled into a single big CSS file.  The same
happens for JS files.</p>
<p>The URLs of those bundles vary with any change within any of the
included files.  But those files are big.  Therefore changing assets
put some stress in the network and diminish the usefulness of caches.</p>
<p>Since Sep 19th, 2015 we introduced a <a class="reference external" href="https://github.com/merchise-autrement/odoo/commit/03741a2cb81907b4b67ca8437f260b073689d212">patch</a> in
Odoo to avoid bundling of static assets when using a SPDY or HTTP/2
proxy like Nginx.</p>
<p>Reportedly, this has worked very well in our case where some users
have slow connections.  However, measuring the logs of a week we see
that about 21% of GET request are assets:</p>
<div class="highlight-default"><div class="highlight"><pre><span/>$ egrep 'GET .*(\.|/)(css|js).* HTTP/' /var/log/nginx/o.access.log.1 | wc -l
10554

$ egrep 'GET .* HTTP' /var/log/nginx/o.access.log.1 | wc -l
50216
</pre></div>
</div>
<p>Odoo’s default cache expiration time is seven days.  This is
considerably low taking into account that bundle’s URLs change when
the content does.</p>
<p>Another issue is that assets that change can be served staled from the
caches for seven days.</p>
<p>We’re taking the path to produce unique URLs for static assets.  Our
current work can be seen in our <a class="reference external" href="https://github.com/merchise-autrement/odoo/tree/merchise-unique-static-urls">merchise-unique-static-urls</a>
branch.  In our development/deployment scenarios these simple changes
would suffice for JS and CSS.  There’s still work to do regarding
invalidation of static images in our templates.</p>

        <div class="postmeta">
        
        <div class="categories">
            <span>
                Filed under:
                <a href="categories/programming.html">Programming</a></span>
        </div>
        <div class="tags">
            <span>
                Tags:
                <a href="tags/odoo.html">Odoo</a></span>
        </div>
        </div>
        <div class="timestamp postmeta">
            <span>September 02, 2016</span>
        </div><div class="separator post_separator"></div><h1><a href="2015/09/12/odoo-bus-implementation.html">The bus <em>implementation</em> in Odoo and notification systems in the Web</a></h1>
<div class="sidebar">
<p class="first sidebar-title">Delayed post.</p>
<p>This post has been delayed for a very, very long time.  If I trust the logs
in my blog’s git repository the post is “finished” since Sat Sep 12, 2015.
Well, that’s not true, and I must really finish it now.</p>
<p>As it happens, in the meantime, I was not twiddling my fingers and I made
two “advances” about the bus implementation:</p>
<ul class="last simple">
<li>I made a successful implementation of a cross-tab bus implementation:
<a class="reference external" href="https://github.com/merchise-autrement/odoo/tree/merchise-8.0-bus-service-worker">https://github.com/merchise-autrement/odoo/tree/merchise-8.0-bus-service-worker</a></li>
<li>I discovered that Odoo 9’s code base already has the cross-tab feature
integrated.</li>
</ul>
</div>
<p>I commented on my <a class="reference internal" href="2015/05/26/odoo-at-last.html#odoo-at-last"><span class="std std-ref">post about our migration to Odoo</span></a> that
our users open many tabs to the same Odoo instance.  When the chat is active
this means an open connection for each tab and, since a chat is interactive in
nature, all but one of these connections are not actually required <a class="footnote-reference" href="#notify" id="id1">[1]</a>.</p>
<p>A while ago <a class="reference external" href="https://twitter.com/mvaled/status/615973409697050624">I reported</a> that switching from a
threaded based deployment to a pre-forked processes one with a <a class="reference external" href="https://pypi.python.org/pypi/gevent">gevent</a> based
process for long polling connections, actually spiked the concurrency issues
we were witnessing in our DB.  Our DB complained about being unable to
<em>serialize</em> concurrent transactions.  By inspecting the logs we noticed that
almost always this had to do with an update to the table <span class="docutils literal"><span class="pre">im_chat_presence</span></span>,
that holds the status of users in the chat.</p>
<p>I thought the forked model would diminish the chance of collisions because (I
thought) Odoo would use a single DB connection per worker process and another
one for the gevent worker that would simply serialize <em>all</em> the chat related
queries.</p>
<p>This spike was against all rationale I could think of, but honestly I didn’t
check my assumptions by reading the code.  They might just be the wrong
assumptions in the first place, and I needed to really read the code to see
what was really happening.</p>
<p>After restoring the threaded deployment the concurrency issues dropped again.
They didn’t get to the same levels they were before, but, at the same time, we
were introducing other modules (and the related staff), so there are more open
tabs...  Afterwards we went back to the process model, and the issues spiked
again, however in a smaller amount.</p>
<p>Several weeks later I deployed a <a class="reference external" href="https://github.com/merchise-autrement/odoo/commit/2abfd5ba28e959dda4d6a127a19b3d939008bc1d">patch</a> to the Odoo bus
implementation that simply reduced the frequency of polling when the <a class="reference external" href="http://www.w3.org/TR/page-visibility/">page is
hidden</a>.  The concurrency issues were now mostly gone:
from about 3k a day to no more than 50.</p>
<p>We still had unanswered questions regarding the DB connection management in
Odoo.  There were suspicious signs.  For instance reducing the <span class="docutils literal"><span class="pre">db_maxconn</span></span>
option to 8 or less made Odoo start complaining about the Connection Pool
being full very often.  We already knew that:</p>
<ul class="simple">
<li>For each cron worker at least 2 connections are used: one holds the cron job
locked while the other is used by the job itself.</li>
<li>The bus (used for the chat) also uses another connection to the DB
“postgres”: Notifications and wake-ups of bus-related events use this
connection.</li>
</ul>
<p>The most suspicious sign, however, was that with a pool size of 32, this issue
came from time to time.</p>
<p>Time went by and the issue remained at an acceptable (for us) level of few
dozens per day.  You may say it’s too much, but, bear with me, it’s reasonable
for our hardware and user base.</p>
<p>Just a few days ago, we realized that issues coming from our gevent-based
process were not being properly reported to our <a class="reference external" href="http://getsentry.com/">Sentry</a>.  We <a class="reference external" href="https://github.com/merchise-autrement/xoeuf/commit/d4b3bb7f0d972f31382aad8e6d1bf37c5a74ce99">fixed the issue</a> and observed that we’re getting about 2.5k DB collisions
per day reports again.  And once more the query the table where most of
collisions happen is ‘im_chat_presence’.</p>
<p>As a workaround we simply <a class="reference external" href="https://github.com/merchise-autrement/odoo/commit/555b5699b96178d5c87f36c0f692dbe8dcf0facb">reduced</a> the update rate for that table.  But a
better solutions needed to be found.</p>
<div class="section" id="cross-tab-polling">
<h2>Cross-tab polling</h2>
<p>By looking better our users’ usage pattern, we discovered that users switch
from tab to tab regularly and thus the polling is still high.  So we went down
the path of figuring out a way to have a single polling connection even when
many were opened.</p>
<p>I remembered the Local Storage API and went down to write a simple proof of
concept of listening events of the <span class="docutils literal"><span class="pre">localStorage</span></span> from different tabs.  The
proof of concept yielded good results, and so I turned to Google and search
for “cross-tab communication” and found the <a class="reference external" href="https://github.com/nodeca/tabex">tabex</a> library.</p>
<p>After that, replacing the implementation of the bus for a new one that was
based on a exchanged between tabs was not very hard.  These are the commits
done in our branch (in reverse topological order as in <span class="docutils literal"><span class="pre">git</span> <span class="pre">log</span></span>):</p>
<div class="highlight-default"><div class="highlight"><pre><span/><span class="mi">0555434</span> <span class="o">*</span> <span class="n">bus</span><span class="p">:</span> <span class="n">Clarify</span> <span class="n">the</span> <span class="n">channel</span> <span class="n">delay</span> <span class="ow">in</span> <span class="n">polls</span><span class="o">.</span>
<span class="n">d10a1b5</span> <span class="o">*</span> <span class="n">bus</span><span class="p">:</span> <span class="n">Checks</span> <span class="k">for</span> <span class="n">the</span> <span class="n">right</span> <span class="n">state</span><span class="o">.</span>
<span class="n">af4a6dc</span> <span class="o">*</span> <span class="n">bus</span><span class="p">:</span> <span class="n">Add</span> <span class="n">language</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">documentation</span><span class="o">.</span>
<span class="mi">636490</span><span class="n">b</span> <span class="o">*</span> <span class="n">im_chat</span><span class="p">:</span> <span class="n">Revert</span> <span class="s2">"Reduce the presure on im_chat_presence table."</span>
<span class="n">eda7638</span> <span class="o">*</span> <span class="n">bus</span><span class="p">:</span> <span class="n">Don</span><span class="s1">'t notify if not in polling state.</span>
<span class="mi">4</span><span class="n">d09ac6</span> <span class="o">*</span> <span class="n">web_celery</span><span class="p">:</span> <span class="n">Use</span> <span class="n">a</span> <span class="n">dedicated</span> <span class="n">bus</span> <span class="n">exchange</span> <span class="k">for</span> <span class="n">jobs</span><span class="o">.</span>
<span class="mi">84239</span><span class="n">e3</span> <span class="o">*</span> <span class="n">im_chat</span><span class="p">:</span> <span class="n">Beep</span> <span class="n">only</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">master</span> <span class="n">tab</span><span class="o">.</span>
<span class="mi">2</span><span class="n">cb27da</span> <span class="o">*</span> <span class="n">Improve</span> <span class="n">the</span> <span class="n">bus</span> <span class="n">to</span> <span class="n">allow</span> <span class="n">tab</span> <span class="n">synchronization</span><span class="o">.</span>
</pre></div>
</div>
<p>The file <a class="reference external" href="https://github.com/merchise-autrement/odoo/blob/merchise-8.0-bus-service-worker/addons/bus/static/src/js/bus.rst"><span class="docutils literal"><span class="pre">addons/bus/static/src/js/bus.rst</span></span></a> contains the new design explained.</p>
<p>A few weeks ago I did the <a class="reference external" href="https://github.com/merchise-autrement/odoo/commit/4690d8d466fe622a1a2449403cc41ae78d4caafe">first merge</a> our 8.0 changes into the 9.0 branch.
On the process I realized that Odoo 9.0’s bus was improved and now contains
the a cross-tab communication feature.</p>
<p>So probably I end up backporting their implementation into 8.0.</p>
</div>
<div class="section" id="notes">
<h2>Notes</h2>
<table class="docutils footnote" frame="void" id="notify" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>Of course it allows the web app to change the window’s title when
then user has an unread message, but in our case this notification is also
unneeded, because the message is actually being read in another tab.</td></tr>
</tbody>
</table>
</div>

        <div class="postmeta">
        
        <div class="categories">
            <span>
                Filed under:
                <a href="categories/web-development.html">Web Development</a>, <a href="categories/programming.html">Programming</a></span>
        </div>
        <div class="tags">
            <span>
                Tags:
                <a href="tags/html5.html">HTML5</a>, <a href="tags/odoo.html">Odoo</a></span>
        </div>
        </div>
        <div class="timestamp postmeta">
            <span>September 12, 2015</span>
        </div><div class="separator post_separator"></div><h1><a href="2015/08/04/repost-the-productivity-of-tomorrow-trumps-that-of-today.html">The productivity of tomorrow trumps that of today</a></h1>
<div class="sidebar">
<p class="first sidebar-title">Editorial note</p>
<p>I’m republishing this post from my old blog (which is no longer online).
It’s published as it were when I first made it online with only minor
changes.  But I think I stand by this still.</p>
<p class="last">Hope you’ll enjoy the reading.</p>
</div>
<p>That’s probably harsh, but I think it is absolutely right.  Doing crappy
software today to be more productive today will make you less productive
tomorrow.  It’s this simple.  And that’s cumulative too; meaning that if you
neglect your future productivity, it will be slowly diminishing until a point
of negative competitive disadvantage where you’ll find yourself struggling to
keep up instead of innovating.</p>
<p>And it’s so damn exhausting to explain why...</p>
<p>Software complexity does not come from the tools, but from the mental
framework required (and imposed at times) to understand it.  So don’t ever
think measuring Cyclomatic Complexity (CC) and other similar metrics will
yield something close to the <a class="reference external" href="http://www.osnews.com/story/19266/WTFs_m">true measure</a> of the
<a class="reference external" href="http://blog.codinghorror.com/whos-your-coding-buddy/">quality of your code</a>.</p>
<blockquote>
<div><p>There are only <a class="reference external" href="http://martinfowler.com/bliki/TwoHardThings.html">two hard things</a> in Computer Science: cache invalidation
and naming things.</p>
<p class="attribution">—Phil Karlton</p>
</div></blockquote>
<div class="highlight-default"><div class="highlight"><pre><span/><span class="k">def</span> <span class="nf">_check</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
       <span class="k">return</span> <span class="n">l</span>
    <span class="n">l1</span><span class="p">,</span> <span class="n">l2</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
       <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;=</span><span class="n">m</span> <span class="p">:</span>
          <span class="n">l1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
       <span class="k">else</span><span class="p">:</span>
          <span class="n">l2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_check</span><span class="p">(</span><span class="n">l1</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">+</span><span class="n">_check</span><span class="p">(</span><span class="n">l2</span><span class="p">)</span>
</pre></div>
</div>
<p>This code has a nice CC of 4 which is very nice; yet it will take you at least
a minute to figure out what it does.  If only I had chosen to name the
function <cite>quicksort</cite>...</p>
<div class="highlight-default"><div class="highlight"><pre><span/><span class="gp">&gt;&gt;&gt; </span><span class="n">_check</span><span class="p">([</span><span class="mi">84</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">89</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">77</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">16</span><span class="p">])</span>
<span class="go">[4, 16, 24, 70, 77, 84, 86, 89, 95, 95]</span>
</pre></div>
</div>
<p>A quiz in less than 5 seconds: What does it mean in OpenERP’s ORM the
following lines of code?</p>
<div class="highlight-default"><div class="highlight"><pre><span/><span class="n">group</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">'implied_ids'</span><span class="p">:</span> <span class="p">[(</span><span class="mi">3</span><span class="p">,</span> <span class="n">implied_group</span><span class="o">.</span><span class="n">id</span><span class="p">)]})</span>
</pre></div>
</div>
<p>This line of code has a CC of 1: as good as it gets, isn’t it?  But it’s so
darn difficult to read that unless you have your brain wired up to see “forget
the link between this group and the implied_group”...  To be fair there is
someone out there in the OpenERP universe that cared a bit about this:</p>
<div class="highlight-default"><div class="highlight"><pre><span/><span class="c1"># file addons/base/ir/ir_fields.py</span>

<span class="n">CREATE</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">values</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
<span class="n">UPDATE</span> <span class="o">=</span> <span class="k">lambda</span> <span class="nb">id</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
<span class="n">DELETE</span> <span class="o">=</span> <span class="k">lambda</span> <span class="nb">id</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">FORGET</span> <span class="o">=</span> <span class="k">lambda</span> <span class="nb">id</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">LINK_TO</span> <span class="o">=</span> <span class="k">lambda</span> <span class="nb">id</span><span class="p">:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">DELETE_ALL</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">REPLACE_WITH</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">ids</span><span class="p">:</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">ids</span><span class="p">)</span>
</pre></div>
</div>
<p>But no one else is using it!</p>
<p>And, yes, it’s exhausting going over this.</p>

        <div class="postmeta">
        
        <div class="categories">
            <span>
                Filed under:
                <a href="categories/programming.html">Programming</a></span>
        </div>
        
        </div>
        <div class="timestamp postmeta">
            <span>August 04, 2015</span>
        </div><div class="separator post_separator"></div><span id="id1"/><h1><a href="2015/05/26/odoo-at-last.html">Odoo at last!</a></h1>
<div class="sidebar">
<p class="first sidebar-title">Updated 2015-06-03</p>
<p><a class="reference internal" href="2015/05/26/odoo-at-last.html#the-menu-decomposition">The menu decomposition</a> described below was actually an error in a custom
addon and not related with migration process.</p>
<p class="last">While still using OpenERP, we backported the partner merge feature from
Odoo and made it work in OpenERP.  We even added a fuzzy match feature so
that minor typos were not missed.  Now in Odoo it seems our modifications
messed things up.</p>
</div>
<p>After several months, we have finally moved from OpenERP to Odoo.  It took
several rounds of testing, finding bugs and incompatibilities in our own
modules and fixing them.</p>
<div class="section" id="a-summary-of-the-process">
<h2>A summary of the process</h2>
<p>The <a class="reference external" href="https://github.com/OpenUpgrade/OpenUpgrade">OpenUpgrade</a> project proved to be very complete for us –it had almost
everything we needed:</p>
<ul class="simple">
<li>The Accounting and Project modules were done.</li>
<li>The CRM module was not yet integrated into the mainstream repository but a
<a class="reference external" href="https://github.com/StefanRijnhart/OpenUpgrade">fork by Stefan Rijnhart</a> had a branch that proved very
complete for our needs.</li>
</ul>
<p>We began by merging Stefan’s branch into our own clone of the repository.  We
came into a small issue and <a class="reference external" href="https://github.com/mvaled/OpenUpgrade/commit/57cd439">fixed it</a>.  Afterwards, some of our
recurrent events were missing the timezone and the migration failed.  For that
we created the branch <a class="reference external" href="https://github.com/mvaled/OpenUpgrade/tree/8.0-valid-rrules">8.0-valid-rrules</a> and it did the job after a couple of
tweeks.</p>
<p>The branch we actually used for the migration is <a class="reference external" href="https://github.com/mvaled/OpenUpgrade/tree/merchise-8.0">merchise-8.0</a>.  It includes
several commits we had to make for our customs addons to work.  Those commits
are probably too local to be merged back into the upstream.  However, we have
published them should anyone finds them useful.</p>
</div>
<div class="section" id="the-menu-decomposition">
<h2>The menu decomposition</h2>
<p>The biggest issue we’ve encountered so far is that after several hours of
operation all the menus stopped working: You clicked the “Leads” menu item and
you got, say, the list of Many2Many fields. (???!!!)</p>
<p>A first inspection showed that all menu items in the HTML were <em>somehow</em>
related to the same action id.  Quickly, we truncated the <span class="docutils literal"><span class="pre">ir_ui_menu</span></span> table
and its associated <span class="docutils literal"><span class="pre">ir_model_data</span></span> rows, upgraded the DB and all menus came
to life once more.</p>
<p>The day after, the same problem happened.  Deeper inspection of both the code
and the DB showed the problem lied in the <span class="docutils literal"><span class="pre">ir_values</span></span> table.  That table
relates menu items with actions.  The rows containing this relation showed
nonsense: almost all the menu items were related to “<span class="docutils literal"><span class="pre">res_partner,20</span></span>”.  And
in the UI this was interpreted to be pointing to the action with id 20.</p>
<p>Comparing the table before and after the upgrade showed no problem there.  So
this issue had appeared after the migration itself.</p>
<p>Our previous method of truncating <span class="docutils literal"><span class="pre">ir_ui_menu</span></span> didn’t fix this issue cause
the <span class="docutils literal"><span class="pre">ir_values</span></span> rows remained there crippling over and over again.  Besides,
truncating <span class="docutils literal"><span class="pre">ir_ui_menu</span></span> had the unintentional, bad side-effect of removing
every Mail list in our DB.</p>
<p>We’re still on the track about how the <span class="docutils literal"><span class="pre">ir.values</span></span> were messed up in the
first place.</p>
</div>
<div class="section" id="the-magical-6-tabs">
<h2>The magical 6 tabs</h2>
<p>Our users started to report slowness after a couple of hours of working.
First, we noticed that the call to <span class="docutils literal"><span class="pre">load_needaction</span></span> was taking too long and
find out this call asked for too much it did not need, we <a class="reference external" href="https://github.com/odoo/odoo/pull/6772">provided a fix</a> and some loose benchmarks.  Though this patch needs
to be completed, the slowness was solved... for a moment.</p>
<p>Some users kept reporting the Odoo interface was freezing all the time, even
inviting them to go out and drink a cup of coffee...  But other users were
happy about it after the patch.  Closer inspection showed many of the AJAX
calls were blocking waiting for a socket to be available.</p>
<p>It turned out these users had created a habit of opening several tabs when
they worked with OpenERP.  They kept this kind of behavior, but a couple of
facts worked against them:</p>
<ul>
<li><p class="first">We have installed the Odoo chat.  Many of our users are geographically
spread, the chat provided an instant and cheaper communication path.</p>
<p>This feature was, by far, one the reason we moved to Odoo in the first
place.</p>
<p>On technical side, the chat works by long polling the server.  In our server
this connection stays open for about 50s before being dropped (only to be
reestablished a moment later).</p>
<p>This means: a tab has always at least a connection open to the server.</p>
</li>
<li><p class="first">As explained by Ilya Grigorik in <a class="reference external" href="http://www.aosabook.org/en/posa/high-performance-networking-in-chrome.html">High Performance Networking in Chrome</a>,
browsers make only so many connections to the same combination of scheme,
host and port.</p>
<p>In Chrome this number is 6.  In Firefox this can be tuned up or down by
tweaking the <span class="docutils literal"><span class="pre">network.http.max-persistent-connections-per-server</span></span>
parameter, but the default is 6.</p>
</li>
</ul>
<p>Combining these, it means that after opening about 6 tabs every AJAX call has
to wait up to 50s to be able to even reach the server.</p>
<p>We opted for raising this number in Firefox and to warn users about this.  Our
user base is small enough and the server has yet to achieve any noticeable
load.</p>
</div>
<div class="section" id="epilogue">
<h2>Epilogue</h2>
<p>That’s what our migration to Odoo story has gone so far.  A little bit
stressful at times, specially when the menus went south for the second time,
but I think we have crossed the yellow line now.  Should anything comes I’ll
report it.</p>
<p>I’d love to hear (or read) about others, so I can learn from their experience.</p>
</div>

        <div class="postmeta">
        
        <div class="categories">
            <span>
                Filed under:
                <a href="categories/management.html">Management</a>, <a href="categories/programming.html">Programming</a></span>
        </div>
        <div class="tags">
            <span>
                Tags:
                <a href="tags/odoo.html">Odoo</a>, <a href="tags/openerp.html">OpenERP</a></span>
        </div>
        </div>
        <div class="timestamp postmeta">
            <span>May 26, 2015</span>
        </div><div class="separator post_separator"></div><div class="section" id="memento-microservices">
<h1><a href="2015/04/08/rememoring-microservices.html">Memento: microservices</a></h1>
<p>Lately there’s been a raise of the debate about Microservices architectures.
Reading about the stuff I realized I did once architect an application called
Pyxel based on the same principles, though different.</p>
<p>Pyxel reached only its first prototype and was never actually deployed.  I’d
say it wasn’t given the chance to prove itself.  So I argue it was technically
sound and, although only a prototype and thus needing improvements, it would
have meet its stated requirements <a class="footnote-reference" href="#disagreement" id="id1">[1]</a>.</p>
<p>I haven’t been given permission to freely distribute the source code.  But the
architecture was published in several public events, so I can freely describe
it here.</p>
<div class="section" id="pyxel">
<h2>Pyxel</h2>
<p>Pyxel’s goal was simple:</p>
<blockquote>
<div>Be a shared repository of photographs for the news media that wish to
collaborate.</div></blockquote>
<p>Pyxel required that images were tagged with IPTC metadata before uploading.
Upon upload, the image went through several processes for extracting the
metadata, and for producing web-friendly versions <a class="footnote-reference" href="#retina" id="id2">[2]</a> for several
standard dimensions before being published.</p>
<p>On the technical side we have also very hard constraints:</p>
<ul class="simple">
<li>the system would have to be highly accessible.</li>
<li>it should run on spare machines; introducing a new machine to replace an old
one should be possible with minimal interruption.</li>
</ul>
<p>This constraints were the main driver that lead us to design what we called a
distributed system.  Each major component was designed to run in isolation of
the rest.</p>
<p>Pyxel was split in several processes:</p>
<ul class="simple">
<li>An image queue holding new images.  This was kind of a FIFO queue over the
network.</li>
<li>A catalog holding indexes for retrieving images based of queries.  Queries
were defined a syntax allowing from very simple queries aided with pattern
recognition (PR) of names and dates, to very specific queries that make the
PR mostly unused.</li>
<li>A “feature” index.  This basically allowed to find similar images.  There
were two indexes, one based on Hu moments and the other based on wavelets.</li>
<li>Several image processing nodes, that take images from the queue and:<ul>
<li>Extract IPTC metadata and put it the catalog</li>
<li>Extract image features to allow detection of similar images.</li>
<li>Produce “web versions” for the image.  We always kept the original file,
but to keep the design of the prototype simple there was an “as-is web
version” that simply returned the same file as the input.</li>
</ul>
</li>
<li>A web application that communicates with the index and the catalogs.</li>
<li>An FTP server that injects images to the queue using a FUSE mount point
(drag-and-drop to the browser wasn’t common yet).</li>
</ul>
<p>That were the main components and all of them ran independently.  Of course
for some services to perform at 100%, they required others to be working.  The
web application would not be able to perform a search if the catalog was down,
or to upload new images if the queue was out of reach.</p>
</div>
<div class="section" id="the-principles-stand">
<h2>The principles stand</h2>
<p>Microservices are “a take” on the same old issue about software composition.
Conceptually <a class="reference external" href="https://www.cs.umd.edu/class/spring2003/cmsc838p/Design/criteria.pdf">Parnas</a> still rules: must do modules.  Names have changed and
several rules to build better modules (components, services, etc) have been
provided.</p>
<p>Exposition of the modules as services have also been promoted.</p>
<p>In the web, the modules have drifted away from the server into the client.</p>
</div>
<div class="section" id="microservices-and-pyxel">
<h2>Microservices and Pyxel</h2>
<p>Pyxel was not actually a microservice architecture as it is understood now.
Deep down it used a central name-server that matched services names to network
endpoints.  We used <a class="reference external" href="https://pypi.python.org/Pyro">Pyro</a> for this prototype.</p>
<p>We did recognize that this was an <em>accidental</em> choice, a matter of convenience
to have the prototype working as soon as possible.</p>
<p>We chose Pyro to test our prototype not to keep it forever if it performed
poorly.  And though our first tests were positive there was some slowness.</p>
<p>To accommodate for a possible replacement of Pyro we chose to provide our own
“idiom” (in Python) to connect and communicate with services:</p>
<div class="highlight-default"><div class="highlight"><pre><span/><span class="k">with</span> <span class="n">service</span><span class="p">(</span><span class="s1">'pyxel.queue'</span><span class="p">)</span> <span class="k">as</span> <span class="n">queue</span>
    <span class="n">queue</span><span class="o">.</span><span class="n">method</span><span class="p">(</span><span class="o">*</span><span class="n">arguments</span><span class="p">)</span>
</pre></div>
</div>
<p>That pattern was designed to have an appearance as simple as RPC.  Later we
found that <a class="reference external" href="http://steve.vinoski.net/pdf/IEEE-RPC_Under_Fire.pdf">RPC was under fire</a>, but the project was being shut down, so we
didn’t fix that.</p>
<p>Under current views Pyxel needs several changes.  I can think of a couple:</p>
<ul class="simple">
<li>Probably exposing the queue to the client-side of the web application
instead sending the images first to the server-side of the web application.</li>
<li>Extract the user registration, authentication and authorization into a
service.</li>
</ul>
</div>
</div>
<div class="section" id="notes">
<h1>Notes</h1>
<table class="docutils footnote" frame="void" id="disagreement" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>Actually one of the main causes of Pyxel being a failure
was I could not make all participants agreed on the requirements.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="retina" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td>Current retina displays would make that thumbnails look like
icons and bandwidth is also more likely to allow very big pictures to be
friendly.</td></tr>
</tbody>
</table>
</div>

        <div class="postmeta">
        
        <div class="categories">
            <span>
                Filed under:
                <a href="categories/architecture.html">architecture</a></span>
        </div>
        <div class="tags">
            <span>
                Tags:
                <a href="tags/memento.html">memento</a></span>
        </div>
        </div>
        <div class="timestamp postmeta">
            <span>April 08, 2015</span>
        </div><div class="separator post_separator"></div><h1><a href="2015/02/18/greenlet-local-python-modules-an-experiment.html">Hot-swapping Python modules. An experiment.</a></h1>
<p>A new project I’m involved with will <em>probably</em> require dozens of servers
running several thousands <a class="reference external" href="https://greenlet.readthedocs.org/en/latest/">greenlets</a> each.  Top-level greenlets represent jobs
and their children will be individual tasks those greenlets are
coordinating/supervising.</p>
<p>This model, however prototypical, resembles that of the <a class="reference external" href="http://www.erlang.org/">OTP</a> in Erlang.  A
greenlet may be either a supervisor or a worker.</p>
<p>But there’s something missing in our platform that Erlang do have and that
might yield huge benefits.  You can change your Erlang code while the program
is running.</p>
<div class="section" id="modulets-the-idea">
<h2>Modulets.  The idea</h2>
<p>I asked myself if I could devise an <em>import mechanism</em> that would allow to
update a Python module in a way that already-running greenlets stay unaffected
but newly created ones use the new code.</p>
<p>To exemplify, let’s say a typical tasks is:</p>
<div class="highlight-default"><div class="highlight"><pre><span/><span class="k">def</span> <span class="nf">receive_confirmation</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">who</span><span class="p">):</span>
   <span class="kn">from</span> <span class="nn">jobs.util.email</span> <span class="k">import</span> <span class="n">send_email</span>
   <span class="kn">from</span> <span class="nn">jobs.util.email</span> <span class="k">import</span> <span class="n">wait_reply</span>
   <span class="c1"># Assume both send_email and wait_reply switch away from the current</span>
   <span class="c1"># greenlet and only switch back after they are done.</span>
   <span class="n">message</span> <span class="o">=</span> <span class="n">send_email</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">who</span><span class="p">)</span>
   <span class="n">res</span> <span class="o">=</span> <span class="n">wait_reply</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
   <span class="k">return</span> <span class="n">res</span>  <span class="c1"># this will be sent to the parent greenlet</span>
</pre></div>
</div>
<p>The servers start and hundreds of this task are launched in different jobs.
Many of them are idle waiting for their replies.  Users are happily getting
their confirmation emails and replying to them (or ignoring them).</p>
<p>However, we start receiving lot of bounces in the postmaster inbox.  Some
users have entered a wrong email address.  A change is in order.</p>
<p>In response, we change our implementation of <span class="docutils literal"><span class="pre">send_email</span></span> so that it does
<a class="reference external" href="http://en.wikipedia.org/wiki/Variable_envelope_return_path">VERP</a> to know which recipients’ address are bouncing, and also create a new
<cite>job</cite> that involves receiving confirmation email when a new user registers.</p>
<p>We’d love to simply update our <span class="docutils literal"><span class="pre">jobs.util</span></span> package and be done with it like
this:</p>
<div class="highlight-default"><div class="highlight"><pre><span/>$ source server-virtual-env/bin/activate
$ pip install -U jobs.util -i https://my.private.server/
</pre></div>
</div>
<p>New jobs will pick up the new version and the older jobs will keep working as
if nothing would have changed.</p>
<p>That would be really nice.  Such a hot-swap of Python modules per job is what
I’m calling a “modulet”.</p>
<p>Currently I have a “working” <strong>yet very experimental and undertested</strong>
implementation of such a mechanism in our <a class="reference external" href="https://github.com/merchise-autrement/xoutil/tree/experimental-modulets/xoutil/modules">experimental modulets branch</a> in
xoutil.</p>
</div>
<div class="section" id="modulets-in-xoutil">
<h2>Modulets in xoutil</h2>
<p>The current implementation is a very early proof of concept and not something
you’d like to put outside your playground.</p>
<p>The file <a class="reference external" href="https://github.com/merchise-autrement/xoutil/blob/experimental-modulets/xoutil/modules/test_modulet.py"><span class="docutils literal"><span class="pre">test_modulet.py</span></span></a> is a simple script you may run to see it working.
It simply creates a temporary module <span class="docutils literal"><span class="pre">magic_module</span></span> that has the
<span class="docutils literal"><span class="pre">get_magic</span></span> function.  This function returns a single value.</p>
<p>The test launches three greenlets that simply call the <span class="docutils literal"><span class="pre">get_magic</span></span> function
and asserts it returns the “right” magic value.  Between launches the module
gets updated to return a different magic value, which is passed as an argument
to the newly created greenlet.</p>
<p>A single run will print something like:</p>
<div class="highlight-default"><div class="highlight"><pre><span/>$ python test_modulet.py
Beginning with 3 in /tmp/tmp1d4rK5
Isolating 'magic_module' as '&lt;greenlet.greenlet object at 0x7f21f4e8daf0&gt;.magic_module'
Isolating 'magic_module' as '&lt;greenlet.greenlet object at 0x7f21f4e8da50&gt;.magic_module'
Isolating 'magic_module' as '&lt;greenlet.greenlet object at 0x7f21f4daa7d0&gt;.magic_module'
Passed. I have the right magic number 1002
Passed. I have the right magic number 1001
Passed. I have the right magic number 1000
</pre></div>
</div>
<p>If you comment the bootstrapping of modulets, then you’ll get something like:</p>
<div class="highlight-default"><div class="highlight"><pre><span/>$ python test_modulet.py
Beginning with 3 in /tmp/tmpeI1oYA
Wrong magic number
Traceback (most recent call last):
  File "test_modulet.py", line 49, in rootprog
    g.switch()
  File "test_modulet.py", line 31, in prog
    assert res == magic, "Expected %d but got %d." % (magic, res)
AssertionError: Expected 1002 but got 1000.
Wrong magic number
Traceback (most recent call last):
  File "test_modulet.py", line 49, in rootprog
    g.switch()
  File "test_modulet.py", line 31, in prog
    assert res == magic, "Expected %d but got %d." % (magic, res)
AssertionError: Expected 1001 but got 1000.
Passed. I have the right magic number 1000
</pre></div>
</div>
</div>
<div class="section" id="future-work">
<h2>Future work</h2>
<p>Since we are at the very early stages of this project is not easy to predict
if we’ll keep modulets in our platform.  Probably a <a class="reference external" href="http://docs.celeryproject.org/en/latest/">celery</a> based solution be
enough.</p>
<p>If we were to keep it, there are several things to improve:</p>
<ul>
<li><p class="first">The current mechanism pollutes the <span class="docutils literal"><span class="pre">sys.modules</span></span> with a copy of a module
per top-level greenlet.</p>
<p>In the current state, this is an ever-growing pile of modules that never
erases those that are no longer used.</p>
<p>This needs to be changed in several ways:</p>
<p>The namespace we use to masquerade the modules need not be (and should not
be) the repr of the greenlet object.</p>
<p>For the purposes of isolating different versions of the same code we can
either use the timestamp of the files, the version of the distribution,
etc...</p>
<p>Running a <a class="reference external" href="http://diesel.io/">diesel</a> server will quickly eat all your RAM unless this is
changed.</p>
<p>When a <a class="reference external" href="https://greenlet.readthedocs.org/en/latest/">greenlet</a> dies the only one informed is its parent.  But we certainly
don’t want jobs to mess with <span class="docutils literal"><span class="pre">sys.modules</span></span> to clean our own mess.</p>
<p>This poses a challenge of its own and may be delegated outside <cite>xoutil</cite>
itself.</p>
<p>That being said, it’s likely that the calculation of the current namespace
and how to dispose of unused modules will be extensions points of
<cite>modulets</cite>.</p>
</li>
<li><p class="first">Currently we have a black-list of modules that will never be isolated.</p>
<p>Changes in those modules will required a restart to be noticed.  Those
modules are platform-level.  They include <cite>xoutil</cite> itself, <cite>greenlet</cite> and
the entire standard library (which is not expected to change unless you
change Python).</p>
<p>We can also allow white-listing.  Both ways are on the table.</p>
<p>The white-list imposes more explicit architecture of your platform since it
requires throughout revision of which modules you’re willing to update on
the run.</p>
<p>Access to both lists will be a public API of the Modulet Manager.  I can
envision a remote-control console you’ll use to include a new module in the
white-list.  But that will be an application of the modulet API and included
in the box.</p>
</li>
</ul>
</div>

        <div class="postmeta">
        
        <div class="categories">
            <span>
                Filed under:
                <a href="categories/python.html">Python</a>, <a href="categories/programming.html">Programming</a></span>
        </div>
        <div class="tags">
            <span>
                Tags:
                <a href="tags/isolation.html">isolation</a>, <a href="tags/erlang.html">erlang</a></span>
        </div>
        </div>
        <div class="timestamp postmeta">
            <span>February 18, 2015</span>
        </div><div class="separator post_separator"></div><h1><a href="2014/12/27/lately.html">What I’ve been doing lately</a></h1>
<p>Lately my work has been mainly driven by the need to efficiently and smoothly
deploy the Accounting module of <a class="reference external" href="http://www.odoo.com/">OpenERP</a> in my employer enterprise.  But at
the same time I’m responsible of several development and deployments in the
enterprise.</p>
<p>The accounting-related tasks have made me to study the accounting module, but
also accounting in general from fundamental principles to advanced topics.  I
currently own a collection of 9 books about accounting.  I still have more
studying to do, but now I’m versed enough to the point of being a (very
junior) accounting consultant to the CEO.  This, of course, should yield
future benefits since I’m planning to start a business.</p>
<p>On the technical side, the last week I was doing a final verification of the
module so that the (true) accountant of the enterprise finally migrates to
OpenERP: Taking our QuickBooks files and, with Pentaho <a class="reference external" href="http://community.pentaho.com/projects/data-integration/">Kettle</a>, migrating the
accounting information to OpenERP, and comparing the legal reports.  This has
finally yielded good results and we’re doing an opening entry to continue
accounting in OpenERP (the enterprise has an accounting period the starts on
Oct, 1st each year).</p>
<p>At the same time a new server for OpenERP and a deployment based on <a class="reference external" href="https://pypi.python.org/pypi/zc.buildout/">Buildout</a>
was another one of my tasks.  There’s still much to be done and I’m wondering
if <a class="reference external" href="https://github.com/ansible/ansible">Ansible</a> would be a good choice to actually manage the deployment since it
involve setting up <a class="reference external" href="http://www.postfix.org/">Postfix</a> as the Mail Transfer Agent interfacing OpenERP for
emails.  This means that besides the accounting books I have reviewed several
email related RFCs (<a class="reference external" href="http://tools.ietf.org/html/rfc2822">2822</a>, <a class="reference external" href="http://tools.ietf.org/html/rfc2821">2821</a> and <a class="reference external" href="http://tools.ietf.org/html/rfc2476">2476</a> being those I’ve read the most) and
the Postfix documentation.</p>
<p>To fill the gaps, or more precisely: to take breaks from these topics I’m
reading a couple of books and articles:</p>
<ul class="simple">
<li>High Performance Browser Networking by Ilya Grigorik.</li>
<li><a class="reference external" href="http://book.mixu.net/distsys/ebook.html">Distributed Systems</a></li>
<li>The <a class="reference external" href="https://hal.inria.fr/inria-00555588">report about Convergent and Commutative Replicated Data Types</a> of
Marc Shapiro and others.  RR-7506, pp. 50 &lt;inria-00555588&gt;.</li>
<li>And for fun, the last book of the Rama saga of Arthur Clark and Gentry Lee.
Which BTW I’ve only truly enjoyed the first book.</li>
</ul>
<div class="section" id="things-left-in-the-attic">
<h2>Things left in the attic</h2>
<p>At the beginning of 2014 I expected I could dedicate myself to finish
<a class="reference external" href="https://github.com/merchise-autrement/xotl.ql">xotl.ql</a> by August.  This was, however, not possible.  I still keep my eye
on the topic from time to time, but this needs a lot of time to actually make
a breakthrough.</p>
</div>

        <div class="postmeta">
        
        
        
        </div>
        <div class="timestamp postmeta">
            <span>December 27, 2014</span>
        </div><div class="separator post_separator"></div><h1><a href="2014/12/09/apples-and-oranges.html">Apples and Oranges.  How books can mislead our thinking process.</a></h1>
<p>I’ve just began to read the book “Twisted Network Programming”... <a class="reference external" href="http://www.twistedmatrix.com/">Twisted</a> is
a popular framework for networking programming.  However, I’d probably skim
most of the Book.  I’m sorry... But as it happens, in the second page of the
second chapter (the one that I began with) they show an illustration on
“Comparing single-threaded, multithreaded, and event-driven program flow”.</p>
<p>Hum... <a class="reference external" href="http://en.wikipedia.org/wiki/Apples_and_oranges">apples and oranges</a>.  I mean the thread model of a program will have
some impact on how events are dealt with, but are they truly comparable or the
sole responsibles for the program flow?</p>
<p><a class="reference external" href="http://diesel.io/">Diesel</a> is usually ran in a single thread and so is <a class="reference external" href="http://www.tornadoweb.org/">Tornado</a>.  You may, of
course, run programs written with them in multiple processes (or threads) to
avoid contention when the volume of clients (events) is too high.</p>
<p>Even with a single thread most of the time the system is waiting for the IO
buffers to have data, so they can be classified as event-driven: They actually
response to events.</p>
<p>But what really bothers about this illustration is not that it compare two
thing that could be (and should be made) complementary.  What bothers me is
that the picture tries to fool me by showing that event-driven programs don’t
have any “gaps” of idle time between tasks, while the threaded models do.  And
that’s simply dishonest.</p>
<p>Probably this is not what the authors meant, and I’m probably going prejudiced
just because of this wrong picture. However, I go to a book like this not for
pleasure but for information.  Finding a piece of data that is not trustworthy
raises a flag and I start to read with a magnifying glass... And that’s not
fun either.</p>
<p>Don’t expect me to finish this book.</p>
<p class="rubric">Update of a couple of hours later...</p>
<p>A few lines below the illustration of matters, they actually say:</p>
<blockquote>
<div>“The event-driven version of the program interleaves the execution of the
three tasks, but in a single thread of control.”</div></blockquote>
<p>So, let’s give it another try.</p>

        <div class="postmeta">
        
        <div class="categories">
            <span>
                Filed under:
                <a href="categories/book-reviews.html">Book Reviews</a></span>
        </div>
        
        </div>
        <div class="timestamp postmeta">
            <span>December 09, 2014</span>
        </div><div class="separator post_separator"></div><h1><a href="2014/08/28/reviewing-openerp-8-0.html">Reviewing Odoo 8.0</a></h1>
<p>This is the first of a series of blog posts related to the next OpenERP 8.0
(or should I say Odoo 8.0).  This first post will be very “seeking for
orientation” on major new features and changes.  Don’t expect anything to be
deeply commented or analyzed.</p>
<p>I will probably devote several posts for changes in some modules, but in this
one I’ll just write about things that can be immediately seen when you first
install it.</p>
<div class="section" id="installing-odoo-8-0">
<h2>Installing Odoo 8.0</h2>
<p>I’m working with a clone from the now official <a class="reference external" href="https://github.com/odoo/odoo">github.com odoo repository</a>.
Of course I’m using the branch “8.0” for this review.</p>
<p>I prepared a <a class="reference external" href="https://pypi.python.org/pypi/virtualenv">virtual environment</a> and installed odoo there like this:</p>
<div class="highlight-default"><div class="highlight"><pre><span/>$ python setup.py develop
</pre></div>
</div>
<p>The first I noticed is that several new requirements are in place, and the
<cite>pyPdf</cite> requirement had been forgotten.</p>
<p>Second thing noticed is that unlike the “7.0” you don’t need to run the
<span class="docutils literal"><span class="pre">openerp-server</span></span> script passing the <span class="docutils literal"><span class="pre">--addons-path=./addons</span></span>.  In 8.0 they
include this path automatically.  So running <span class="docutils literal"><span class="pre">./openerp-server</span></span> is enough.</p>
<p>Also the <span class="docutils literal"><span class="pre">python</span> <span class="pre">setup.py</span> <span class="pre">sdist</span></span> command includes this path as well, so a
properly built distribution from source seems more doable.  I haven’t tried
this yet, but I will, cause that was for sure something missing in 7.0.  It’s
quite suspicious that the tarball is too small (around 13MB) though.</p>
</div>
<div class="section" id="new-addons">
<h2>New addons</h2>
<div class="section" id="instant-messaging">
<h3>Instant Messaging</h3>
<p>Once I ran the server I installed a demo DB to see what’s new.  The first
thing that captured my attention was an “Instant Messaging” module.  I gave it
a try and it seemed to work out-of-box.</p>
<p>It uses the quite old <a class="reference external" href="http://stackoverflow.com/questions/11077857/what-are-long-polling-websockets-server-sent-events-sse-and-comet">long polling</a> technique instead of the brand new
<a class="reference external" href="http://en.wikipedia.org/wiki/HTML5">HTML5</a>  <a class="reference external" href="http://en.wikipedia.org/wiki/Server-sent_events">Server-Sent Events</a> (SSE) stuff.  Why?</p>
<p>My first guess was that multi-process deployments would need to pass messages
around between the HTTP processes.  That requires a kind of Inter-Processes
Communication (IPC).  Popular choices for achieving this in web applications
are <a class="reference external" href="http://redis.io/">Redis</a> and <a class="reference external" href="http://www.rabbitmq.com/">RabbitMQ</a>, but then you’d need to setup either for this to
work.</p>
<p>After thinking in this a bit more (actually the thinking about this occurred
at the same time I was writing this post) I realized that the <em>current</em>
multi-process deployments would still need this IPC to properly work.  So I
ran <span class="docutils literal"><span class="pre">./openerp-server</span> <span class="pre">--workers=2</span></span> and tested it again.  The chat stopped to
work and the following error was logged from time to time:</p>
<div class="highlight-traceback"><div class="highlight"><pre><span/>2014-08-27 22:53:48,972 17858 ERROR o8 openerp.http: Exception during JSON request handling.
Traceback (most recent call last):
  File "/&lt;..&gt;/odoo/openerp/http.py", line 476, in _handle_exception
    return super(JsonRequest, self)._handle_exception(exception)
  File "/&lt;..&gt;/odoo/openerp/http.py", line 495, in dispatch
    result = self._call_function(**self.params)
  File "/&lt;..&gt;/odoo/openerp/http.py", line 311, in _call_function
    return checked_call(self.db, *args, **kwargs)
  File "/&lt;..&gt;/odoo/openerp/service/model.py", line 113, in wrapper
    return f(dbname, *args, **kwargs)
  File "/&lt;..&gt;/odoo/openerp/http.py", line 308, in checked_call
    return self.endpoint(*a, **kw)
  File "/&lt;..&gt;/odoo/openerp/http.py", line 685, in __call__
    return self.method(*args, **kw)
  File "/&lt;..&gt;/odoo/openerp/http.py", line 360, in response_wrap
    response = f(*args, **kw)
  File "/&lt;..&gt;/odoo/addons/bus/bus.py", line 188, in poll
    raise Exception("bus.Bus unavailable")
Exception: bus.Bus unavailable
</pre></div>
</div>
<p>The code explains it all.  This is the method <span class="docutils literal"><span class="pre">ImDispatch.start()</span></span> in file
<span class="docutils literal"><span class="pre">addons/bus/bus.py</span></span>:</p>
<div class="highlight-python"><div class="highlight"><pre><span/><span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">openerp</span><span class="o">.</span><span class="n">evented</span><span class="p">:</span>
        <span class="c1"># gevent mode</span>
        <span class="kn">import</span> <span class="nn">gevent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Event</span> <span class="o">=</span> <span class="n">gevent</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">Event</span>
        <span class="n">gevent</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">openerp</span><span class="o">.</span><span class="n">multi_process</span><span class="p">:</span>
<span class="hll">        <span class="c1"># disabled in prefork mode</span>
</span>        <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># threaded mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Event</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"</span><span class="si">%s</span><span class="s2">.Bus"</span> <span class="o">%</span> <span class="n">__name__</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span>
</pre></div>
</div>
<p>The highlighted line says this won’t work in a multi-process deployment.  How
do you get to use the <cite>evented</cite> mode, I don’t know.  Probably that’s the
default now.</p>
<p>So I need to review this feature more closely before going to production.
It’s a nice addition though.</p>
<p>I found they have now a <a class="reference external" href="https://github.com/odoo/odoo/blob/master/openerp/service/server.py#L321"><span class="docutils literal"><span class="pre">GeventServer</span></span></a> for long polling connections.  And the
implementation of the Instant Messaging Bus (<a class="reference external" href="https://github.com/odoo/odoo/blob/master/openerp/addons/bus/bus.py">bus.py</a>) can be easily adapted
for desktop-like notifications, updating your message inbox, and many other
features that would benefit from this.</p>
</div>
<div class="section" id="messaging-has-gone-a-bit-different">
<h3>Messaging has gone a bit different</h3>
<p>At this point I tried to send a message from a user to another (to test if the
inbox was updated real-time) and realized that the Messaging addons has lost
the “compose a new message” that was previously accessible from the inbox, let
me show you a picture (7.0 on the right, 8.0 on the left):</p>
<div class="figure" id="id2">
<img alt="../../../_images/odoo-vs-openerp.png" src="_images/odoo-vs-openerp.png"/>
<p class="caption"><span class="caption-text">Odoo is missing the “Compose new message” button.</span></p>
</div>
<p>This commit has some explanation:</p>
<div class="highlight-default"><div class="highlight"><pre><span/><span class="n">commit</span> <span class="mi">0714</span><span class="n">b231646bb439b121a6aaa43df32fedcb5e6e</span>
<span class="n">Author</span><span class="p">:</span> <span class="n">Thibault</span> <span class="n">Delavallée</span> <span class="o">&lt;</span><span class="n">tde</span><span class="nd">@openerp</span><span class="o">.</span><span class="n">com</span><span class="o">&gt;</span>
<span class="n">Date</span><span class="p">:</span>   <span class="n">Wed</span> <span class="n">Aug</span> <span class="mi">13</span> <span class="mi">14</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">25</span> <span class="mi">2014</span> <span class="o">+</span><span class="mi">0200</span>

<span class="p">[</span><span class="n">FIX</span><span class="p">]</span> <span class="n">mail</span><span class="p">:</span> <span class="n">when</span> <span class="n">having</span> <span class="n">only</span> <span class="n">mail</span> <span class="n">installed</span><span class="p">,</span> <span class="n">do</span> <span class="ow">not</span> <span class="n">show</span> <span class="nb">any</span> <span class="s1">'share with my</span>
<span class="n">followers</span><span class="s1">' compose box. This comes only with hr, for the inbox. This was</span>
<span class="n">probably</span> <span class="n">forgotten</span> <span class="n">when</span> <span class="n">updating</span> <span class="n">the</span> <span class="n">mailboxes</span> <span class="n">hr</span><span class="o">-</span><span class="n">goal</span> <span class="ow">and</span> <span class="n">hr</span><span class="o">-</span><span class="n">related</span>
<span class="n">gamification</span> <span class="o">/</span> <span class="n">chatter</span> <span class="n">stuff</span><span class="o">.</span>
</pre></div>
</div>
<p>I then installed the “Employee directory” addon and the “Share with my
followers” box appeared.</p>
<p>More digging in the logs reveals the following:</p>
<div class="highlight-default"><div class="highlight"><pre><span/><span class="n">commit</span> <span class="n">e6f8666b521fe8c2522d6e94c0c3def54a5f73ed</span>
<span class="n">Merge</span><span class="p">:</span> <span class="n">d57a97d</span> <span class="n">bf3d4a7</span>
<span class="n">Author</span><span class="p">:</span> <span class="n">Amit</span> <span class="n">Vora</span> <span class="o">&lt;</span><span class="n">avo</span><span class="nd">@tinyerp</span><span class="o">.</span><span class="n">com</span><span class="o">&gt;</span>
<span class="n">Date</span><span class="p">:</span>   <span class="n">Thu</span> <span class="n">Apr</span> <span class="mi">17</span> <span class="mi">11</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">33</span> <span class="mi">2014</span> <span class="o">+</span><span class="mi">0200</span>

<span class="p">[</span><span class="n">MERGE</span><span class="p">]</span> <span class="p">[</span><span class="n">IMP</span><span class="p">]</span> <span class="n">mail</span><span class="p">:</span> <span class="n">Inbox</span> <span class="n">usability</span> <span class="n">improvements</span> <span class="p">:</span>
<span class="o">-</span> <span class="n">notficiation_email_send</span> <span class="n">field</span><span class="p">,</span> <span class="n">renamed</span> <span class="n">into</span> <span class="n">notify_email</span><span class="p">,</span> <span class="n">has</span> <span class="n">now</span> <span class="mi">2</span> <span class="n">values</span><span class="p">:</span> <span class="n">always</span> <span class="ow">or</span> <span class="n">never</span><span class="p">,</span> <span class="ow">in</span>
<span class="n">order</span> <span class="n">to</span> <span class="n">ease</span> <span class="n">the</span> <span class="n">choice</span> <span class="ow">and</span> <span class="n">simplify</span> <span class="n">options</span><span class="o">.</span>
<span class="o">-</span> <span class="n">inbox</span><span class="p">:</span> <span class="n">removed</span> <span class="s1">'compose a new messages or write to my followers'</span><span class="p">,</span> <span class="n">because</span> <span class="n">those</span> <span class="mi">2</span> <span class="n">options</span> <span class="n">are</span>
<span class="n">already</span> <span class="n">available</span><span class="o">.</span> <span class="n">The</span> <span class="n">first</span> <span class="n">one</span> <span class="ow">is</span> <span class="n">accessible</span> <span class="n">using</span> <span class="n">the</span> <span class="n">top</span><span class="o">-</span><span class="n">right</span> <span class="n">email</span> <span class="n">icon</span><span class="p">,</span> <span class="n">the</span> <span class="n">second</span> <span class="n">one</span>
<span class="ow">is</span> <span class="n">accessible</span> <span class="k">with</span> <span class="n">the</span> <span class="s1">'write to my followers'</span> <span class="n">text</span> <span class="n">box</span> <span class="n">alread</span> <span class="n">present</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">inbox</span><span class="o">.</span>
</pre></div>
</div>
<p>However I don’t see the mentioned “top-right email icon”.  In fact, that icon
is present in 7.0, but not in 8.0.  More digging:</p>
<div class="highlight-default"><div class="highlight"><pre><span/><span class="n">commit</span> <span class="mi">5209</span><span class="n">fbc7ed9fcad966ab064654a8a8697142be42</span>
<span class="n">Author</span><span class="p">:</span> <span class="n">Antony</span> <span class="n">Lesuisse</span> <span class="o">&lt;</span><span class="n">al</span><span class="nd">@openerp</span><span class="o">.</span><span class="n">com</span><span class="o">&gt;</span>
<span class="n">Date</span><span class="p">:</span>   <span class="n">Mon</span> <span class="n">Jun</span> <span class="mi">30</span> <span class="mi">01</span><span class="p">:</span><span class="mi">51</span><span class="p">:</span><span class="mi">40</span> <span class="mi">2014</span> <span class="o">+</span><span class="mi">0200</span>

<span class="p">[</span><span class="n">REM</span><span class="p">]</span> <span class="n">useless</span> <span class="n">icon</span> <span class="n">send</span> <span class="n">a</span> <span class="n">message</span>

<span class="n">The</span> <span class="n">action</span> <span class="ow">is</span> <span class="n">available</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">wall</span><span class="o">.</span>
</pre></div>
</div>
<p>Got you!  So, Antony removed the icon cause he thought it was the wall, but
Amit had removed it from the wall cause because of the icon.  These things
happen...</p>
<p>After reverting this commit, the icon is reestablished.  But, then I realized
that the feature, however hidden, is actually there: If you click on the
“Share with ...” and instead of writing your message there, click on the
“expand” icon, then you get the same as pressing the (now missing) email icon.
I think that the icon is required, though, since now the “Share...” box is not
shown until HR is installed, and the email icon allows to send email to
outsiders.  My current employer is willing to remove email in favor of this
messaging module.  This may hold him back.</p>
<p>I’m <a class="reference external" href="https://github.com/odoo/odoo/issues/2042">raising my hand to vote</a> for the rescue of (at least) the icon.
Redundancy is not always bad when it comes to user interface.</p>
<p>This enough for this post.  I’ll keep looking at Odoo and I’ll write about it.</p>
</div>
</div>

        <div class="postmeta">
        
        <div class="categories">
            <span>
                Filed under:
                <a href="categories/openerp.html">OpenERP</a>, <a href="categories/odoo.html">Odoo</a></span>
        </div>
        <div class="tags">
            <span>
                Tags:
                <a href="tags/review.html">review</a></span>
        </div>
        </div>
        <div class="timestamp postmeta">
            <span>August 28, 2014</span>
        </div><div class="archive_link">
        <a href="archive.html"> &mdash; Blog Archive &mdash; </a>
    </div><ul class="related clearfix">
            <li class="left"></li>
            <li class="right"><a href="page2.html">Older</a> &raquo; </li>
        </ul></article>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'mvaled-io';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the
      <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript><aside class="sidebar"></aside></div> <!-- #main --></div> <!-- #main-container -->

        <div class="footer-container" role="contentinfo"><footer class="wrapper"><p>
      &copy; Copyright 2016, Manuel Vázquez Acosta. </p>
      <p>Content licensed under the Creative Commons
      attribution-noncommercial-sharealike License.
      </p></footer></div> <!-- footer-container -->

      </div> <!--! end of #container --><!--[if lt IE 7 ]>
          <script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
          <script>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script>
        <![endif]-->
    </body>
</html>