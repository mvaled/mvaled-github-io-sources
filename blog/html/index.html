<!DOCTYPE html><!--[if lt IE 7]>      <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="description" content="Blog mostly about software.">
        <meta name="viewport" content="width=device-width">
        <title>Home &mdash; Manuel on Software - Reloaded</title>
            <link rel="stylesheet" href="_static/normalize.css" type="text/css">
            <link rel="stylesheet" href="_static/sphinx.css" type="text/css">
            <link rel="stylesheet" href="_static/main.css" type="text/css">
            <link rel="stylesheet" href="_static/mva.css" type="text/css">
            <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
            <link rel="stylesheet" href="_static/font-awesome.min.css" type="text/css">
        <!-- Load modernizr and JQuery -->
<script src="_static/vendor/modernizr-2.6.2.min.js"></script>
<script src="_static/vendor/jquery-1.8.2.min.js"></script>
<script src="_static/plugins.js"></script>
<script src="_static/main.js"></script>
<link rel="search" title="Search" href="search.html" /><link rel="next" title="Older" href="page2.html" /><link rel="alternate" type="application/rss+xml" title="RSS" href="rss.html" /><script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.7.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        SOURCELINK_SUFFIX: '.txt',
        HAS_SOURCE:  true
      };
    </script><script type="text/javascript" src="_static/underscore.js"></script><script type="text/javascript" src="_static/doctools.js"></script><script type="text/javascript" src="_static/language_data.js"></script>

    <script type="text/javascript">
        $(document).ready(function () {
            // Scroll to content if on small screen
            if (screen.width < 480)
            {
                $(document).scrollTop(document.getElementsByTagName("article")[0].offsetTop - 44);
            }
        });
    </script>
    <!-- link rel='stylesheet' id='open-sans-css'  href='//fonts.googleapis.com/css?family=Open+Sans%3A300italic%2C400italic%2C600italic%2C300%2C400%2C600&#038;subset=latin%2Clatin-ext&#038;ver=4.0-alpha' type='text/css' media='all' / -->
    <!-- link rel='stylesheet' id='syntax-merriweather-css'  href='http://fonts.googleapis.com/css?family=Merriweather%3A400%2C300%2C300italic%2C400italic%2C700%2C700italic&#038;ver=4.0-alpha' type='text/css' media='all' / --></head>
    <body role="document">
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

      <div id="container"><header role="banner">
            <hgroup>
              <h1><a href="#">Manuel on Software - Reloaded</a></h1></hgroup>
          </header>
      <!--    <h1 id="toggle-nav" class="menu-toggle">
      <span class="screen-reader-text">Menu</span></h1>
    <nav role="navigation">
      <ul>
        <li class="main-nav">
          <a href="#">Home</a>
        </li>
        <li class="main-nav">
          <a href="pages/about-this.html">About this</a>
        </li>
        </ul>
    </nav> --><div class="main-container" role="main"><div class="main wrapper body clearfix"><article><h1><a href="2019/11/18/performance-of-python-list-comprehensions.html">Why does creating a list comprehension is faster?<a class="headerlink" href="#why-does-creating-a-list-comprehension-is-faster" title="Permalink to this headline">¶</a></a></h1>
<p>Yesterday, I was removing a list-comprehension as an argument to <a class="reference external" href="https://docs.python.org/3.6/library/functions.html#sum" title="(in Python v3.6)"><span class="xref py py-func docutils literal"><span class="pre">sum()</span></span></a>.
This is the diff:</p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span/><span class="gd">- sum([p.price for p in self.products])</span>
<span class="gi">+ sum(p.price for p in self.products)</span>
</pre></div>
</div>
<p>To show the original programmer my line of though I performed a little
experiment with the following message and code:</p>
<p>List comprehensions as an argument to <em>reduce-like</em> functions are usually less
efficient than using the generation expression itself.  The reason is that
Python creates the list just to (afterwards) discard it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">fib</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
<span class="gp">... </span>    <span class="k">while</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
<span class="gp">... </span>        <span class="k">yield</span> <span class="n">a</span>
<span class="gp">... </span>        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
<span class="gp">...</span>

<span class="gp">&gt;&gt;&gt; </span><span class="o">%</span><span class="n">timeit</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fib</span><span class="p">(</span><span class="mi">100</span><span class="p">)])</span>
<span class="go">2.61 µs ± 33 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="o">%</span><span class="n">timeit</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fib</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
<span class="go">3.13 µs ± 18.6 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)</span>
</pre></div>
</div>
<p>As was surprised to see that the list comprehension was a little bit faster
than the generator expression.  So it seems that for short-enough lists, the
implementation of <a class="reference external" href="https://docs.python.org/3.6/library/functions.html#sum" title="(in Python v3.6)"><span class="xref py py-func docutils literal"><span class="pre">sum()</span></span></a> is quite fast.</p>
<p>I had to change the implementation of <cite>fib</cite> to control the amount of items to
show my point:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">fib</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
<span class="gp">... </span>    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">yield</span> <span class="n">a</span>
<span class="gp">... </span>        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
</pre></div>
</div>
<p>An still with 100 items, passing a list is faster:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/><span class="gp">&gt;&gt;&gt; </span><span class="o">%</span><span class="n">timeit</span> <span class="nb">sum</span><span class="p">(</span><span class="n">fib</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
<span class="go">14.2 µs ± 212 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="o">%</span><span class="n">timeit</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">fib</span><span class="p">(</span><span class="mi">100</span><span class="p">)))</span>
<span class="go">16.4 µs ± 247 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="o">%</span><span class="n">timeit</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fib</span><span class="p">(</span><span class="mi">100</span><span class="p">)])</span>
<span class="go">18 µs ± 160 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)</span>
</pre></div>
</div>
<p>Of course the differences are too small to draw final conclusions.  And, of
course, as the list grows larger it becomes slower:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/><span class="gp">&gt;&gt;&gt; </span><span class="o">%</span><span class="n">timeit</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fib</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">5</span><span class="p">)])</span>
<span class="go">497 ms ± 84.4 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="o">%</span><span class="n">timeit</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fib</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">5</span><span class="p">))</span>
<span class="go">329 ms ± 17.3 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</span>
</pre></div>
</div>
<p>So I think I still prefer the version using the generation expression just to
cover my self from the case where there are too many items to be held in
memory.</p>
<p>(I didn’t push the commit, though.)</p>

        <div class="postmeta">
        
        <div class="categories">
            <span>
                Filed under:
                <a href="categories/programming.html">Programming</a></span>
        </div>
        <div class="tags">
            <span>
                Tags:
                <a href="tags/performance.html">Performance</a>, <a href="tags/python.html">Python</a></span>
        </div>
        </div>
        <div class="timestamp postmeta">
            <span>November 18, 2019</span>
        </div><div class="separator post_separator"></div><h1><a href="2018/08/01/composing-iterator-returning-functions.html">Composing iterator-returning functions<a class="headerlink" href="#composing-iterator-returning-functions" title="Permalink to this headline">¶</a></a></h1>
<p>A few days ago I was reviewing a piece of Python code.  I was looking for a
bug, but in the process I found a very interesting function.</p>
<p>The system allows the user to “extend” the structure of Products by providing
more attributes which can be used later on when creating Sale (or Purchase)
Orders.  The Product object is like a class defining the structure, and the
items in Orders are the instances of such classes.</p>
<p>When trying to export a full catalog, each attribute implies a new row in the
spreadsheet file.  To avoid too much coupling, this process was modeled by a
kind of seeded generation of every possible row.  The algorithm started with a
seed instance of a product without any attribute, and then it generated every
possible attribute-complete instance by <em>composing</em> several functions that
took a instance and returned a iterator of instances.  Each function deals
with a specific type of attribute, and simply copies those attributes in the
instances being generated.</p>
<p>The function doing the generation of all possible instance was more or less
like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span/><span class="k">def</span> <span class="nf">iter_product</span><span class="p">(</span><span class="n">initial</span><span class="p">,</span> <span class="o">*</span><span class="n">funcs</span><span class="p">):</span>
   <span class="k">if</span> <span class="ow">not</span> <span class="n">funcs</span><span class="p">:</span>
      <span class="k">yield</span> <span class="n">initial</span>
   <span class="k">else</span><span class="p">:</span>
      <span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">fs</span> <span class="o">=</span> <span class="n">funcs</span>
      <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">f</span><span class="p">(</span><span class="n">initial</span><span class="p">):</span>
         <span class="k">yield from</span> <span class="n">iter_product</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">fs</span><span class="p">)</span>
</pre></div>
</div>
<p>That definition was OK, but I wondered if I could build just the <em>composition</em>
of several functions returning iterators, so that I can reuse it with several
initial objects.</p>
<div class="section" id="a-little-incursion-in-haskell">
<h2>A little incursion in Haskell<a class="headerlink" href="#a-little-incursion-in-haskell" title="Permalink to this headline">¶</a></h2>
<p>In order to test my Haskell, I did first a Haskell version.  I started by
trying to create a <em>composition</em> operator much like the <span class="docutils literal"><span class="pre">(.)</span></span> operator,
which has type:</p>
<div class="highlight-Haskell notranslate"><div class="highlight"><pre><span/><span class="p">(</span><span class="o">.</span><span class="p">)</span> <span class="ow">::</span> <span class="p">(</span><span class="n">b</span> <span class="ow">-&gt;</span> <span class="n">c</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">b</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">c</span>
</pre></div>
</div>
<p>The type of our composition of iterator-returning functions would be:</p>
<div class="highlight-Haskell notranslate"><div class="highlight"><pre><span/><span class="kr">infixr</span> <span class="mi">9</span> <span class="o">&gt;&gt;.</span>
<span class="p">(</span><span class="o">&gt;&gt;.</span><span class="p">)</span> <span class="ow">::</span> <span class="p">(</span><span class="n">b</span> <span class="ow">-&gt;</span> <span class="p">[</span><span class="n">c</span><span class="p">])</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="p">[</span><span class="n">b</span><span class="p">])</span> <span class="ow">-&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="p">[</span><span class="n">c</span><span class="p">]</span>
</pre></div>
</div>
<p>The choice of <span class="docutils literal"><span class="pre">(&gt;&gt;.)</span></span> as the operator will become (I hope) evident.  The
most straightforward implementation and easy to understand is using the
list-comprehension syntax:</p>
<div class="highlight-Haskell notranslate"><div class="highlight"><pre><span/><span class="nf">g</span> <span class="o">&gt;&gt;.</span> <span class="n">f</span> <span class="ow">=</span> <span class="nf">\</span><span class="n">x</span> <span class="ow">-&gt;</span> <span class="p">[</span><span class="n">z</span><span class="o">|</span> <span class="n">y</span> <span class="ow">&lt;-</span> <span class="n">f</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span> <span class="ow">&lt;-</span> <span class="n">g</span> <span class="n">y</span><span class="p">]</span>
</pre></div>
</div>
<p>Can we generalize this?  Yes! The list is an instance of a <a class="reference external" href="http://book.realworldhaskell.org/read/monads.html">Monad</a>, defined as:</p>
<div class="highlight-Haskell notranslate"><div class="highlight"><pre><span/><span class="kr">instance</span> <span class="kt">Monad</span> <span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="kr">where</span>
    <span class="n">return</span> <span class="n">x</span> <span class="ow">=</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span>
    <span class="n">m</span> <span class="o">&gt;&gt;=</span> <span class="n">f</span>  <span class="ow">=</span> <span class="n">concat</span> <span class="p">(</span><span class="n">map</span> <span class="n">f</span> <span class="n">m</span><span class="p">)</span>
</pre></div>
</div>
<p>And list comprehensions can be easily rewritten using the <span class="docutils literal"><span class="pre">do</span></span> notation:</p>
<div class="highlight-Haskell notranslate"><div class="highlight"><pre><span/><span class="p">(</span><span class="o">&gt;&gt;.</span><span class="p">)</span> <span class="ow">::</span> <span class="kt">Monad</span> <span class="n">m</span> <span class="ow">=&gt;</span> <span class="p">(</span><span class="n">b</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="n">c</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="n">b</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="n">c</span>
<span class="nf">g</span> <span class="o">&gt;&gt;.</span> <span class="n">f</span> <span class="ow">=</span> <span class="nf">\</span><span class="n">x</span> <span class="ow">-&gt;</span> <span class="kr">do</span><span class="p">{</span><span class="n">y</span> <span class="ow">&lt;-</span> <span class="n">f</span> <span class="n">x</span><span class="p">;</span> <span class="n">z</span> <span class="ow">&lt;-</span> <span class="n">g</span> <span class="n">y</span><span class="p">;</span> <span class="n">return</span> <span class="n">z</span><span class="p">}</span>
</pre></div>
</div>
<p>The monadic <span class="docutils literal"><span class="pre">&gt;&gt;=</span></span> operator is usually called the <em>bind</em>.  It’s type is</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/><span class="n">Monad</span> <span class="n">m</span> <span class="o">=&gt;</span> <span class="n">m</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">m</span> <span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">m</span> <span class="n">b</span>
</pre></div>
</div>
<p>So, I think there’s a compact way to write our <span class="docutils literal"><span class="pre">&gt;&gt;.</span></span> operator.  And, now you
may start to see why I chose <span class="docutils literal"><span class="pre">&gt;&gt;.</span></span>.</p>
<p>The do notation is just syntax-sugar over using <span class="docutils literal"><span class="pre">&gt;&gt;=</span></span> (or its brother
<span class="docutils literal"><span class="pre">&gt;&gt;</span></span>).  The rules are given <a class="reference external" href="http://book.realworldhaskell.org/read/monads.html#monads.do">here</a>.  So let’s transform our implementation.
We start we our current definition:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/>\<span class="n">x</span> <span class="o">-&gt;</span> <span class="n">do</span> <span class="p">{</span><span class="n">y</span> <span class="o">&lt;-</span> <span class="n">f</span> <span class="n">x</span><span class="p">;</span> <span class="n">z</span> <span class="o">&lt;-</span> <span class="n">g</span> <span class="n">y</span><span class="p">;</span> <span class="k">return</span> <span class="n">z</span><span class="p">}</span>
</pre></div>
</div>
<p>And rewrite the <span class="docutils literal"><span class="pre">do</span></span> two times until there are no more:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/>\<span class="n">x</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="n">s1</span> <span class="n">y</span> <span class="o">=</span> <span class="n">do</span> <span class="p">{</span><span class="n">z</span> <span class="o">&lt;-</span> <span class="n">g</span> <span class="n">y</span><span class="p">;</span> <span class="k">return</span> <span class="n">z</span><span class="p">}</span> <span class="ow">in</span> <span class="n">f</span> <span class="n">x</span> <span class="o">&gt;&gt;=</span> <span class="n">s1</span>

\<span class="n">x</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="n">s1</span> <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">let</span> <span class="n">s2</span> <span class="n">z</span> <span class="o">=</span> <span class="k">return</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">g</span> <span class="n">y</span> <span class="o">&gt;&gt;=</span> <span class="n">s2</span><span class="p">)</span> <span class="ow">in</span> <span class="n">f</span> <span class="n">x</span> <span class="o">&gt;&gt;=</span> <span class="n">s1</span>
</pre></div>
</div>
<p>Now, we can recall the <a class="reference external" href="https://wiki.haskell.org/Eta_conversion">eta-conversion rule</a> and see that <span class="docutils literal"><span class="pre">s2</span> <span class="pre">=</span> <span class="pre">return</span></span>,
so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/>\<span class="n">x</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="n">s1</span> <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">g</span> <span class="n">y</span> <span class="o">&gt;&gt;=</span> <span class="k">return</span><span class="p">)</span> <span class="ow">in</span> <span class="n">f</span> <span class="n">x</span> <span class="o">&gt;&gt;=</span> <span class="n">s1</span>
</pre></div>
</div>
<p>Now we can use the monadic “law” that states the <span class="docutils literal"><span class="pre">m</span> <span class="pre">&gt;&gt;=</span> <span class="pre">return</span></span> must be
equivalent to <span class="docutils literal"><span class="pre">m</span></span>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/>\<span class="n">x</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="n">s1</span> <span class="n">y</span> <span class="o">=</span> <span class="n">g</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">f</span> <span class="n">x</span> <span class="o">&gt;&gt;=</span> <span class="n">s1</span>
</pre></div>
</div>
<p>And, once more, the eta-conversion help us to remove the <cite>let</cite>, because
<span class="docutils literal"><span class="pre">s1 ==</span> <span class="pre">g</span></span>.  Thus we get:</p>
<div class="highlight-Haskell notranslate"><div class="highlight"><pre><span/><span class="p">(</span><span class="o">&gt;&gt;.</span><span class="p">)</span>  <span class="ow">::</span> <span class="kt">Monad</span> <span class="n">m</span> <span class="ow">=&gt;</span> <span class="p">(</span><span class="n">b</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="n">c</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="n">b</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="n">c</span>
<span class="nf">g</span> <span class="o">&gt;&gt;.</span> <span class="n">f</span> <span class="ow">=</span> <span class="nf">\</span><span class="n">x</span> <span class="ow">-&gt;</span> <span class="n">f</span> <span class="n">x</span> <span class="o">&gt;&gt;=</span> <span class="n">g</span>
</pre></div>
</div>
<p>This is as good as I was able to get.  Since we’re using <span class="docutils literal"><span class="pre">&gt;&gt;=</span></span>, I think this
is the best we can get (i.e. we can’t generalize to <a class="reference external" href="https://wiki.haskell.org/Applicative_functor">Applicative</a>).</p>
</div>
<div class="section" id="chaining-several-iterator-returning-functions">
<h2>Chaining several iterator-returning functions<a class="headerlink" href="#chaining-several-iterator-returning-functions" title="Permalink to this headline">¶</a></h2>
<p>Now, I can define a <span class="docutils literal"><span class="pre">chain</span></span> function.  It takes a list of several
<span class="docutils literal"><span class="pre">a -&gt; m a</span></span> functions and compose them together (from right to left, as
expected):</p>
<div class="highlight-Haskell notranslate"><div class="highlight"><pre><span/><span class="nf">chain</span> <span class="ow">::</span> <span class="kt">Monad</span> <span class="n">m</span> <span class="ow">=&gt;</span> <span class="p">[</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="n">a</span><span class="p">]</span> <span class="ow">-&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="n">a</span>
</pre></div>
</div>
<p>My first attempt was:</p>
<div class="highlight-Haskell notranslate"><div class="highlight"><pre><span/><span class="nf">chain</span> <span class="ow">::</span> <span class="kt">Monad</span> <span class="n">m</span> <span class="ow">=&gt;</span> <span class="p">[</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="n">a</span><span class="p">]</span> <span class="ow">-&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="n">a</span>
<span class="nf">chain</span> <span class="kt">[]</span>  <span class="ow">=</span> <span class="n">return</span>
<span class="nf">chain</span> <span class="p">(</span><span class="n">f</span><span class="kt">:</span><span class="n">fs</span><span class="p">)</span> <span class="ow">=</span> <span class="n">f</span> <span class="o">&gt;&gt;.</span> <span class="p">(</span><span class="n">chain</span> <span class="n">fs</span><span class="p">)</span>
</pre></div>
</div>
<p>But, then I realized that’s a fold:</p>
<div class="highlight-Haskell notranslate"><div class="highlight"><pre><span/><span class="nf">chain</span> <span class="ow">::</span> <span class="p">(</span><span class="kt">Foldable</span> <span class="n">l</span><span class="p">,</span> <span class="kt">Monad</span> <span class="n">m</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="n">l</span> <span class="p">(</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="n">a</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="n">a</span>
<span class="nf">chain</span> <span class="ow">=</span> <span class="n">foldr</span> <span class="p">(</span><span class="o">&gt;&gt;.</span><span class="p">)</span> <span class="n">return</span>
</pre></div>
</div>
<p>And that completes our incursion in Haskell.</p>
</div>
<div class="section" id="doing-the-same-in-python">
<h2>Doing the same in Python<a class="headerlink" href="#doing-the-same-in-python" title="Permalink to this headline">¶</a></h2>
<p>Going from this Haskell definition of <span class="docutils literal"><span class="pre">chain</span></span> to Python is quite easy.  But
we’re not going to work with any possible monad, just lists (iterators,
actually).</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span/><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="nb">reduce</span>

<span class="k">def</span> <span class="nf">iter_compose</span><span class="p">(</span><span class="o">*</span><span class="n">fs</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="c1"># optimize the 'lambda x: [x]' for the *usual* case of 2-args.</span>
        <span class="k">return</span> <span class="n">_compose</span><span class="p">(</span><span class="o">*</span><span class="n">fs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">reduce</span><span class="p">(</span><span class="n">_compose</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">_compose</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
   <span class="k">return</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">z</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">g</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
</pre></div>
</div>
<p>We have included <span class="xref py py-func docutils literal"><span class="pre">iter_compose()</span></span> in <a class="reference external" href="https://github.com/merchise/xoutil">xoutil</a> 1.9.6
and 2.0.6.</p>
</div>

        <div class="postmeta">
        
        <div class="categories">
            <span>
                Filed under:
                <a href="categories/programming.html">Programming</a></span>
        </div>
        <div class="tags">
            <span>
                Tags:
                <a href="tags/haskell.html">Haskell</a>, <a href="tags/python.html">Python</a></span>
        </div>
        </div>
        <div class="timestamp postmeta">
            <span>August 01, 2018</span>
        </div><div class="separator post_separator"></div><h1><a href="2018/06/22/a-failing-fail-in-the-monad-list.html">A failing fail in the monad list<a class="headerlink" href="#a-failing-fail-in-the-monad-list" title="Permalink to this headline">¶</a></a></h1>
<div class="sidebar">
<p class="first sidebar-title">Update.</p>
<p class="last">The <a class="reference external" href="https://stackoverflow.com/q/50989541/211280">question</a> was answered in Stack Overflow, and it shows that the title
of this post is incorrect: The failing <span class="docutils literal"><span class="pre">fail</span></span> is in the <em>function</em> monad.</p>
</div>
<p>I’m following the Real World Haskell book.  In the chapter about Monads, they
create simple example using the list monad compute all pairs of numbers <span class="docutils literal"><span class="pre">(x,</span>
<span class="pre">y)</span></span> that such that <span class="docutils literal"><span class="pre">x</span> <span class="pre">*</span> <span class="pre">y</span> <span class="pre">==</span> <span class="pre">n</span></span> for a given <span class="docutils literal"><span class="pre">n</span></span>.</p>
<p>Their solution is:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span/><span class="nf">multiplyTo</span> <span class="ow">::</span> <span class="kt">Int</span> <span class="ow">-&gt;</span> <span class="p">[(</span><span class="kt">Int</span><span class="p">,</span> <span class="kt">Int</span><span class="p">)]</span>
<span class="nf">multiplyTo</span> <span class="n">n</span> <span class="ow">=</span> <span class="kr">do</span>
      <span class="n">x</span> <span class="ow">&lt;-</span> <span class="p">[</span><span class="mi">1</span><span class="o">..</span><span class="n">n</span><span class="p">]</span>
      <span class="n">y</span> <span class="ow">&lt;-</span> <span class="p">[</span><span class="n">x</span><span class="o">..</span><span class="n">n</span><span class="p">]</span>
      <span class="n">guarded</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">y</span> <span class="o">==</span> <span class="n">n</span><span class="p">)</span> <span class="o">$</span>
        <span class="n">return</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="nf">guarded</span> <span class="ow">::</span> <span class="kt">Bool</span> <span class="ow">-&gt;</span> <span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="ow">-&gt;</span> <span class="p">[</span><span class="n">a</span><span class="p">]</span>
<span class="nf">guarded</span> <span class="kt">True</span> <span class="n">xs</span> <span class="ow">=</span> <span class="n">xs</span>
<span class="nf">guarded</span> <span class="kt">False</span> <span class="kr">_</span> <span class="ow">=</span> <span class="kt">[]</span>
</pre></div>
</div>
<p>But I was wondering if I could restate <span class="docutils literal"><span class="pre">guarded</span></span> for any monad.  Since
<span class="docutils literal"><span class="pre">fail</span></span> in the list monad is <span class="docutils literal"><span class="pre">fail</span> <span class="pre">_</span> <span class="pre">=</span> <span class="pre">[]</span></span>, I though I could do:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span/><span class="nf">guarded</span> <span class="ow">::</span> <span class="kt">Monad</span> <span class="n">m</span> <span class="ow">=&gt;</span> <span class="kt">Bool</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="n">a</span>
<span class="nf">guarded</span> <span class="kt">True</span> <span class="ow">=</span> <span class="n">id</span>
<span class="nf">guarded</span> <span class="kt">False</span> <span class="ow">=</span> <span class="n">fail</span> <span class="s">"skipped"</span>
</pre></div>
</div>
<p>However this actually fails in ghci:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/><span class="o">*</span><span class="n">Main</span><span class="o">&gt;</span> <span class="n">multiplyTo</span> <span class="mi">24</span>
<span class="o">***</span> <span class="ne">Exception</span><span class="p">:</span> <span class="n">skipped</span>
</pre></div>
</div>
<p>I let myself sleep, and this morning I figured there’s actually a
small/important difference between <span class="docutils literal"><span class="pre">guarded</span> <span class="pre">False</span> <span class="pre">_</span> <span class="pre">=</span> <span class="pre">[]</span></span> and <span class="docutils literal"><span class="pre">guarded</span>
<span class="pre">False</span> <span class="pre">=</span> <span class="pre">fail</span> <span class="pre">"..."</span></span></p>
<p>The type of <span class="docutils literal"><span class="pre">guarded</span> <span class="pre">False</span></span> is <span class="docutils literal"><span class="pre">Monad</span> <span class="pre">m</span> <span class="pre">=&gt;</span> <span class="pre">m</span> <span class="pre">a</span> <span class="pre">-&gt;</span> <span class="pre">m</span> <span class="pre">a</span></span>.  However the type
of <span class="docutils literal"><span class="pre">fail</span> <span class="pre">'skipped'</span></span> is just <span class="docutils literal"><span class="pre">Monad</span> <span class="pre">m</span> <span class="pre">=&gt;</span> <span class="pre">m</span> <span class="pre">a</span></span>.</p>
<p>Why does <span class="docutils literal"><span class="pre">guarded</span> <span class="pre">False</span> <span class="pre">=</span> <span class="pre">fail</span> <span class="pre">"skipped"</span></span> type-checks?  That’s an <a class="reference external" href="https://stackoverflow.com/q/50989541/211280">open
question</a> (as of the time of writing).</p>
<p>If I define <span class="docutils literal"><span class="pre">guarded</span></span> as:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span/><span class="nf">guarded</span> <span class="ow">::</span> <span class="kt">Monad</span> <span class="n">m</span> <span class="ow">=&gt;</span> <span class="kt">Bool</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="n">a</span>
<span class="nf">guarded</span> <span class="kt">True</span> <span class="n">xs</span> <span class="ow">=</span> <span class="n">xs</span>
<span class="nf">guarded</span> <span class="kt">False</span> <span class="kr">_</span> <span class="ow">=</span> <span class="n">fail</span> <span class="s">"skipped"</span>
</pre></div>
</div>
<p>Or:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span/><span class="nf">guarded</span> <span class="ow">::</span> <span class="kt">Monad</span> <span class="n">m</span> <span class="ow">=&gt;</span> <span class="kt">Bool</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="n">a</span>
<span class="nf">guarded</span> <span class="kt">True</span> <span class="ow">=</span> <span class="n">id</span>
<span class="nf">guarded</span> <span class="kt">False</span> <span class="ow">=</span> <span class="nf">\</span><span class="n">s</span> <span class="ow">-&gt;</span> <span class="n">fail</span> <span class="s">"skipped"</span>
</pre></div>
</div>
<p>Both work correctly.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last"><cite>fail</cite> is strongly discouraged to use in real world haskell code.</p>
</div>

        <div class="postmeta">
        
        <div class="categories">
            <span>
                Filed under:
                <a href="categories/programming.html">Programming</a></span>
        </div>
        <div class="tags">
            <span>
                Tags:
                <a href="tags/haskell.html">Haskell</a>, <a href="tags/monad.html">Monad</a></span>
        </div>
        </div>
        <div class="timestamp postmeta">
            <span>June 22, 2018</span>
        </div><div class="separator post_separator"></div><h1><a href="2018/01/22/foldl-in-terms-of-foldr.html">Dissecting <cite>foldl</cite> in terms of <cite>foldr</cite><a class="headerlink" href="#dissecting-foldl-in-terms-of-foldr" title="Permalink to this headline">¶</a></a></h1>
<p>The book ‘Real World Haskell’ provides an implementation of <span class="docutils literal"><span class="pre">foldl</span></span> in terms
of <span class="docutils literal"><span class="pre">foldr</span></span>:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span/><span class="nf">myFoldl</span><span class="ow">::</span> <span class="p">(</span><span class="n">b</span> <span class="ow">-&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">b</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">b</span> <span class="ow">-&gt;</span> <span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="ow">-&gt;</span> <span class="n">b</span>
<span class="nf">myFoldl</span> <span class="n">f</span> <span class="n">z</span> <span class="n">xs</span> <span class="ow">=</span> <span class="n">foldr</span> <span class="n">step</span> <span class="n">id</span> <span class="n">xs</span> <span class="n">z</span>
   <span class="kr">where</span> <span class="n">step</span> <span class="n">x</span> <span class="n">g</span> <span class="n">a</span> <span class="ow">=</span> <span class="n">g</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p>They ask the reader (me) to try to understand the implementation.  They warn
it’s not trivial, but I found it interesting.  So, I just want to share my
line of thought.</p>
<p>The first thing I noticed is that <span class="docutils literal"><span class="pre">z</span></span> is not an argument to <span class="docutils literal"><span class="pre">foldr</span></span>; you
can rewrite the first line as:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span/><span class="p">(</span><span class="n">foldr</span> <span class="n">step</span> <span class="n">id</span> <span class="n">xs</span><span class="p">)</span> <span class="n">z</span>
</pre></div>
</div>
<p>This makes visible that the result of the <span class="docutils literal"><span class="pre">foldr</span></span> is a function that takes
<cite>z</cite> as an argument.  By looking a the case <span class="docutils literal"><span class="pre">foldr</span> <span class="pre">step</span> <span class="pre">id</span> <span class="pre">[]</span></span>, which equates
to <span class="docutils literal"><span class="pre">id</span></span>, we can see that the type of the <span class="docutils literal"><span class="pre">foldr</span></span>’s result is <span class="docutils literal"><span class="pre">b</span> <span class="pre">-&gt;</span> <span class="pre">b</span></span>.</p>
<p>This also implies that the type of <span class="docutils literal"><span class="pre">step</span></span> must be <span class="docutils literal"><span class="pre">a</span> <span class="pre">-&gt;</span> <span class="pre">(b</span> <span class="pre">-&gt;</span> <span class="pre">b)</span> <span class="pre">-&gt;</span> <span class="pre">(b</span> <span class="pre">-&gt;</span>
<span class="pre">b)</span></span>.  You can prove that by extracting <span class="docutils literal"><span class="pre">step</span></span>:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span/><span class="nf">step1</span> <span class="ow">::</span> <span class="p">(</span><span class="n">b</span> <span class="ow">-&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">b</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="n">b</span> <span class="ow">-&gt;</span> <span class="n">b</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="n">b</span> <span class="ow">-&gt;</span> <span class="n">b</span><span class="p">)</span>
<span class="nf">step1</span> <span class="n">f</span> <span class="n">x</span> <span class="n">g</span> <span class="n">a</span> <span class="ow">=</span> <span class="n">g</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span> <span class="n">x</span><span class="p">)</span>

<span class="nf">myFoldl1</span> <span class="ow">::</span> <span class="p">(</span><span class="n">b</span> <span class="ow">-&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">b</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">b</span> <span class="ow">-&gt;</span> <span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="ow">-&gt;</span> <span class="n">b</span>
<span class="nf">myFoldl1</span> <span class="n">f</span> <span class="n">z</span> <span class="n">xs</span> <span class="ow">=</span> <span class="n">foldr</span> <span class="p">(</span><span class="n">step1</span> <span class="n">f</span><span class="p">)</span> <span class="n">id</span> <span class="n">xs</span> <span class="n">z</span>
</pre></div>
</div>
<p>Use <cite>ghci</cite> to verify that.</p>
<p>Now comes the <em>funny</em> part of the implementation: <span class="docutils literal"><span class="pre">step</span></span> is defined with
three arguments</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/><span class="n">where</span> <span class="n">step</span> <span class="n">x</span> <span class="n">g</span> <span class="n">a</span> <span class="o">=</span> <span class="n">g</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p>but <span class="docutils literal"><span class="pre">foldr</span></span> only passes the first two, and that’s totally fine; the result
will be another function.</p>
<p>You can make this explicit:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span/><span class="nf">myFoldl2</span> <span class="ow">::</span> <span class="p">(</span><span class="n">b</span> <span class="ow">-&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">b</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">b</span> <span class="ow">-&gt;</span> <span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="ow">-&gt;</span> <span class="n">b</span>
<span class="nf">myFoldl2</span> <span class="n">f</span> <span class="n">z</span> <span class="n">xs</span> <span class="ow">=</span> <span class="n">foldr</span> <span class="n">step</span> <span class="n">id</span> <span class="n">xs</span> <span class="n">z</span>
   <span class="kr">where</span> <span class="n">step</span> <span class="n">x</span> <span class="n">g</span> <span class="ow">=</span> <span class="nf">\</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">g</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p>That’s a beautiful thing about Haskell both definitions of <span class="docutils literal"><span class="pre">step</span></span> are
actually indistinguishable:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/><span class="n">step</span> <span class="n">x</span> <span class="n">g</span> <span class="n">a</span> <span class="o">=</span> <span class="n">g</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span> <span class="n">x</span><span class="p">)</span>

<span class="n">step</span> <span class="n">x</span> <span class="n">g</span> <span class="o">=</span> \<span class="n">a</span> <span class="o">-&gt;</span> <span class="n">g</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p>The first one takes an <em>equation-like</em> outlook that I find very elegant in a
programming language.</p>
<p>Having all that we can easily follow how the expression <span class="docutils literal"><span class="pre">myFoldl</span> <span class="pre">(+)</span> <span class="pre">0</span> <span class="pre">[1,</span>
<span class="pre">2]</span></span> would proceed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/>myFoldl (+) 0 [1, 2]
(foldr step id [1, 2]) 0                  -- by def. of myFoldl
(step 1 (foldr step id [2])) 0            -- by def. of foldr
(step 1 (step 2 (foldr step id []))) 0    -- by def. of foldr
(step 1 (step 2 id)) 0                    -- by def. of foldr for []
(step 1 (\a -&gt; id(a + 2))) 0              -- applying `step 2 id`

(step 1 (\a -&gt; a + 2)) 0                  -- applying id, Haskell might not
                                             do this right now

(\x -&gt; (\a -&gt; a + 2)(x + 1)) 0            -- applying step
(\x -&gt; (x + 1) + 2) 0                     -- applying the inner lambda
(0 + 1) + 2                               -- applying the outer lambda
</pre></div>
</div>
<p>And that’s (more or less) how <span class="docutils literal"><span class="pre">myFoldl</span></span> works.</p>

        <div class="postmeta">
        
        <div class="categories">
            <span>
                Filed under:
                <a href="categories/programming.html">Programming</a></span>
        </div>
        <div class="tags">
            <span>
                Tags:
                <a href="tags/haskell.html">Haskell</a></span>
        </div>
        </div>
        <div class="timestamp postmeta">
            <span>January 22, 2018</span>
        </div><div class="separator post_separator"></div><h1><a href="2016/09/19/uncurated-notes-about-cycle-js.html">Non-curated notes about Cycle.js<a class="headerlink" href="#non-curated-notes-about-cycle-js" title="Permalink to this headline">¶</a></a></h1>
<p>In the past few days I have been reading about Reactive Programming.  Mostly
about how it’s done with <a class="reference external" href="http://cycle.js.org/">cycle.js</a>.  As the title attempts to suggest, this
post is by no means an account of well thought ideas, but my first ideas and
notes while reading about it.</p>
<p><a class="reference external" href="http://cycle.js.org/">Cycle.js</a> is attractive, and its appeal spans from two key properties in my
opinion:</p>
<ul>
<li><p class="first">There’s a single type of connector between the components: the streams.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Both <span class="docutils literal"><span class="pre">sources</span></span> and <span class="docutils literal"><span class="pre">sinks</span></span> return streams.</p>
</div>
</li>
<li><p class="first">There are two distinct type of computational components: the drivers and the
the <span class="docutils literal"><span class="pre">main(sources)</span></span> function.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Intent, view and model functions may be regarded as internal
structure of <span class="docutils literal"><span class="pre">main()</span></span>.</p>
</div>
</li>
</ul>
<p>This is appealing because the architecture is simple.  You may understand the
main points of this architecture in about an hour.  You may recall this is
actually an evolution (or instance) of the producer-consumer pattern.</p>
<p>There’s a third element in <a class="reference external" href="http://cycle.js.org/">cycle.js</a>: the cycle itself.  Which is based on
the ‘dialog abstraction’.  Actually, this is what caught my attention in the
first place.  It goes like: your program outputs are the input to an external
(possibly human) entity which, in turn, may react and produce more events in
your program’s source streams.</p>
<p>Architecturally this is simple and good.</p>
<div class="section" id="components">
<h2>Components<a class="headerlink" href="#components" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>Any Cycle.js app can be reused as a component in a larger Cycle.js app.</p>
<p class="attribution">—From the Cycle.js documentation</p>
</div></blockquote>
<p>When it comes to designing an application or component you have to decide
about the type of events your application may receive and the expected output
events it may produce in response.</p>
<p>The previous statement is only true in two cases:</p>
<ul class="simple">
<li>Your ‘smaller’ Cycle.js application does not need to interact with other
parts of your ‘larger’ application.</li>
<li>Your ‘smaller’ Cycle.js exposes its model; or you have “model drivers”.</li>
</ul>
<p>I think this becomes rather obvious in the 16th part of the Egghead’s video
series on Cycle.js.  The one when they make the slider component and they need
to expose the stream of ‘values’ from the slider.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Actually the documentation states that components expose, somehow,
its state.</p>
</div>
<div class="section" id="streams-to-the-extreme-and-localization">
<h3>Streams to the extreme (and localization)<a class="headerlink" href="#streams-to-the-extreme-and-localization" title="Permalink to this headline">¶</a></h3>
<p>The Egghead’s series exposes how Cycle.js became to be and you can, therefore,
see the evolution it is.  Is a short video series worth watching: right to the
point without many detours.</p>
<p>There’s a video when they needed to make a component out of the Height and
Weight sliders, and they needed to pass parameters like the label, min value
and max value. I thought they were going to use old plain closures:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/><span class="n">function</span> <span class="n">Slider</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">props</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">const</span> <span class="n">label</span> <span class="o">=</span> <span class="n">props</span><span class="o">.</span><span class="n">label</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">etc</span><span class="o">...</span>
    <span class="k">return</span> <span class="n">main</span><span class="p">(</span><span class="n">sources</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>It came as a surprise that they put those parameters into a <span class="docutils literal"><span class="pre">props</span></span>
<strong>source</strong> to the <span class="docutils literal"><span class="pre">main()</span></span> function of the component.</p>
<p>At first I thought that was really far fetched, but after thinking about it a
bit more I think is can be really useful.</p>
<p>I started to think about an application with just a slider and a language
selector:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/><span class="n">Height</span><span class="p">:</span> <span class="mi">6</span> <span class="n">feet</span>   <span class="o">&lt;-----</span><span class="n">o</span><span class="o">--&gt;</span>

<span class="n">Choose</span> <span class="n">language</span><span class="p">:</span> <span class="p">[</span><span class="n">ENG</span><span class="p">]</span>
</pre></div>
</div>
<p>The slider component is the one we see in the video series.  The language
selector is a selection component and the expected behavior is that when I
change the language the <em>entire application</em> changes to the new language.</p>
<p>My first thought is that the language selector gets is value from a driver
(which I don’t know if it already exists) that deals with localization.  Let’s
say you can obtain such a driver like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/><span class="n">cycle</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="p">{</span>
   <span class="o">//</span> <span class="n">etc</span><span class="o">...</span>
   <span class="n">locale</span><span class="p">:</span> <span class="n">makeLocaleDriver</span><span class="p">({</span><span class="n">languages</span><span class="p">:</span> <span class="p">[</span><span class="s1">'en_US'</span><span class="p">,</span> <span class="s1">'es_ES'</span><span class="p">],</span> <span class="o">...</span><span class="p">})</span>
<span class="p">})</span>
</pre></div>
</div>
<p>The driver would let you respond to changes in translations:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/>const label$ = sources.locale.select('Height');
</pre></div>
</div>
<p>Or combining with another mapping from another stream so that the <span class="docutils literal"><span class="pre">props</span></span>
stream remains almost unchanged:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/>const label$ = props$.map(p =&gt; sources.locale.select(p.label));
</pre></div>
</div>
<p>However, after revisiting that last idea, I noticed that it doesn’t work.  A
change in in the locale does not trigger any event in the <span class="docutils literal"><span class="pre">props$</span></span> stream.
Assuming that <span class="docutils literal"><span class="pre">locale.current$</span></span> is a stream of localization object, this may
work:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/>const label$ = props$.combine(sources.locale.current$)
                     .map((label, locale) =&gt; locale.gettext(label));
</pre></div>
</div>
<p>The thing gets a little bit more tricky when it comes to changing the units:
feet vs meter, etc…  I’ve been thinking about it for a bit.  The most
problematic issue is that state is not clearly owned unless we introduce a
kind of <em>quantity</em> for which the unit of measure is explicit:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="p">{</span>
    <span class="n">props</span><span class="p">:</span> <span class="n">xs</span><span class="o">.</span><span class="n">of</span><span class="p">({</span>
       <span class="n">value</span><span class="p">:</span> <span class="n">new</span> <span class="n">Quantity</span><span class="p">(</span><span class="mi">175</span><span class="p">,</span> <span class="n">Unit</span><span class="o">.</span><span class="n">Length</span><span class="o">.</span><span class="n">cm</span><span class="p">),</span>
    <span class="p">})</span>
<span class="p">})</span>
</pre></div>
</div>
<p>However this may seem a bit overreaching for a single <em>value</em> that only needs
to be in between two boundaries (slider).</p>
<p>This is, IMO the breaking point: If I really need to manage units on my
application and those need to be fully localized, my components might be
regarded as over-engineered for other apps.  My only hope is that a simple
slider, without any knowledge of units, might be wrapped inside a
<cite>FullyLocalizedSlider</cite> for that purpose.</p>
</div>
</div>
<div class="section" id="open-questions">
<h2>Open questions<a class="headerlink" href="#open-questions" title="Permalink to this headline">¶</a></h2>
<p>Most of the ideas exposed above are not battle tested.  I happen to be
evaluating whether I could use <a class="reference external" href="http://cycle.js.org/">Cycle.js</a> inside Odoo to develop some widgets
that require almost real-times updates, and the stream interface is thus quite
natural.</p>
<p>There are challenges about integrating my components with the rest of the
application, and being an application that must display at least three
languages I need to think on advance about the problems I would face.</p>
</div>

        <div class="postmeta">
        
        <div class="categories">
            <span>
                Filed under:
                <a href="categories/programming.html">Programming</a></span>
        </div>
        <div class="tags">
            <span>
                Tags:
                <a href="tags/ui.html">UI</a>, <a href="tags/thought.html">Thought</a></span>
        </div>
        </div>
        <div class="timestamp postmeta">
            <span>September 19, 2016</span>
        </div><div class="separator post_separator"></div><h1><a href="2015/09/12/odoo-bus-implementation.html">The bus <em>implementation</em> in Odoo and notification systems in the Web<a class="headerlink" href="#the-bus-implementation-in-odoo-and-notification-systems-in-the-web" title="Permalink to this headline">¶</a></a></h1>
<div class="sidebar">
<p class="first sidebar-title">Delayed post.</p>
<p>This post has been delayed for a very, very long time.  If I trust the logs
in my blog’s git repository the post is “finished” since Sat Sep 12, 2015.
Well, that’s not true, and I must really finish it now.</p>
<p>As it happens, in the meantime, I was not twiddling my fingers and I made
two “advances” about the bus implementation:</p>
<ul class="last simple">
<li>I made a successful implementation of a cross-tab bus implementation:
<a class="reference external" href="https://github.com/merchise-autrement/odoo/tree/merchise-8.0-bus-service-worker">https://github.com/merchise-autrement/odoo/tree/merchise-8.0-bus-service-worker</a></li>
<li>I discovered that Odoo 9’s code base already has the cross-tab feature
integrated.</li>
</ul>
</div>
<p>I commented on my <a class="reference internal" href="2015/05/26/odoo-at-last.html#odoo-at-last"><span class="std std-ref">post about our migration to Odoo</span></a> that
our users open many tabs to the same Odoo instance.  When the chat is active
this means an open connection for each tab and, since a chat is interactive in
nature, all but one of these connections are not actually required <a class="footnote-reference" href="#notify" id="id1">[1]</a>.</p>
<p>A while ago <a class="reference external" href="https://twitter.com/mvaled/status/615973409697050624">I reported</a> that switching from a
threaded based deployment to a pre-forked processes one with a <a class="reference external" href="https://pypi.python.org/pypi/gevent">gevent</a> based
process for long polling connections, actually spiked the concurrency issues
we were witnessing in our DB.  Our DB complained about being unable to
<em>serialize</em> concurrent transactions.  By inspecting the logs we noticed that
almost always this had to do with an update to the table <span class="docutils literal"><span class="pre">im_chat_presence</span></span>,
that holds the status of users in the chat.</p>
<p>I thought the forked model would diminish the chance of collisions because (I
thought) Odoo would use a single DB connection per worker process and another
one for the gevent worker that would simply serialize <em>all</em> the chat related
queries.</p>
<p>This spike was against all rationale I could think of, but honestly I didn’t
check my assumptions by reading the code.  They might just be the wrong
assumptions in the first place, and I needed to really read the code to see
what was really happening.</p>
<p>After restoring the threaded deployment the concurrency issues dropped again.
They didn’t get to the same levels they were before, but, at the same time, we
were introducing other modules (and the related staff), so there are more open
tabs…  Afterwards we went back to the process model, and the issues spiked
again, however in a smaller amount.</p>
<p>Several weeks later I deployed a <a class="reference external" href="https://github.com/merchise-autrement/odoo/commit/2abfd5ba28e959dda4d6a127a19b3d939008bc1d">patch</a> to the Odoo bus
implementation that simply reduced the frequency of polling when the <a class="reference external" href="http://www.w3.org/TR/page-visibility/">page is
hidden</a>.  The concurrency issues were now mostly gone:
from about 3k a day to no more than 50.</p>
<p>We still had unanswered questions regarding the DB connection management in
Odoo.  There were suspicious signs.  For instance reducing the <span class="docutils literal"><span class="pre">db_maxconn</span></span>
option to 8 or less made Odoo start complaining about the Connection Pool
being full very often.  We already knew that:</p>
<ul class="simple">
<li>For each cron worker at least 2 connections are used: one holds the cron job
locked while the other is used by the job itself.</li>
<li>The bus (used for the chat) also uses another connection to the DB
“postgres”: Notifications and wake-ups of bus-related events use this
connection.</li>
</ul>
<p>The most suspicious sign, however, was that with a pool size of 32, this issue
came from time to time.</p>
<p>Time went by and the issue remained at an acceptable (for us) level of few
dozens per day.  You may say it’s too much, but, bear with me, it’s reasonable
for our hardware and user base.</p>
<p>Just a few days ago, we realized that issues coming from our gevent-based
process were not being properly reported to our <a class="reference external" href="http://getsentry.com/">Sentry</a>.  We <a class="reference external" href="https://github.com/merchise-autrement/xoeuf/commit/d4b3bb7f0d972f31382aad8e6d1bf37c5a74ce99">fixed the issue</a> and observed that we’re getting about 2.5k DB collisions
per day reports again.  And once more the query the table where most of
collisions happen is ‘im_chat_presence’.</p>
<p>As a workaround we simply <a class="reference external" href="https://github.com/merchise-autrement/odoo/commit/555b5699b96178d5c87f36c0f692dbe8dcf0facb">reduced</a> the update rate for that table.  But a
better solutions needed to be found.</p>
<div class="section" id="cross-tab-polling">
<h2>Cross-tab polling<a class="headerlink" href="#cross-tab-polling" title="Permalink to this headline">¶</a></h2>
<p>By looking better our users’ usage pattern, we discovered that users switch
from tab to tab regularly and thus the polling is still high.  So we went down
the path of figuring out a way to have a single polling connection even when
many were opened.</p>
<p>I remembered the Local Storage API and went down to write a simple proof of
concept of listening events of the <span class="docutils literal"><span class="pre">localStorage</span></span> from different tabs.  The
proof of concept yielded good results, and so I turned to Google and search
for “cross-tab communication” and found the <a class="reference external" href="https://github.com/nodeca/tabex">tabex</a> library.</p>
<p>After that, replacing the implementation of the bus for a new one that was
based on a exchanged between tabs was not very hard.  These are the commits
done in our branch (in reverse topological order as in <span class="docutils literal"><span class="pre">git</span> <span class="pre">log</span></span>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/><span class="mi">0555434</span> <span class="o">*</span> <span class="n">bus</span><span class="p">:</span> <span class="n">Clarify</span> <span class="n">the</span> <span class="n">channel</span> <span class="n">delay</span> <span class="ow">in</span> <span class="n">polls</span><span class="o">.</span>
<span class="n">d10a1b5</span> <span class="o">*</span> <span class="n">bus</span><span class="p">:</span> <span class="n">Checks</span> <span class="k">for</span> <span class="n">the</span> <span class="n">right</span> <span class="n">state</span><span class="o">.</span>
<span class="n">af4a6dc</span> <span class="o">*</span> <span class="n">bus</span><span class="p">:</span> <span class="n">Add</span> <span class="n">language</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">documentation</span><span class="o">.</span>
<span class="mi">636490</span><span class="n">b</span> <span class="o">*</span> <span class="n">im_chat</span><span class="p">:</span> <span class="n">Revert</span> <span class="s2">"Reduce the presure on im_chat_presence table."</span>
<span class="n">eda7638</span> <span class="o">*</span> <span class="n">bus</span><span class="p">:</span> <span class="n">Don</span><span class="s1">'t notify if not in polling state.</span>
<span class="mi">4</span><span class="n">d09ac6</span> <span class="o">*</span> <span class="n">web_celery</span><span class="p">:</span> <span class="n">Use</span> <span class="n">a</span> <span class="n">dedicated</span> <span class="n">bus</span> <span class="n">exchange</span> <span class="k">for</span> <span class="n">jobs</span><span class="o">.</span>
<span class="mf">84239e3</span> <span class="o">*</span> <span class="n">im_chat</span><span class="p">:</span> <span class="n">Beep</span> <span class="n">only</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">master</span> <span class="n">tab</span><span class="o">.</span>
<span class="mi">2</span><span class="n">cb27da</span> <span class="o">*</span> <span class="n">Improve</span> <span class="n">the</span> <span class="n">bus</span> <span class="n">to</span> <span class="n">allow</span> <span class="n">tab</span> <span class="n">synchronization</span><span class="o">.</span>
</pre></div>
</div>
<p>The file <a class="reference external" href="https://github.com/merchise-autrement/odoo/blob/merchise-8.0-bus-service-worker/addons/bus/static/src/js/bus.rst"><span class="docutils literal"><span class="pre">addons/bus/static/src/js/bus.rst</span></span></a> contains the new design explained.</p>
<p>A few weeks ago I did the <a class="reference external" href="https://github.com/merchise-autrement/odoo/commit/4690d8d466fe622a1a2449403cc41ae78d4caafe">first merge</a> our 8.0 changes into the 9.0 branch.
On the process I realized that Odoo 9.0’s bus was improved and now contains
the a cross-tab communication feature.</p>
<p>So probably I end up backporting their implementation into 8.0.</p>
</div>
<div class="section" id="notes">
<h2>Notes<a class="headerlink" href="#notes" title="Permalink to this headline">¶</a></h2>
<table class="docutils footnote" frame="void" id="notify" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>Of course it allows the web app to change the window’s title when
then user has an unread message, but in our case this notification is also
unneeded, because the message is actually being read in another tab.</td></tr>
</tbody>
</table>
</div>

        <div class="postmeta">
        
        <div class="categories">
            <span>
                Filed under:
                <a href="categories/web-development.html">Web Development</a>, <a href="categories/programming.html">Programming</a></span>
        </div>
        <div class="tags">
            <span>
                Tags:
                <a href="tags/html5.html">HTML5</a>, <a href="tags/odoo.html">Odoo</a></span>
        </div>
        </div>
        <div class="timestamp postmeta">
            <span>September 12, 2015</span>
        </div><div class="separator post_separator"></div><h1><a href="2015/08/04/repost-the-productivity-of-tomorrow-trumps-that-of-today.html">The productivity of tomorrow trumps that of today<a class="headerlink" href="#the-productivity-of-tomorrow-trumps-that-of-today" title="Permalink to this headline">¶</a></a></h1>
<div class="sidebar">
<p class="first sidebar-title">Editorial note</p>
<p>I’m republishing this post from my old blog (which is no longer online).
It’s published as it were when I first made it online with only minor
changes.  But I think I stand by this still.</p>
<p class="last">Hope you’ll enjoy the reading.</p>
</div>
<p>That’s probably harsh, but I think it is absolutely right.  Doing crappy
software today to be more productive today will make you less productive
tomorrow.  It’s this simple.  And that’s cumulative too; meaning that if you
neglect your future productivity, it will be slowly diminishing until a point
of negative competitive disadvantage where you’ll find yourself struggling to
keep up instead of innovating.</p>
<p>And it’s so damn exhausting to explain why…</p>
<p>Software complexity does not come from the tools, but from the mental
framework required (and imposed at times) to understand it.  So don’t ever
think measuring Cyclomatic Complexity (CC) and other similar metrics will
yield something close to the <a class="reference external" href="http://www.osnews.com/story/19266/WTFs_m">true measure</a> of the
<a class="reference external" href="http://blog.codinghorror.com/whos-your-coding-buddy/">quality of your code</a>.</p>
<blockquote>
<div><p>There are only <a class="reference external" href="http://martinfowler.com/bliki/TwoHardThings.html">two hard things</a> in Computer Science: cache invalidation
and naming things.</p>
<p class="attribution">—Phil Karlton</p>
</div></blockquote>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/><span class="k">def</span> <span class="nf">_check</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
       <span class="k">return</span> <span class="n">l</span>
    <span class="n">l1</span><span class="p">,</span> <span class="n">l2</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
       <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;=</span><span class="n">m</span> <span class="p">:</span>
          <span class="n">l1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
       <span class="k">else</span><span class="p">:</span>
          <span class="n">l2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_check</span><span class="p">(</span><span class="n">l1</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">+</span><span class="n">_check</span><span class="p">(</span><span class="n">l2</span><span class="p">)</span>
</pre></div>
</div>
<p>This code has a nice CC of 4 which is very nice; yet it will take you at least
a minute to figure out what it does.  If only I had chosen to name the
function <cite>quicksort</cite>…</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/><span class="gp">&gt;&gt;&gt; </span><span class="n">_check</span><span class="p">([</span><span class="mi">84</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">89</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">77</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">16</span><span class="p">])</span>
<span class="go">[4, 16, 24, 70, 77, 84, 86, 89, 95, 95]</span>
</pre></div>
</div>
<p>A quiz in less than 5 seconds: What does it mean in OpenERP’s ORM the
following lines of code?</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/><span class="n">group</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">'implied_ids'</span><span class="p">:</span> <span class="p">[(</span><span class="mi">3</span><span class="p">,</span> <span class="n">implied_group</span><span class="o">.</span><span class="n">id</span><span class="p">)]})</span>
</pre></div>
</div>
<p>This line of code has a CC of 1: as good as it gets, isn’t it?  But it’s so
darn difficult to read that unless you have your brain wired up to see “forget
the link between this group and the implied_group”…  To be fair there is
someone out there in the OpenERP universe that cared a bit about this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/><span class="c1"># file addons/base/ir/ir_fields.py</span>

<span class="n">CREATE</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">values</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
<span class="n">UPDATE</span> <span class="o">=</span> <span class="k">lambda</span> <span class="nb">id</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
<span class="n">DELETE</span> <span class="o">=</span> <span class="k">lambda</span> <span class="nb">id</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">FORGET</span> <span class="o">=</span> <span class="k">lambda</span> <span class="nb">id</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">LINK_TO</span> <span class="o">=</span> <span class="k">lambda</span> <span class="nb">id</span><span class="p">:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">DELETE_ALL</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">REPLACE_WITH</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">ids</span><span class="p">:</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">ids</span><span class="p">)</span>
</pre></div>
</div>
<p>But no one else is using it!</p>
<p>And, yes, it’s exhausting going over this.</p>

        <div class="postmeta">
        
        <div class="categories">
            <span>
                Filed under:
                <a href="categories/programming.html">Programming</a></span>
        </div>
        
        </div>
        <div class="timestamp postmeta">
            <span>August 04, 2015</span>
        </div><div class="separator post_separator"></div><span id="id1"/><h1><a href="2015/05/26/odoo-at-last.html">Odoo at last!<a class="headerlink" href="#odoo-at-last" title="Permalink to this headline">¶</a></a></h1>
<div class="sidebar">
<p class="first sidebar-title">Updated 2015-06-03</p>
<p><a class="reference internal" href="2015/05/26/odoo-at-last.html#the-menu-decomposition">The menu decomposition</a> described below was actually an error in a custom
addon and not related with migration process.</p>
<p class="last">While still using OpenERP, we backported the partner merge feature from
Odoo and made it work in OpenERP.  We even added a fuzzy match feature so
that minor typos were not missed.  Now in Odoo it seems our modifications
messed things up.</p>
</div>
<p>After several months, we have finally moved from OpenERP to Odoo.  It took
several rounds of testing, finding bugs and incompatibilities in our own
modules and fixing them.</p>
<div class="section" id="a-summary-of-the-process">
<h2>A summary of the process<a class="headerlink" href="#a-summary-of-the-process" title="Permalink to this headline">¶</a></h2>
<p>The <a class="reference external" href="https://github.com/OpenUpgrade/OpenUpgrade">OpenUpgrade</a> project proved to be very complete for us –it had almost
everything we needed:</p>
<ul class="simple">
<li>The Accounting and Project modules were done.</li>
<li>The CRM module was not yet integrated into the mainstream repository but a
<a class="reference external" href="https://github.com/StefanRijnhart/OpenUpgrade">fork by Stefan Rijnhart</a> had a branch that proved very
complete for our needs.</li>
</ul>
<p>We began by merging Stefan’s branch into our own clone of the repository.  We
came into a small issue and <a class="reference external" href="https://github.com/mvaled/OpenUpgrade/commit/57cd439">fixed it</a>.  Afterwards, some of our
recurrent events were missing the timezone and the migration failed.  For that
we created the branch <a class="reference external" href="https://github.com/mvaled/OpenUpgrade/tree/8.0-valid-rrules">8.0-valid-rrules</a> and it did the job after a couple of
tweeks.</p>
<p>The branch we actually used for the migration is <a class="reference external" href="https://github.com/mvaled/OpenUpgrade/tree/merchise-8.0">merchise-8.0</a>.  It includes
several commits we had to make for our customs addons to work.  Those commits
are probably too local to be merged back into the upstream.  However, we have
published them should anyone finds them useful.</p>
</div>
<div class="section" id="the-menu-decomposition">
<h2>The menu decomposition<a class="headerlink" href="#the-menu-decomposition" title="Permalink to this headline">¶</a></h2>
<p>The biggest issue we’ve encountered so far is that after several hours of
operation all the menus stopped working: You clicked the “Leads” menu item and
you got, say, the list of Many2Many fields. (???!!!)</p>
<p>A first inspection showed that all menu items in the HTML were <em>somehow</em>
related to the same action id.  Quickly, we truncated the <span class="docutils literal"><span class="pre">ir_ui_menu</span></span> table
and its associated <span class="docutils literal"><span class="pre">ir_model_data</span></span> rows, upgraded the DB and all menus came
to life once more.</p>
<p>The day after, the same problem happened.  Deeper inspection of both the code
and the DB showed the problem lied in the <span class="docutils literal"><span class="pre">ir_values</span></span> table.  That table
relates menu items with actions.  The rows containing this relation showed
nonsense: almost all the menu items were related to “<span class="docutils literal"><span class="pre">res_partner,20</span></span>”.  And
in the UI this was interpreted to be pointing to the action with id 20.</p>
<p>Comparing the table before and after the upgrade showed no problem there.  So
this issue had appeared after the migration itself.</p>
<p>Our previous method of truncating <span class="docutils literal"><span class="pre">ir_ui_menu</span></span> didn’t fix this issue cause
the <span class="docutils literal"><span class="pre">ir_values</span></span> rows remained there crippling over and over again.  Besides,
truncating <span class="docutils literal"><span class="pre">ir_ui_menu</span></span> had the unintentional, bad side-effect of removing
every Mail list in our DB.</p>
<p>We’re still on the track about how the <span class="docutils literal"><span class="pre">ir.values</span></span> were messed up in the
first place.</p>
</div>
<div class="section" id="the-magical-6-tabs">
<h2>The magical 6 tabs<a class="headerlink" href="#the-magical-6-tabs" title="Permalink to this headline">¶</a></h2>
<p>Our users started to report slowness after a couple of hours of working.
First, we noticed that the call to <span class="docutils literal"><span class="pre">load_needaction</span></span> was taking too long and
find out this call asked for too much it did not need, we <a class="reference external" href="https://github.com/odoo/odoo/pull/6772">provided a fix</a> and some loose benchmarks.  Though this patch needs
to be completed, the slowness was solved… for a moment.</p>
<p>Some users kept reporting the Odoo interface was freezing all the time, even
inviting them to go out and drink a cup of coffee…  But other users were
happy about it after the patch.  Closer inspection showed many of the AJAX
calls were blocking waiting for a socket to be available.</p>
<p>It turned out these users had created a habit of opening several tabs when
they worked with OpenERP.  They kept this kind of behavior, but a couple of
facts worked against them:</p>
<ul>
<li><p class="first">We have installed the Odoo chat.  Many of our users are geographically
spread, the chat provided an instant and cheaper communication path.</p>
<p>This feature was, by far, one the reason we moved to Odoo in the first
place.</p>
<p>On technical side, the chat works by long polling the server.  In our server
this connection stays open for about 50s before being dropped (only to be
reestablished a moment later).</p>
<p>This means: a tab has always at least a connection open to the server.</p>
</li>
<li><p class="first">As explained by Ilya Grigorik in <a class="reference external" href="http://www.aosabook.org/en/posa/high-performance-networking-in-chrome.html">High Performance Networking in Chrome</a>,
browsers make only so many connections to the same combination of scheme,
host and port.</p>
<p>In Chrome this number is 6.  In Firefox this can be tuned up or down by
tweaking the <span class="docutils literal"><span class="pre">network.http.max-persistent-connections-per-server</span></span>
parameter, but the default is 6.</p>
</li>
</ul>
<p>Combining these, it means that after opening about 6 tabs every AJAX call has
to wait up to 50s to be able to even reach the server.</p>
<p>We opted for raising this number in Firefox and to warn users about this.  Our
user base is small enough and the server has yet to achieve any noticeable
load.</p>
</div>
<div class="section" id="epilogue">
<h2>Epilogue<a class="headerlink" href="#epilogue" title="Permalink to this headline">¶</a></h2>
<p>That’s what our migration to Odoo story has gone so far.  A little bit
stressful at times, specially when the menus went south for the second time,
but I think we have crossed the yellow line now.  Should anything comes I’ll
report it.</p>
<p>I’d love to hear (or read) about others, so I can learn from their experience.</p>
</div>

        <div class="postmeta">
        
        <div class="categories">
            <span>
                Filed under:
                <a href="categories/management.html">Management</a>, <a href="categories/programming.html">Programming</a></span>
        </div>
        <div class="tags">
            <span>
                Tags:
                <a href="tags/odoo.html">Odoo</a>, <a href="tags/openerp.html">OpenERP</a></span>
        </div>
        </div>
        <div class="timestamp postmeta">
            <span>May 26, 2015</span>
        </div><div class="separator post_separator"></div><div class="section" id="memento-microservices">
<h1><a href="2015/04/08/rememoring-microservices.html">Memento: microservices<a class="headerlink" href="#memento-microservices" title="Permalink to this headline">¶</a></a></h1>
<p>Lately there’s been a raise of the debate about Microservices architectures.
Reading about the stuff I realized I did once architect an application called
Pyxel based on the same principles, though different.</p>
<p>Pyxel reached only its first prototype and was never actually deployed.  I’d
say it wasn’t given the chance to prove itself.  So I argue it was technically
sound and, although only a prototype and thus needing improvements, it would
have meet its stated requirements <a class="footnote-reference" href="#disagreement" id="id1">[1]</a>.</p>
<p>I haven’t been given permission to freely distribute the source code.  But the
architecture was published in several public events, so I can freely describe
it here.</p>
<div class="section" id="pyxel">
<h2>Pyxel<a class="headerlink" href="#pyxel" title="Permalink to this headline">¶</a></h2>
<p>Pyxel’s goal was simple:</p>
<blockquote>
<div>Be a shared repository of photographs for the news media that wish to
collaborate.</div></blockquote>
<p>Pyxel required that images were tagged with IPTC metadata before uploading.
Upon upload, the image went through several processes for extracting the
metadata, and for producing web-friendly versions <a class="footnote-reference" href="#retina" id="id2">[2]</a> for several
standard dimensions before being published.</p>
<p>On the technical side we have also very hard constraints:</p>
<ul class="simple">
<li>the system would have to be highly accessible.</li>
<li>it should run on spare machines; introducing a new machine to replace an old
one should be possible with minimal interruption.</li>
</ul>
<p>This constraints were the main driver that lead us to design what we called a
distributed system.  Each major component was designed to run in isolation of
the rest.</p>
<p>Pyxel was split in several processes:</p>
<ul class="simple">
<li>An image queue holding new images.  This was kind of a FIFO queue over the
network.</li>
<li>A catalog holding indexes for retrieving images based of queries.  Queries
were defined a syntax allowing from very simple queries aided with pattern
recognition (PR) of names and dates, to very specific queries that make the
PR mostly unused.</li>
<li>A “feature” index.  This basically allowed to find similar images.  There
were two indexes, one based on Hu moments and the other based on wavelets.</li>
<li>Several image processing nodes, that take images from the queue and:<ul>
<li>Extract IPTC metadata and put it the catalog</li>
<li>Extract image features to allow detection of similar images.</li>
<li>Produce “web versions” for the image.  We always kept the original file,
but to keep the design of the prototype simple there was an “as-is web
version” that simply returned the same file as the input.</li>
</ul>
</li>
<li>A web application that communicates with the index and the catalogs.</li>
<li>An FTP server that injects images to the queue using a FUSE mount point
(drag-and-drop to the browser wasn’t common yet).</li>
</ul>
<p>That were the main components and all of them ran independently.  Of course
for some services to perform at 100%, they required others to be working.  The
web application would not be able to perform a search if the catalog was down,
or to upload new images if the queue was out of reach.</p>
</div>
<div class="section" id="the-principles-stand">
<h2>The principles stand<a class="headerlink" href="#the-principles-stand" title="Permalink to this headline">¶</a></h2>
<p>Microservices are “a take” on the same old issue about software composition.
Conceptually <a class="reference external" href="https://www.cs.umd.edu/class/spring2003/cmsc838p/Design/criteria.pdf">Parnas</a> still rules: must do modules.  Names have changed and
several rules to build better modules (components, services, etc) have been
provided.</p>
<p>Exposition of the modules as services have also been promoted.</p>
<p>In the web, the modules have drifted away from the server into the client.</p>
</div>
<div class="section" id="microservices-and-pyxel">
<h2>Microservices and Pyxel<a class="headerlink" href="#microservices-and-pyxel" title="Permalink to this headline">¶</a></h2>
<p>Pyxel was not actually a microservice architecture as it is understood now.
Deep down it used a central name-server that matched services names to network
endpoints.  We used <a class="reference external" href="https://pypi.python.org/Pyro">Pyro</a> for this prototype.</p>
<p>We did recognize that this was an <em>accidental</em> choice, a matter of convenience
to have the prototype working as soon as possible.</p>
<p>We chose Pyro to test our prototype not to keep it forever if it performed
poorly.  And though our first tests were positive there was some slowness.</p>
<p>To accommodate for a possible replacement of Pyro we chose to provide our own
“idiom” (in Python) to connect and communicate with services:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/><span class="k">with</span> <span class="n">service</span><span class="p">(</span><span class="s1">'pyxel.queue'</span><span class="p">)</span> <span class="k">as</span> <span class="n">queue</span>
    <span class="n">queue</span><span class="o">.</span><span class="n">method</span><span class="p">(</span><span class="o">*</span><span class="n">arguments</span><span class="p">)</span>
</pre></div>
</div>
<p>That pattern was designed to have an appearance as simple as RPC.  Later we
found that <a class="reference external" href="http://steve.vinoski.net/pdf/IEEE-RPC_Under_Fire.pdf">RPC was under fire</a>, but the project was being shut down, so we
didn’t fix that.</p>
<p>Under current views Pyxel needs several changes.  I can think of a couple:</p>
<ul class="simple">
<li>Probably exposing the queue to the client-side of the web application
instead sending the images first to the server-side of the web application.</li>
<li>Extract the user registration, authentication and authorization into a
service.</li>
</ul>
</div>
</div>
<div class="section" id="notes">
<h1>Notes<a class="headerlink" href="#notes" title="Permalink to this headline">¶</a></h1>
<table class="docutils footnote" frame="void" id="disagreement" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>Actually one of the main causes of Pyxel being a failure
was I could not make all participants agreed on the requirements.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="retina" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td>Current retina displays would make that thumbnails look like
icons and bandwidth is also more likely to allow very big pictures to be
friendly.</td></tr>
</tbody>
</table>
</div>

        <div class="postmeta">
        
        <div class="categories">
            <span>
                Filed under:
                <a href="categories/architecture.html">architecture</a></span>
        </div>
        <div class="tags">
            <span>
                Tags:
                <a href="tags/memento.html">memento</a></span>
        </div>
        </div>
        <div class="timestamp postmeta">
            <span>April 08, 2015</span>
        </div><div class="separator post_separator"></div><h1><a href="2015/02/18/greenlet-local-python-modules-an-experiment.html">Hot-swapping Python modules. An experiment.<a class="headerlink" href="#hot-swapping-python-modules-an-experiment" title="Permalink to this headline">¶</a></a></h1>
<p>A new project I’m involved with will <em>probably</em> require dozens of servers
running several thousands <a class="reference external" href="https://greenlet.readthedocs.org/en/latest/">greenlets</a> each.  Top-level greenlets represent jobs
and their children will be individual tasks those greenlets are
coordinating/supervising.</p>
<p>This model, however prototypical, resembles that of the <a class="reference external" href="http://www.erlang.org/">OTP</a> in Erlang.  A
greenlet may be either a supervisor or a worker.</p>
<p>But there’s something missing in our platform that Erlang do have and that
might yield huge benefits.  You can change your Erlang code while the program
is running.</p>
<div class="section" id="modulets-the-idea">
<h2>Modulets.  The idea<a class="headerlink" href="#modulets-the-idea" title="Permalink to this headline">¶</a></h2>
<p>I asked myself if I could devise an <em>import mechanism</em> that would allow to
update a Python module in a way that already-running greenlets stay unaffected
but newly created ones use the new code.</p>
<p>To exemplify, let’s say a typical tasks is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/><span class="k">def</span> <span class="nf">receive_confirmation</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">who</span><span class="p">):</span>
   <span class="kn">from</span> <span class="nn">jobs.util.email</span> <span class="k">import</span> <span class="n">send_email</span>
   <span class="kn">from</span> <span class="nn">jobs.util.email</span> <span class="k">import</span> <span class="n">wait_reply</span>
   <span class="c1"># Assume both send_email and wait_reply switch away from the current</span>
   <span class="c1"># greenlet and only switch back after they are done.</span>
   <span class="n">message</span> <span class="o">=</span> <span class="n">send_email</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">who</span><span class="p">)</span>
   <span class="n">res</span> <span class="o">=</span> <span class="n">wait_reply</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
   <span class="k">return</span> <span class="n">res</span>  <span class="c1"># this will be sent to the parent greenlet</span>
</pre></div>
</div>
<p>The servers start and hundreds of this task are launched in different jobs.
Many of them are idle waiting for their replies.  Users are happily getting
their confirmation emails and replying to them (or ignoring them).</p>
<p>However, we start receiving lot of bounces in the postmaster inbox.  Some
users have entered a wrong email address.  A change is in order.</p>
<p>In response, we change our implementation of <span class="docutils literal"><span class="pre">send_email</span></span> so that it does
<a class="reference external" href="http://en.wikipedia.org/wiki/Variable_envelope_return_path">VERP</a> to know which recipients’ address are bouncing, and also create a new
<cite>job</cite> that involves receiving confirmation email when a new user registers.</p>
<p>We’d love to simply update our <span class="docutils literal"><span class="pre">jobs.util</span></span> package and be done with it like
this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/>$ source server-virtual-env/bin/activate
$ pip install -U jobs.util -i https://my.private.server/
</pre></div>
</div>
<p>New jobs will pick up the new version and the older jobs will keep working as
if nothing would have changed.</p>
<p>That would be really nice.  Such a hot-swap of Python modules per job is what
I’m calling a “modulet”.</p>
<p>Currently I have a “working” <strong>yet very experimental and undertested</strong>
implementation of such a mechanism in our <a class="reference external" href="https://github.com/merchise-autrement/xoutil/tree/experimental-modulets/xoutil/modules">experimental modulets branch</a> in
xoutil.</p>
</div>
<div class="section" id="modulets-in-xoutil">
<h2>Modulets in xoutil<a class="headerlink" href="#modulets-in-xoutil" title="Permalink to this headline">¶</a></h2>
<p>The current implementation is a very early proof of concept and not something
you’d like to put outside your playground.</p>
<p>The file <a class="reference external" href="https://github.com/merchise-autrement/xoutil/blob/experimental-modulets/xoutil/modules/test_modulet.py"><span class="docutils literal"><span class="pre">test_modulet.py</span></span></a> is a simple script you may run to see it working.
It simply creates a temporary module <span class="docutils literal"><span class="pre">magic_module</span></span> that has the
<span class="docutils literal"><span class="pre">get_magic</span></span> function.  This function returns a single value.</p>
<p>The test launches three greenlets that simply call the <span class="docutils literal"><span class="pre">get_magic</span></span> function
and asserts it returns the “right” magic value.  Between launches the module
gets updated to return a different magic value, which is passed as an argument
to the newly created greenlet.</p>
<p>A single run will print something like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/>$ python test_modulet.py
Beginning with 3 in /tmp/tmp1d4rK5
Isolating 'magic_module' as '&lt;greenlet.greenlet object at 0x7f21f4e8daf0&gt;.magic_module'
Isolating 'magic_module' as '&lt;greenlet.greenlet object at 0x7f21f4e8da50&gt;.magic_module'
Isolating 'magic_module' as '&lt;greenlet.greenlet object at 0x7f21f4daa7d0&gt;.magic_module'
Passed. I have the right magic number 1002
Passed. I have the right magic number 1001
Passed. I have the right magic number 1000
</pre></div>
</div>
<p>If you comment the bootstrapping of modulets, then you’ll get something like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span/>$ python test_modulet.py
Beginning with 3 in /tmp/tmpeI1oYA
Wrong magic number
Traceback (most recent call last):
  File "test_modulet.py", line 49, in rootprog
    g.switch()
  File "test_modulet.py", line 31, in prog
    assert res == magic, "Expected %d but got %d." % (magic, res)
AssertionError: Expected 1002 but got 1000.
Wrong magic number
Traceback (most recent call last):
  File "test_modulet.py", line 49, in rootprog
    g.switch()
  File "test_modulet.py", line 31, in prog
    assert res == magic, "Expected %d but got %d." % (magic, res)
AssertionError: Expected 1001 but got 1000.
Passed. I have the right magic number 1000
</pre></div>
</div>
</div>
<div class="section" id="future-work">
<h2>Future work<a class="headerlink" href="#future-work" title="Permalink to this headline">¶</a></h2>
<p>Since we are at the very early stages of this project is not easy to predict
if we’ll keep modulets in our platform.  Probably a <a class="reference external" href="http://docs.celeryproject.org/en/latest/">celery</a> based solution be
enough.</p>
<p>If we were to keep it, there are several things to improve:</p>
<ul>
<li><p class="first">The current mechanism pollutes the <span class="docutils literal"><span class="pre">sys.modules</span></span> with a copy of a module
per top-level greenlet.</p>
<p>In the current state, this is an ever-growing pile of modules that never
erases those that are no longer used.</p>
<p>This needs to be changed in several ways:</p>
<p>The namespace we use to masquerade the modules need not be (and should not
be) the repr of the greenlet object.</p>
<p>For the purposes of isolating different versions of the same code we can
either use the timestamp of the files, the version of the distribution,
etc…</p>
<p>Running a <a class="reference external" href="http://diesel.io/">diesel</a> server will quickly eat all your RAM unless this is
changed.</p>
<p>When a <a class="reference external" href="https://greenlet.readthedocs.org/en/latest/">greenlet</a> dies the only one informed is its parent.  But we certainly
don’t want jobs to mess with <span class="docutils literal"><span class="pre">sys.modules</span></span> to clean our own mess.</p>
<p>This poses a challenge of its own and may be delegated outside <cite>xoutil</cite>
itself.</p>
<p>That being said, it’s likely that the calculation of the current namespace
and how to dispose of unused modules will be extensions points of
<cite>modulets</cite>.</p>
</li>
<li><p class="first">Currently we have a black-list of modules that will never be isolated.</p>
<p>Changes in those modules will required a restart to be noticed.  Those
modules are platform-level.  They include <cite>xoutil</cite> itself, <cite>greenlet</cite> and
the entire standard library (which is not expected to change unless you
change Python).</p>
<p>We can also allow white-listing.  Both ways are on the table.</p>
<p>The white-list imposes more explicit architecture of your platform since it
requires throughout revision of which modules you’re willing to update on
the run.</p>
<p>Access to both lists will be a public API of the Modulet Manager.  I can
envision a remote-control console you’ll use to include a new module in the
white-list.  But that will be an application of the modulet API and included
in the box.</p>
</li>
</ul>
</div>

        <div class="postmeta">
        
        <div class="categories">
            <span>
                Filed under:
                <a href="categories/python.html">Python</a>, <a href="categories/programming.html">Programming</a></span>
        </div>
        <div class="tags">
            <span>
                Tags:
                <a href="tags/isolation.html">isolation</a>, <a href="tags/erlang.html">erlang</a></span>
        </div>
        </div>
        <div class="timestamp postmeta">
            <span>February 18, 2015</span>
        </div><div class="archive_link">
        <a href="archive.html"> &mdash; Blog Archive &mdash; </a>
    </div><ul class="related clearfix">
            <li class="left"></li>
            <li class="right"><a href="page2.html">Older</a> &raquo; </li>
        </ul></article>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'mvaled-io';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the
      <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript><aside class="sidebar"></aside></div> <!-- #main --></div> <!-- #main-container -->

        <div class="footer-container" role="contentinfo"><footer class="wrapper"><p>
      &copy; Copyright 2016, Manuel Vázquez Acosta. </p>
      <p>Content licensed under the Creative Commons
      attribution-noncommercial-sharealike License.
      </p></footer></div> <!-- footer-container -->

      </div> <!--! end of #container --><!--[if lt IE 7 ]>
          <script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
          <script>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script>
        <![endif]-->
    </body>
</html>