<!DOCTYPE html><!--[if lt IE 7]>      <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="description" content="Blog mostly about software.">
        <meta name="viewport" content="width=device-width">
        <title>Business rules: A case about coding standards/issues &mdash; Manuel on Software - Reloaded</title>
            <link rel="stylesheet" href="../_static/normalize.css" type="text/css">
            <link rel="stylesheet" href="../_static/sphinx.css" type="text/css">
            <link rel="stylesheet" href="../_static/main.css" type="text/css">
            <link rel="stylesheet" href="../_static/mva.css" type="text/css">
            <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
            <link rel="stylesheet" href="../_static/font-awesome.min.css" type="text/css">
        <!-- Load modernizr and JQuery -->
<script src="../_static/vendor/modernizr-2.6.2.min.js"></script>
<script src="../_static/vendor/jquery-1.8.2.min.js"></script>
<script src="../_static/plugins.js"></script>
<script src="../_static/main.js"></script>
<link rel="alternate" type="application/rss+xml" title="RSS" href="../rss.html" /><script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.5',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script><script type="text/javascript" src="../_static/underscore.js"></script><script type="text/javascript" src="../_static/doctools.js"></script>

    <script type="text/javascript">
        $(document).ready(function () {
            // Scroll to content if on small screen
            if (screen.width < 480)
            {
                $(document).scrollTop(document.getElementsByTagName("article")[0].offsetTop - 44);
            }
        });
    </script>
    <!-- link rel='stylesheet' id='open-sans-css'  href='//fonts.googleapis.com/css?family=Open+Sans%3A300italic%2C400italic%2C600italic%2C300%2C400%2C600&#038;subset=latin%2Clatin-ext&#038;ver=4.0-alpha' type='text/css' media='all' / -->
    <!-- link rel='stylesheet' id='syntax-merriweather-css'  href='http://fonts.googleapis.com/css?family=Merriweather%3A400%2C300%2C300italic%2C400italic%2C700%2C700italic&#038;ver=4.0-alpha' type='text/css' media='all' / --></head>
    <body role="document">
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

      <div id="container"><header role="banner">
            <hgroup>
              <h1><a href="../index.html">Manuel on Software - Reloaded</a></h1></hgroup>
          </header>
      <!--    <h1 id="toggle-nav" class="menu-toggle">
      <span class="screen-reader-text">Menu</span></h1>
    <nav role="navigation">
      <ul>
        <li class="main-nav">
          <a href="../index.html">Home</a>
        </li>
        <li class="main-nav">
          <a href="../pages/about-this.html">About this</a>
        </li>
        </ul>
    </nav> --><div class="main-container" role="main"><div class="main wrapper body clearfix"><article><div class="section" id="business-rules-a-case-about-coding-standards-issues">
<h1>Business rules: A case about coding standards/issues</h1>
<p>How do you express a business rule in your code?  Would you recognize it a
separate thing that you may or may not use?  For instance, how would you
encode the following rule:</p>
<blockquote>
<div>Whenever you send a customer an invoice for something you have sold to
him/her, you must create an entry in the &#8220;Sales&#8221; Journal with the following
two items (schematic):</div></blockquote>
<div class="highlight-python"><div class="highlight"><pre>Accounts          | Debits            |   Credits
------------------+-------------------+-------------------
Receivable        | $ XXXX            |
------------------+-------------------+-------------------
         Sales    |                   |  $ XXXX
------------------+-------------------+-------------------
</pre></div>
</div>
<p>The accountant that told you that made several assumptions:</p>
<ol class="loweralpha simple">
<li>There is a single or definite &#8220;Sales&#8221; journal.</li>
<li>There is a single or definite &#8220;Receivable&#8221; account.  Or you&#8217;ll be using an
Auxiliary Ledger to keep trap of Receivables.</li>
<li>There is a single or definite &#8220;Sales&#8221; account.</li>
</ol>
<p>Then she will tell you that:</p>
<blockquote>
<div>Whenever you receive payment for an invoice you must create an entry in the
&#8220;Bank&#8221; journal with the following two items (schematic):</div></blockquote>
<div class="highlight-python"><div class="highlight"><pre>Accounts          | Debits            |   Credits
------------------+-------------------+-------------------
Bank              | $ XXXX            |
------------------+-------------------+-------------------
      Receivable  |                   |  $ XXXX
------------------+-------------------+-------------------
</pre></div>
</div>
<p>She will probably explain that this entry somehow &#8220;cancels&#8221; the previous one,
so that now you know you should not must claim any further payment for those
&#8220;$ XXXX&#8221; you were entitled to collect.</p>
<p>Compare those rules with the following:</p>
<blockquote>
<div>For a single (journal) entry to be valid, the sum of the debits of all its
lines must be equal to the sum the credits.</div></blockquote>
<p>Is this the same kind of rule?  Obviously not.  The first ones state how you
should generate an entry in the face of a business case.  The last one
indicates which entries are valid no matter what they should record.  In fact,
the first two rules must ensure they generate entries that comply with the
later.</p>
<p>Therefore, I won&#8217;t call this last one a <em>rule</em> anymore, it&#8217;s kind of an
accounting law <a class="footnote-reference" href="#double-entry" id="id2">[1]</a>.  Yes, probably the first two rules are
enforced in some countries, but that varies from country to country; the
accounting laws remain the same.</p>
<p>So now we have a method for distinguishing an accounting law from a business
rule.  How do we translate that from thought to code?</p>
<div class="section" id="the-openerp-case">
<h2>The OpenERP case</h2>
<p>Let&#8217;s inspect how does Odoo verifies the accounting law.  Our focus of
attention is the class <span class="docutils literal"><span class="pre">account_move</span></span> (which deals with accounting entries)
in the file <span class="docutils literal"><span class="pre">addons/account/account.py</span></span>.  The method that verifies if one or
several entries are correct is the <span class="docutils literal"><span class="pre">validate()</span></span> method.  The method is quite
long, and, as many things in the OpenERP code base, does more than one thing.
It does the following for each journal entry provided <a class="footnote-reference" href="#many-objs" id="id3">[2]</a>:</p>
<ul>
<li><p class="first">First it sums all the debits and credits,</p>
</li>
<li><p class="first">It Checks that all lines touch accounts of the same company.</p>
</li>
<li><p class="first">It Collects draft lines for further processing.</p>
</li>
<li><p class="first">If both the account of a line and the line itself explicitly state a
currency, it checks that either:</p>
<ol class="loweralpha simple">
<li>they are the same or</li>
<li>the account&#8217;s is the same as the company&#8217;s.</li>
</ol>
<p>In other words: if the line&#8217;s currency is not same as the account, then the
account&#8217;s currency must be equal to the company&#8217;s currency.</p>
</li>
<li><p class="first">The result of the sum all debits minus the sum all credits should be zero
(actually, less than 0.0001).  This is the accounting law I was looking for.</p>
<p>So they collect this entry as a valid one.</p>
</li>
<li><p class="first">If there are any draft lines (collected in the 3rd step), they are marked as
valid <em>bypassing any validation</em>.</p>
<p>Only in this case as well (I don&#8217;t know why yet) for lines in a sales or
purchase journal, <span class="docutils literal"><span class="pre">validate()</span></span> <em>seems</em> to try to apply taxes
<a class="footnote-reference" href="#cuban-taxes" id="id4">[3]</a>.  But I don&#8217;t see how that code would actually be reached.
See the actual code at <a href="#id7"><span class="problematic" id="id8">`github.com`__</span></a></p>
<p>Anyway I think this should not be here.</p>
</li>
<li><p class="first">If the sum of debits minus credits is not (close to) zero, it checks if this
is a &#8220;centralization&#8221; journal.  If it is they mark this entry as valid and
also <em>update</em> the entries by centralizing them...  But I won&#8217;t discuss this.</p>
<p>Again, it seems that <span class="docutils literal"><span class="pre">validate()</span></span> does at lot besides <em>validation</em>.</p>
</li>
<li><p class="first">If the journal is not a centralizing one and the lines do not obey the
accounting law, it rejects it... Finally.  Also, it marks all non-draft
lines as drafts.</p>
</li>
<li><p class="first">But this is not the end. For each entry that is valid after all, it also
calls the <span class="docutils literal"><span class="pre">create_analytic_lines</span></span> for the all the lines of valid entries.</p>
</li>
</ul>
<p>The <span class="docutils literal"><span class="pre">validate()</span></span> method is called when you try to <em>post</em> one or more
entries.  It&#8217;s not called automatically by the ORM when you create an entry.
This is because the entries are allowed to be invalid until they are actually
being recorded as accounting facts (posting them).  Only then they are
required to comply with the accounting laws.</p>
<p>The <span class="docutils literal"><span class="pre">post()</span></span> method creates a unique name for entries that don&#8217;t have it.
But if the journal where they are being posted into has no sequence
associated, it signals an error.</p>
<p><span class="docutils literal"><span class="pre">post()</span></span> is called by the <span class="docutils literal"><span class="pre">button_validate()</span></span> method.  Which, first,
validates that all the accounts in an entry belong to the same chart of
accounts.</p>
<p>So it seems that validations is both spread and tangled.  It&#8217;s hard to
differentiate choices from requirements.  A probable concern is performance.
Tangling is one of its effects shown in the <a href="#id9"><span class="problematic" id="id10">`AOP original paper`_</span></a>.  But even
so, this code shows tangling that is probably too artificial.</p>
<p>For business rules like the ones shown at the beginning of this article, we
have to inspect the <span class="docutils literal"><span class="pre">account_invoice.py</span></span> module of the same addon, and
probably others that modify the <span class="docutils literal"><span class="pre">account.invoice</span></span> object.  But let&#8217;s focus
on the basics.</p>
<p>Creating journal entries from an invoice is done in the
<span class="docutils literal"><span class="pre">action_move_create()</span></span> method.  Again, it&#8217;s an unwieldy pile of code of 172
lines.  Being a mechanical process of creation I expected to see only data
<em>translation</em> from an invoice to a journal entry with lines.  Nevertheless the
code is filled with <strong>validation</strong> checks:</p>
<ul class="simple">
<li>There should be items in the invoice.</li>
<li>If you (the user of Odoo) belong to some groups then it&#8217;ll check the total
sum of the invoice.  This is actually preceded by a comment that states this
feature is disabled (but the code remains).</li>
<li>Payment term calculations are required to match expected amount.</li>
<li>Checks the type of the journal.</li>
</ul>
<p>And, yes, it will <em>also</em> create an entry with the desired schematic in the
invoice&#8217;s journal.</p>
</div>
<div class="section" id="disclaimer">
<h2>Disclaimer</h2>
<p>Despite all its flaws, Odoo remains a good solution for many enterprises.
We&#8217;re using it low and high for everything.</p>
<p>But the source is not friendly because choices are deeply tangled inside the
code.  Methods are ridiculously long.  Which makes them really hard to read,
understand and maintain.</p>
</div>
<div class="section" id="notes">
<h2>Notes</h2>
<table class="docutils footnote" frame="void" id="double-entry" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[1]</a></td><td>See <a class="reference external" href="http://en.wikipedia.org/wiki/Double-entry_bookkeeping">Double-entry bookkeeping</a>.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="many-objs" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[2]</a></td><td>Odoo&#8217;s models are designed to operate on collections of
objects instead of a single object.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="cuban-taxes" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[3]</a></td><td>Here, at Cuba, we don&#8217;t have much experience with taxes.
There are no taxes for the common people: No income tax, no IVA
(VAT)... nothing.  Enterprises do pay some taxes but most people are
unaware of this fact.</td></tr>
</tbody>
</table>
</div>
</div>

    <div class="postmeta">
        
        <div class="categories">
            <span>
                Filed under:
                <a href="../categories/openerp.html">OpenERP</a>, <a href="../categories/odoo.html">Odoo</a></span>
        </div>
        <div class="tags">
            <span>
                Tags:
                <a href="../tags/integration.html">integration</a>, <a href="../tags/programming.html">programming</a></span>
        </div>
        </div>
    
    </article>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'mvaled-io';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the
      <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript><aside class="sidebar"></aside></div> <!-- #main --></div> <!-- #main-container -->

        <div class="footer-container" role="contentinfo"><footer class="wrapper"><p>
      &copy; Copyright 2014, 2015, Manuel Vázquez Acosta. </p>
      <p>Content licensed under the Creative Commons
      attribution-noncommercial-sharealike License.
      </p></footer></div> <!-- footer-container -->

      </div> <!--! end of #container --><!--[if lt IE 7 ]>
          <script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
          <script>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script>
        <![endif]-->
    </body>
</html>